<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Painel Zumba Admin Pro</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Font (Inter) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Ícones (Lucide) -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <!-- Bibliotecas de Exportação (Excel e PDF) -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.28/dist/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Chart.js para Gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* Estilo base */
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        
        .zumba-gradient-text { 
            background: linear-gradient(135deg, #be185d 0%, #ec4899 100%); 
            -webkit-background-clip: text; 
            background-clip: text;
            -webkit-text-fill-color: transparent; 
        }

        /* Botões */
        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 0.5rem 1rem; font-weight: 500; border-radius: 0.375rem; transition: all 0.2s; cursor: pointer; }
        .btn-primary { background-color: #ec4899; color: white; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); } 
        .btn-primary:hover { background-color: #db2777; }
        .btn-secondary { background-color: white; color: #374151; border: 1px solid #d1d5db; } 
        .btn-secondary:hover { background-color: #f9fafb; border-color: #9ca3af; }
        .btn-danger { background-color: #ef4444; color: white; } 
        .btn-danger:hover { background-color: #dc2626; }
        .btn-success { background-color: #10b981; color: white; } 
        .btn-success:hover { background-color: #059669; }
        
        /* Botão WhatsApp */
        .btn-whatsapp { background-color: #25D366; color: white; }
        .btn-whatsapp:hover { background-color: #128C7E; }

        /* Inputs - Melhorados para idosos (letras maiores e uppercase visual) */
        .form-input, .form-select { 
            width: 100%; 
            padding: 0.6rem 0.8rem; /* Mais espaçamento */
            font-size: 1rem; /* Fonte maior base */
            border: 1px solid #d1d5db; 
            border-radius: 0.375rem; 
            background-color: white; 
            transition: border-color 0.15s ease-in-out; 
            text-transform: uppercase; /* Visualmente maiúsculo */
        }
        /* Não aplicar uppercase em email ou campos normais de texto longo se houver */
        input[type="email"], input[type="password"] { text-transform: none; }
        
        .form-input:focus, .form-select:focus { outline: none; border-color: #ec4899; box-shadow: 0 0 0 3px rgba(236, 72, 153, 0.1); }
        .form-input:read-only { background-color: #f3f4f6; cursor: not-allowed; }
        .form-label { display: block; margin-bottom: 0.25rem; font-size: 0.95rem; font-weight: 600; color: #374151; }
        .helper-text { font-size: 0.85rem; color: #6b7280; margin-bottom: 0.5rem; font-style: italic; }

        /* Utils */
        .hidden-section { display: none !important; }
        
        /* Modal */
        #details-modal { position: fixed; inset: 0; z-index: 100; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,0.5); backdrop-filter: blur(2px); opacity: 0; transition: opacity 0.2s ease-in-out; }
        
        /* Nav Tabs */
        .nav-tab { padding: 0.75rem 1rem; font-weight: 500; color: #6b7280; border-bottom: 2px solid transparent; cursor: pointer; transition: all 0.2s; }
        .nav-tab:hover { color: #ec4899; } 
        .nav-tab.active { color: #ec4899; border-bottom-color: #ec4899; }

        /* Acessibilidade */
        .access-card { background-color: #fff1f2; border: 1px solid #fecdd3; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; }
    </style>
</head>
<body class="text-gray-900 bg-gray-50">

    <div class="min-h-screen flex flex-col">

        <!-- ===== SEÇÃO DE LOGIN ===== -->
        <section id="login-view" class="flex-grow flex items-center justify-center p-4 bg-white">
            <div class="w-full max-w-md space-y-8">
                <div class="text-center">
                    <div class="inline-flex items-center justify-center w-20 h-20 rounded-full bg-pink-100 mb-4 shadow-sm">
                        <i data-lucide="music-2" class="w-10 h-10 text-pink-600"></i>
                    </div>
                    <h1 class="text-4xl font-bold zumba-gradient-text tracking-tight">Projeto Zumba</h1>
                    <p class="mt-2 text-gray-500 text-lg">Área Administrativa e Inscrições</p>
                </div>
                
                <div class="bg-white p-8 border border-gray-200 rounded-xl shadow-xl">
                    <form id="admin-login-form" class="space-y-6">
                        <h2 class="text-lg font-semibold text-gray-700 border-b pb-2">Acesso Restrito (Admin)</h2>
                        <div><label for="admin-email" class="form-label">Email</label><input type="email" id="admin-email" class="form-input normal-case" required></div>
                        <div><label for="admin-password" class="form-label">Senha</label><input type="password" id="admin-password" class="form-input normal-case" required></div>
                        <button type="submit" class="w-full btn btn-primary py-3">Entrar no Painel</button>
                    </form>
                    
                    <div class="mt-8">
                        <div class="relative"><div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-300"></div></div><div class="relative flex justify-center text-sm"><span class="px-2 bg-white text-gray-500 font-medium">Área do Participante</span></div></div>
                        <button type="button" id="go-to-register-btn" class="mt-6 w-full btn btn-secondary font-bold text-pink-600 border-pink-200 hover:bg-pink-50 py-3 text-lg shadow-sm">
                            <i data-lucide="user-plus" class="w-5 h-5 mr-2"></i> Preencher Ficha de Inscrição
                        </button>
                    </div>
                    <p id="auth-error" class="mt-2 text-sm text-center text-red-500"></p>
                </div>
            </div>
        </section>

        <!-- ===== SEÇÃO DE CADASTRO (PÚBLICO) ===== -->
        <section id="register-view" class="hidden-section flex-grow bg-gray-50 py-8 px-4">
            <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-xl overflow-hidden border border-gray-100">
                <div class="p-6 bg-white border-b border-gray-100 flex justify-between items-center sticky top-0 z-20 shadow-sm">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800" id="form-title">Ficha de Inscrição</h1>
                        <p class="text-gray-500 text-sm" id="form-subtitle">Preencha com calma e atenção.</p>
                    </div>
                    <button id="back-to-login-btn" class="text-gray-500 hover:text-gray-700 flex items-center gap-1 text-sm font-medium px-3 py-2 bg-gray-100 rounded-lg"><i data-lucide="arrow-left" class="w-4 h-4"></i> Voltar</button>
                </div>

                <div class="bg-blue-50 p-4 border-b border-blue-100">
                    <p class="text-blue-800 text-sm flex items-start gap-2">
                        <i data-lucide="info" class="w-5 h-5 flex-shrink-0 mt-0.5"></i>
                        <span><b>Dica Importante:</b> Não se preocupe com letras maiúsculas ou minúsculas, o sistema padronizará tudo automaticamente ao final. Apenas preencha os dados corretamente.</span>
                    </p>
                </div>

                <form id="register-form" class="p-6 space-y-8">
                    <!-- Campo oculto para ID de edição -->
                    <input type="hidden" id="editing-id" value="">

                    <!-- Identificação -->
                    <div class="space-y-4">
                        <div class="flex items-center gap-2 mb-2">
                            <div class="p-2 bg-pink-100 rounded-lg text-pink-600"><i data-lucide="map-pin" class="w-6 h-6"></i></div>
                            <h3 class="text-xl font-bold text-gray-800">Local e Data</h3>
                        </div>
                        <p class="helper-text">Identifique onde você realiza as aulas.</p>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div id="polo-container">
                                <label for="polo" class="form-label">Qual é o seu Polo? <span class="text-red-500">*</span></label>
                                <input type="text" id="polo" class="form-input" placeholder="Ex: CENTRO, ZONA NORTE..." required>
                            </div>
                            <div>
                                <label for="inscricao" class="form-label">N° Inscrição</label>
                                <input type="text" id="inscricao" class="form-input bg-gray-100 font-bold text-pink-600 border-pink-200" readonly value="Automático">
                            </div>
                            <div><label for="data" class="form-label">Data de Hoje</label><input type="date" id="data" class="form-input bg-gray-100 cursor-not-allowed" required readonly></div>
                        </div>
                    </div>

                    <div class="border-t border-gray-200 my-6"></div>

                    <!-- Dados Pessoais -->
                    <div class="space-y-4">
                         <div class="flex items-center gap-2 mb-2">
                            <div class="p-2 bg-pink-100 rounded-lg text-pink-600"><i data-lucide="user" class="w-6 h-6"></i></div>
                            <h3 class="text-xl font-bold text-gray-800">Seus Dados Pessoais</h3>
                        </div>
                        <p class="helper-text">Informe seus dados como estão no documento de identidade.</p>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                             <div class="md:col-span-2">
                                 <label for="nome" class="form-label">Nome Completo <span class="text-red-500">*</span></label>
                                 <input type="text" id="nome" class="form-input text-lg" placeholder="Digite seu nome completo aqui" required>
                             </div>
                             <div>
                                <label class="form-label">Sexo <span class="text-red-500">*</span></label>
                                <div class="flex gap-4 mt-2 p-3 bg-gray-50 rounded border border-gray-200">
                                    <label class="flex items-center gap-2 cursor-pointer text-lg"><input type="radio" name="sexo" value="Feminino" class="w-5 h-5 text-pink-600 focus:ring-pink-500" required> Feminino</label>
                                    <label class="flex items-center gap-2 cursor-pointer text-lg"><input type="radio" name="sexo" value="Masculino" class="w-5 h-5 text-pink-600 focus:ring-pink-500" required> Masculino</label>
                                </div>
                            </div>
                            <div>
                                <label for="dataNascimento" class="form-label">Data de Nascimento <span class="text-red-500">*</span></label>
                                <input type="date" id="dataNascimento" class="form-input" required>
                            </div>
                            <div>
                                <label for="idade" class="form-label">Sua Idade</label>
                                <input type="number" id="idade" class="form-input bg-gray-100 font-bold" readonly required placeholder="Calculada automaticamente">
                            </div>
                            <div>
                                <label for="telefone" class="form-label">WhatsApp / Telefone <span class="text-red-500">*</span></label>
                                <input type="tel" id="telefone" class="form-input font-bold tracking-wider" placeholder="(99) 99999-9999" maxlength="15" required>
                            </div>
                        </div>

                        <div class="p-4 bg-gray-50 rounded-lg border border-gray-200 mt-4">
                            <h4 class="font-bold text-gray-700 mb-3 border-b pb-2">Endereço Residencial</h4>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div><label for="cep" class="form-label">CEP (Opcional)</label><input type="text" id="cep" class="form-input" placeholder="00000-000" maxlength="9"></div>
                                <div class="md:col-span-2"><label for="endereco" class="form-label">Nome da Rua/Avenida</label><input type="text" id="endereco" class="form-input"></div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-3">
                                <div><label for="numero" class="form-label">Número</label><input type="text" id="numero" class="form-input"></div>
                                <div class="md:col-span-2"><label for="bairro" class="form-label">Bairro</label><input type="text" id="bairro" class="form-input"></div>
                                <div><label for="cidade" class="form-label">Cidade</label><input type="text" id="cidade" class="form-input"></div>
                                <div class="hidden-section"><label for="uf" class="form-label">UF</label><input type="text" id="uf" class="form-input" maxlength="2"></div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div><label for="cpf" class="form-label">CPF <span class="text-red-500">*</span></label><input type="text" id="cpf" class="form-input font-mono" placeholder="000.000.000-00" required maxlength="14"></div>
                            <div><label for="rg" class="form-label">RG</label><input type="text" id="rg" class="form-input" required placeholder="Números do RG"></div>
                            <div><label for="profissao" class="form-label">Profissão</label><input type="text" id="profissao" class="form-input"></div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="form-label">Estado Civil</label>
                                <select id="estadoCivil" class="form-select">
                                    <option value="">Selecione...</option>
                                    <option value="Solteiro(a)">Solteiro(a)</option>
                                    <option value="Casado(a)">Casado(a)</option>
                                    <option value="Divorciado(a)">Divorciado(a)</option>
                                    <option value="Viúvo(a)">Viúvo(a)</option>
                                    <option value="União Estável">União Estável</option>
                                </select>
                            </div>
                             <div><label class="form-label">Mora em casa própria?</label><select id="casaPropria" class="form-select"><option value="Sim">Sim</option><option value="Não">Não</option></select></div>
                             <div><label for="zona" class="form-label">Zona (Eleitoral)</label><input type="text" id="zona" class="form-input"></div>
                        </div>
                    </div>

                    <div class="border-t border-gray-200 my-6"></div>

                    <!-- Medidas -->
                    <div class="space-y-4">
                        <div class="flex items-center gap-2 mb-2">
                            <div class="p-2 bg-pink-100 rounded-lg text-pink-600"><i data-lucide="shirt" class="w-6 h-6"></i></div>
                            <h3 class="text-xl font-bold text-gray-800">Tamanho da Camisa</h3>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                            <div class="flex flex-wrap gap-4 justify-center md:justify-start">
                                <label class="cursor-pointer border-2 border-gray-200 px-4 py-3 rounded-lg hover:bg-pink-50 hover:border-pink-300 has-[:checked]:bg-pink-100 has-[:checked]:border-pink-600 has-[:checked]:text-pink-800 font-bold text-lg transition-all shadow-sm w-16 text-center"><input type="radio" name="camisa" value="PP" class="hidden"> PP</label>
                                <label class="cursor-pointer border-2 border-gray-200 px-4 py-3 rounded-lg hover:bg-pink-50 hover:border-pink-300 has-[:checked]:bg-pink-100 has-[:checked]:border-pink-600 has-[:checked]:text-pink-800 font-bold text-lg transition-all shadow-sm w-16 text-center"><input type="radio" name="camisa" value="P" class="hidden"> P</label>
                                <label class="cursor-pointer border-2 border-gray-200 px-4 py-3 rounded-lg hover:bg-pink-50 hover:border-pink-300 has-[:checked]:bg-pink-100 has-[:checked]:border-pink-600 has-[:checked]:text-pink-800 font-bold text-lg transition-all shadow-sm w-16 text-center"><input type="radio" name="camisa" value="M" class="hidden"> M</label>
                                <label class="cursor-pointer border-2 border-gray-200 px-4 py-3 rounded-lg hover:bg-pink-50 hover:border-pink-300 has-[:checked]:bg-pink-100 has-[:checked]:border-pink-600 has-[:checked]:text-pink-800 font-bold text-lg transition-all shadow-sm w-16 text-center"><input type="radio" name="camisa" value="G" class="hidden"> G</label>
                                <label class="cursor-pointer border-2 border-gray-200 px-4 py-3 rounded-lg hover:bg-pink-50 hover:border-pink-300 has-[:checked]:bg-pink-100 has-[:checked]:border-pink-600 has-[:checked]:text-pink-800 font-bold text-lg transition-all shadow-sm w-16 text-center"><input type="radio" name="camisa" value="GG" class="hidden"> GG</label>
                                <div class="flex items-center gap-2 ml-2">
                                    <label class="cursor-pointer border-2 border-gray-200 px-4 py-3 rounded-lg hover:bg-pink-50 hover:border-pink-300 has-[:checked]:bg-pink-100 has-[:checked]:border-pink-600 has-[:checked]:text-pink-800 font-bold text-lg transition-all shadow-sm"><input type="radio" name="camisa" value="Outro" class="hidden"> Extra</label>
                                    <input type="text" id="camisaOutro" class="form-input py-2 text-lg w-32" placeholder="Qual?">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="border-t border-gray-200 my-6"></div>

                    <!-- Saúde -->
                    <div class="space-y-4">
                        <div class="flex items-center gap-2 mb-2">
                            <div class="p-2 bg-pink-100 rounded-lg text-pink-600"><i data-lucide="activity" class="w-6 h-6"></i></div>
                            <h3 class="text-xl font-bold text-gray-800">Saúde e Bem-estar</h3>
                        </div>
                        <p class="helper-text">Responda com sinceridade para sua segurança durante as atividades.</p>

                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-6 gap-y-4 bg-gray-50 p-5 rounded-xl border border-gray-200">
                            <!-- Perguntas Sim/Não geradas via JS -->
                            <template id="health-question-template">
                                <div class="flex items-center justify-between gap-4 p-3 bg-white rounded-lg border border-gray-200 shadow-sm">
                                    <label class="text-base font-semibold text-gray-700"></label>
                                    <select class="form-select w-28 text-base py-1 font-bold"><option value="Não">Não</option><option value="Sim">Sim</option></select>
                                </div>
                            </template>
                            <div id="health-questions-container" class="contents"></div>
                        </div>

                        <div class="space-y-4 mt-4">
                             <div><label for="tipoSanguineo" class="form-label">Tipo Sanguíneo (Se souber)</label><input type="text" id="tipoSanguineo" class="form-input w-full md:w-1/3" placeholder="Ex: O+, A-..."></div>
                             
                             <div class="p-4 border border-gray-200 rounded-lg bg-yellow-50">
                                <h4 class="font-bold text-gray-800 mb-3">Observações Importantes</h4>
                                <div class="space-y-4">
                                    <div class="flex flex-col md:flex-row gap-2 items-start md:items-center"><label class="w-full md:w-48 font-bold text-gray-700">Tem Alergias?</label><select id="alergias" class="form-select w-24 py-1"><option value="Não">Não</option><option value="Sim">Sim</option></select><input type="text" id="alergiasQual" class="form-input flex-grow" placeholder="Se sim, quais?"></div>
                                    <div class="flex flex-col md:flex-row gap-2 items-start md:items-center"><label class="w-full md:w-48 font-bold text-gray-700">Cirurgia Recente?</label><select id="cirurgiaRecente" class="form-select w-24 py-1"><option value="Não">Não</option><option value="Sim">Sim</option></select><input type="text" id="cirurgiaRecenteQual" class="form-input flex-grow" placeholder="Qual e quando?"></div>
                                    <div class="flex flex-col md:flex-row gap-2 items-start md:items-center"><label class="w-full md:w-48 font-bold text-gray-700">Tratamento Médico?</label><select id="tratamentoMedico" class="form-select w-24 py-1"><option value="Não">Não</option><option value="Sim">Sim</option></select><input type="text" id="tratamentoMedicoQual" class="form-input flex-grow" placeholder="Qual?"></div>
                                    <div class="flex flex-col md:flex-row gap-2 items-start md:items-center"><label class="w-full md:w-48 font-bold text-gray-700">Toma Remédios?</label><select id="tomaMedicamento" class="form-select w-24 py-1"><option value="Não">Não</option><option value="Sim">Sim</option></select><input type="text" id="tomaMedicamentoQual" class="form-input flex-grow" placeholder="Quais medicamentos?"></div>
                                    <div class="flex flex-col md:flex-row gap-2 items-start md:items-center"><label class="w-full md:w-48 font-bold text-gray-700">Problema Ortopédico?</label><select id="problemaOrtopedico" class="form-select w-24 py-1"><option value="Não">Não</option><option value="Sim">Sim</option></select><input type="text" id="problemaOrtopedicoQual" class="form-input flex-grow" placeholder="Joelho, coluna...?"></div>
                                </div>
                             </div>
                        </div>
                    </div>

                    <div class="pt-8">
                        <button type="submit" id="submit-register-btn" class="w-full btn btn-primary py-4 text-xl font-bold shadow-lg transform transition-transform hover:scale-[1.01] rounded-xl">
                            <span id="submit-text">CONFIRMAR MINHA INSCRIÇÃO</span>
                            <span id="submit-loading" class="hidden-section flex items-center gap-2"><i data-lucide="loader-2" class="animate-spin w-6 h-6"></i> Salvando dados...</span>
                        </button>
                        <p id="register-message" class="mt-4 text-center text-lg font-bold"></p>
                    </div>
                </form>
            </div>
        </section>

        <!-- ===== PAINEL DO ADMIN ===== -->
        <section id="admin-panel" class="hidden-section flex-grow flex flex-col bg-gray-100 h-screen overflow-hidden">
            <!-- Overlay para Mobile -->
            <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden transition-opacity"></div>

            <header class="bg-white shadow-sm z-30 sticky top-0 flex-shrink-0">
                <div class="px-4 h-16 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <!-- Botão Hambúrguer Mobile -->
                        <button id="mobile-menu-btn" class="md:hidden p-2 text-gray-600 hover:bg-gray-100 rounded-lg">
                            <i data-lucide="menu" class="w-6 h-6"></i>
                        </button>

                        <div class="w-10 h-10 bg-gradient-to-br from-pink-500 to-purple-600 rounded-lg flex items-center justify-center text-white shadow-md">
                            <i data-lucide="layout-dashboard" class="w-6 h-6"></i>
                        </div>
                        <span class="font-bold text-xl text-gray-800 tracking-tight hidden md:block">Painel Admin</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="hidden md:flex items-center gap-2 px-3 py-2 bg-gray-50 rounded-lg border">
                            <i data-lucide="user" class="w-4 h-4 text-gray-500"></i>
                            <span class="text-sm text-gray-600">Administrador</span>
                        </div>
                        <button id="admin-logout-btn" class="btn btn-secondary text-sm py-2 px-4 flex items-center gap-2 text-red-600 hover:bg-red-50 border-red-100 font-bold">
                            <i data-lucide="log-out" class="w-4 h-4"></i> <span class="hidden md:inline">Sair</span>
                        </button>
                    </div>
                </div>
            </header>

            <div class="flex flex-1 overflow-hidden relative">
                <!-- Sidebar Otimizada Mobile: Fixed + Transform -->
                <aside id="admin-sidebar" class="fixed inset-y-0 left-0 z-40 w-72 bg-white border-r border-gray-200 transform -translate-x-full transition-transform duration-300 md:translate-x-0 md:static md:shrink-0 h-full overflow-y-auto shadow-xl md:shadow-none">
                    <div class="p-4 flex flex-col h-full">
                        <div class="flex justify-between items-center md:hidden mb-4">
                             <span class="font-bold text-xl text-gray-800">Menu</span>
                             <button id="close-sidebar-btn" class="p-2 text-gray-500"><i data-lucide="x" class="w-6 h-6"></i></button>
                        </div>

                        <div class="text-xs font-bold text-gray-500 uppercase mb-2">Visão Geral</div>
                        <nav class="space-y-1">
                            <button class="w-full flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-pink-50 text-gray-700 sidebar-link active bg-pink-100 text-pink-700 font-bold" data-section="tab-dashboard">
                                <i data-lucide="layout-dashboard" class="w-4 h-4"></i> Dashboard
                            </button>
                            <button class="w-full flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-pink-50 text-gray-700 sidebar-link" data-section="tab-charts">
                                <i data-lucide="pie-chart" class="w-4 h-4"></i> Relatórios Gráficos
                            </button>
                        </nav>

                        <div class="mt-6">
                            <div class="text-xs font-bold text-gray-500 uppercase mb-2">Participantes</div>
                            <nav class="space-y-1">
                                <button class="w-full flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-pink-50 text-gray-700 sidebar-link" data-section="tab-participants">
                                    <i data-lucide="users" class="w-4 h-4"></i> Lista Geral
                                </button>
                                <button class="w-full flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-yellow-50 text-gray-700 sidebar-link" data-section="tab-participants-pending">
                                    <i data-lucide="clock" class="w-4 h-4"></i> Pendentes de Aprovação
                                </button>
                                <button class="w-full flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-green-50 text-gray-700 sidebar-link" data-section="tab-participants-approved">
                                    <i data-lucide="check-circle" class="w-4 h-4"></i> Aprovados
                                </button>
                                <button class="w-full flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-red-50 text-gray-700 sidebar-link" data-section="tab-participants-rejected">
                                    <i data-lucide="x-circle" class="w-4 h-4"></i> Rejeitados
                                </button>
                            </nav>
                        </div>

                        <div class="mt-6">
                            <div class="text-xs font-bold text-gray-500 uppercase mb-2">Polos / Locais</div>
                            <nav class="space-y-1">
                                <button class="w-full flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-pink-50 text-gray-700 sidebar-link" data-section="tab-polos-manage">
                                    <i data-lucide="map-pin" class="w-4 h-4"></i> Gerenciar Polos
                                </button>
                            </nav>
                        </div>

                        <div class="mt-6">
                            <div class="text-xs font-bold text-gray-500 uppercase mb-2">Relatórios</div>
                            <nav class="space-y-1">
                                <button class="w-full flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-pink-50 text-gray-700 sidebar-link" data-section="tab-reports">
                                    <i data-lucide="file-text" class="w-4 h-4"></i> Gerador Personalizado
                                </button>
                            </nav>
                        </div>

                        <div class="mt-6">
                            <div class="text-xs font-bold text-gray-500 uppercase mb-2">Comunicação</div>
                            <nav class="space-y-1">
                                <button class="w-full flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-pink-50 text-gray-700 sidebar-link" data-section="tab-comms-whatsapp">
                                    <i data-lucide="message-circle" class="w-4 h-4 text-green-600"></i> Diretório WhatsApp
                                </button>
                            </nav>
                        </div>

                        <div class="mt-6">
                            <div class="text-xs font-bold text-gray-500 uppercase mb-2">Saúde</div>
                            <nav class="space-y-1">
                                <button class="w-full flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-pink-50 text-gray-700 sidebar-link" data-section="tab-health-restrictions">
                                    <i data-lucide="activity" class="w-4 h-4 text-red-600"></i> Alunos com Restrições
                                </button>
                            </nav>
                        </div>

                        <div class="mt-6">
                            <div class="text-xs font-bold text-gray-500 uppercase mb-2">Configurações</div>
                            <nav class="space-y-1">
                                <button class="w-full flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-pink-50 text-gray-700 sidebar-link" data-section="tab-settings">
                                    <i data-lucide="settings" class="w-4 h-4"></i> Dados do Projeto
                                </button>
                            </nav>
                        </div>
                        
                        <!-- Espaço Extra no fim para mobile scroll -->
                        <div class="h-20 md:h-0"></div>
                    </div>
                </aside>

                <main class="flex-1 px-4 md:px-6 py-6 overflow-y-auto w-full">
                    <!-- DASHBOARD -->
                <div id="tab-dashboard" class="admin-tab-content space-y-6">
                    <div id="admin-stats" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"></div>
                    
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <div class="p-5 border-b border-gray-100 bg-yellow-50 flex justify-between items-center">
                            <h2 class="text-lg font-bold text-yellow-800 flex items-center gap-2"><i data-lucide="alert-circle" class="w-5 h-5"></i> Pendentes de Aprovação</h2>
                            <span class="text-xs font-bold bg-yellow-200 text-yellow-900 px-3 py-1 rounded-full" id="pending-count-badge">0</span>
                        </div>
                        <div class="p-4 md:p-5">
                            <div id="pending-registrations-list" class="grid grid-cols-1 gap-3"></div>
                            <div id="no-pending-message" class="text-center py-12 text-gray-400 hidden-section">
                                <i data-lucide="check-circle-2" class="w-16 h-16 mx-auto mb-4 text-green-100"></i>
                                <p class="text-lg font-medium text-green-600">Tudo em dia!</p>
                                <p>Nenhuma inscrição pendente no momento.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- GRÁFICOS (NOVA ABA) -->
                <div id="tab-charts" class="admin-tab-content hidden-section space-y-6">
                    <div class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm mb-4">
                        <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                            <i data-lucide="pie-chart" class="w-6 h-6 text-pink-600"></i> Relatórios Gráficos
                        </h2>
                        <p class="text-gray-500 text-sm">Visualização visual dos dados do projeto.</p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Polo Chart -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5">
                            <h3 class="font-bold text-gray-700 mb-4 flex items-center gap-2"><i data-lucide="map-pin" class="w-4 h-4 text-pink-600"></i> Distribuição por Polo</h3>
                            <div class="h-64 relative">
                                <canvas id="chart-polos"></canvas>
                            </div>
                        </div>
                        
                        <!-- Bairro Chart -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5">
                            <h3 class="font-bold text-gray-700 mb-4 flex items-center gap-2"><i data-lucide="home" class="w-4 h-4 text-blue-600"></i> Top 10 Bairros</h3>
                            <div class="h-64 relative">
                                <canvas id="chart-bairros"></canvas>
                            </div>
                        </div>
                        
                        <!-- Idade Chart -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5">
                            <h3 class="font-bold text-gray-700 mb-4 flex items-center gap-2"><i data-lucide="user" class="w-4 h-4 text-green-600"></i> Faixa Etária</h3>
                            <div class="h-64 relative">
                                <canvas id="chart-idade"></canvas>
                            </div>
                        </div>
                        
                        <!-- Doenças Chart -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5">
                            <h3 class="font-bold text-gray-700 mb-4 flex items-center gap-2"><i data-lucide="activity" class="w-4 h-4 text-red-600"></i> Saúde e Condições</h3>
                            <div class="h-64 relative">
                                <canvas id="chart-saude"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- PARTICIPANTES -->
                <div id="tab-participants" class="admin-tab-content hidden-section bg-white rounded-xl shadow-sm border border-gray-200 flex flex-col h-[calc(100vh-8rem)] md:h-[calc(100vh-10rem)]">
                    <div class="p-5 border-b border-gray-200 flex flex-col md:flex-row gap-4 justify-between items-center bg-gray-50">
                        <h2 class="text-lg font-bold text-gray-700">Base de Dados Completa</h2>
                        <div class="flex flex-col md:flex-row gap-3 w-full md:w-auto">
                            <div class="relative w-full md:w-72">
                                <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"></i>
                                <input id="admin-search" type="text" class="form-input pl-10 text-sm py-2" placeholder="Buscar por Nome, CPF ou Polo...">
                            </div>
                            <select id="admin-sort" class="form-select w-full md:w-auto text-sm py-2">
                                <option value="date_desc">Mais Recentes</option>
                                <option value="name_asc">Nome (A-Z)</option>
                                <option value="polo_asc">Agrupar por Polo</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex-grow overflow-x-auto">
                        <div class="inline-block min-w-full align-middle">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-100 sticky top-0 z-10 shadow-sm">
                                    <tr>
                                        <th scope="col" class="px-4 md:px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Insc. / Nome</th>
                                        <th scope="col" class="px-4 md:px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Polo</th>
                                        <th scope="col" class="px-4 md:px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Contato / CPF</th>
                                        <th scope="col" class="px-4 md:px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Camisa</th>
                                        <th scope="col" class="px-4 md:px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Status</th>
                                        <th scope="col" class="relative px-6 py-3"><span class="sr-only">Ações</span></th>
                                    </tr>
                                </thead>
                                <tbody id="all-participants-table-body" class="bg-white divide-y divide-gray-200 text-sm"></tbody>
                            </table>
                        </div>
                        <div id="no-participants-message" class="text-center py-20 text-gray-400 hidden-section">
                            <p>Nenhum registro encontrado com esse filtro.</p>
                        </div>
                    </div>
                    <div class="p-3 border-t border-gray-200 bg-gray-50 text-xs text-gray-500 text-right font-medium" id="table-footer-count">Carregando dados...</div>
                </div>

                <!-- PARTICIPANTES: PENDENTES -->
                <div id="tab-participants-pending" class="admin-tab-content hidden-section space-y-6">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <div class="p-5 border-b border-gray-100 bg-yellow-50 flex justify-between items-center">
                            <h2 class="text-lg font-bold text-yellow-800 flex items-center gap-2"><i data-lucide="clock" class="w-5 h-5"></i> Pendentes de Aprovação</h2>
                            <span class="text-xs font-bold bg-yellow-200 text-yellow-900 px-3 py-1 rounded-full" id="pending-page-count">0</span>
                        </div>
                        <div class="p-5">
                            <div id="pending-page-list" class="grid grid-cols-1 gap-3"></div>
                            <div id="pending-page-empty" class="text-center py-12 text-gray-400 hidden-section">
                                <i data-lucide="check-circle-2" class="w-16 h-16 mx-auto mb-4 text-green-100"></i>
                                <p class="text-lg font-medium text-green-600">Nenhum pendente.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- PARTICIPANTES: APROVADOS -->
                <div id="tab-participants-approved" class="admin-tab-content hidden-section space-y-6">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <div class="p-5 border-b border-gray-100 bg-green-50 flex items-center justify-between">
                            <h2 class="text-lg font-bold text-green-800 flex items-center gap-2"><i data-lucide="check-circle" class="w-5 h-5"></i> Aprovados</h2>
                        </div>
                        <div class="p-0 md:p-5 overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-100 sticky top-0 z-10 shadow-sm">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase">Insc. / Nome</th>
                                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase">Polo</th>
                                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase">Contato</th>
                                    </tr>
                                </thead>
                                <tbody id="approved-table-body" class="bg-white divide-y divide-gray-200 text-sm"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- PARTICIPANTES: REJEITADOS -->
                <div id="tab-participants-rejected" class="admin-tab-content hidden-section space-y-6">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <div class="p-5 border-b border-gray-100 bg-red-50 flex items-center justify-between">
                            <h2 class="text-lg font-bold text-red-800 flex items-center gap-2"><i data-lucide="x-circle" class="w-5 h-5"></i> Rejeitados</h2>
                        </div>
                        <div class="p-0 md:p-5 overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-100 sticky top-0 z-10 shadow-sm">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase">Insc. / Nome</th>
                                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase">Polo</th>
                                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase">Contato</th>
                                    </tr>
                                </thead>
                                <tbody id="rejected-table-body" class="bg-white divide-y divide-gray-200 text-sm"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- COMUNICAÇÃO: DIRETÓRIO WHATSAPP -->
                <div id="tab-comms-whatsapp" class="admin-tab-content hidden-section space-y-6">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <div class="p-5 border-b border-gray-100 bg-green-50 flex flex-col md:flex-row justify-between items-center gap-4">
                            <h2 class="text-lg font-bold text-green-800 flex items-center gap-2"><i data-lucide="message-circle" class="w-5 h-5"></i> Diretório WhatsApp</h2>
                            <div class="relative w-full md:w-64">
                                <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"></i>
                                <input id="whatsapp-search" type="text" class="form-input pl-10 text-sm py-2 bg-white" placeholder="Buscar para enviar msg...">
                            </div>
                        </div>
                        <div class="p-0 md:p-5 overflow-x-auto h-[600px]">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-100 sticky top-0 z-10">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase">Nome</th>
                                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase">Polo</th>
                                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase">Telefone</th>
                                        <th class="px-4 py-3 text-center text-xs font-bold text-gray-500 uppercase">Ação</th>
                                    </tr>
                                </thead>
                                <tbody id="whatsapp-list-body" class="bg-white divide-y divide-gray-200 text-sm"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- SAÚDE: ALUNOS COM RESTRIÇÕES -->
                <div id="tab-health-restrictions" class="admin-tab-content hidden-section space-y-6">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <div class="p-5 border-b border-gray-100 bg-red-50 flex justify-between items-center">
                            <h2 class="text-lg font-bold text-red-800 flex items-center gap-2"><i data-lucide="alert-octagon" class="w-5 h-5"></i> Alunos com Restrições</h2>
                            <span class="text-xs font-bold bg-red-200 text-red-900 px-3 py-1 rounded-full" id="health-risk-count">0</span>
                        </div>
                        <div class="p-4 md:p-5">
                            <div id="health-risk-list" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4"></div>
                            <div id="no-health-risks" class="text-center py-12 text-gray-400 hidden-section">
                                <i data-lucide="heart-pulse" class="w-16 h-16 mx-auto mb-4 text-red-100"></i>
                                <p class="text-lg font-medium text-gray-600">Nenhum risco identificado.</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="tab-reports" class="admin-tab-content hidden-section space-y-6">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 md:p-6">
                        <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                            <div class="p-2 bg-blue-100 text-blue-600 rounded-lg"><i data-lucide="filter" class="w-5 h-5"></i></div> 
                            Gerador de Relatórios
                        </h2>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-5 mb-6">
                            <div><label class="form-label text-sm">Status</label><select id="report-status-filter" class="form-select text-sm"><option value="approved">Aprovados</option><option value="all">Todos</option><option value="pending">Pendentes</option></select></div>
                            <div><label class="form-label text-sm">Filtrar por Polo</label><select id="report-polo-filter" class="form-select text-sm bg-blue-50 border-blue-200"><option value="all">Todos os Polos</option><!-- JS Preenche --></select></div>
                            <div><label class="form-label text-sm">Tamanho Camisa</label><select id="report-camisa-filter" class="form-select text-sm"><option value="all">Todos</option><option value="P">P</option><option value="M">M</option><option value="G">G</option><option value="GG">GG</option></select></div>
                            <div><label class="form-label text-sm">Sexo</label><select id="report-sexo-filter" class="form-select text-sm"><option value="all">Todos</option><option value="Feminino">Feminino</option><option value="Masculino">Masculino</option></select></div>
                            <div><label class="form-label text-sm">Cidade</label><input type="text" id="report-city-filter" class="form-input text-sm" placeholder="Ex: SÃO LUÍS"></div>
                            <div><label class="form-label text-sm">Idade Mínima</label><input type="number" id="report-age-min" class="form-input text-sm"></div>
                            <div><label class="form-label text-sm">Idade Máxima</label><input type="number" id="report-age-max" class="form-input text-sm"></div>
                            <div><label class="form-label text-sm">Nascido após</label><input type="date" id="report-dob-min" class="form-input text-sm"></div>
                        </div>

                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 mb-6">
                            <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wide mb-3">Selecione as colunas para o relatório</h3>
                            <div id="report-fields" class="flex flex-wrap gap-4 text-sm">
                                <label class="flex items-center gap-2 cursor-pointer bg-white px-3 py-1 rounded border shadow-sm"><input type="checkbox" value="nome" checked class="text-pink-600 rounded"> Nome</label>
                                <label class="flex items-center gap-2 cursor-pointer bg-white px-3 py-1 rounded border shadow-sm"><input type="checkbox" value="polo" checked class="text-pink-600 rounded font-bold"> Polo</label>
                                <label class="flex items-center gap-2 cursor-pointer bg-white px-3 py-1 rounded border shadow-sm"><input type="checkbox" value="camisa" checked class="text-pink-600 rounded"> Camisa</label>
                                <label class="flex items-center gap-2 cursor-pointer bg-white px-3 py-1 rounded border shadow-sm"><input type="checkbox" value="telefone" checked class="text-pink-600 rounded"> Telefone</label>
                                <label class="flex items-center gap-2 cursor-pointer bg-white px-3 py-1 rounded border shadow-sm"><input type="checkbox" value="idade" checked class="text-pink-600 rounded"> Idade</label>
                                <label class="flex items-center gap-2 cursor-pointer bg-white px-3 py-1 rounded border shadow-sm"><input type="checkbox" value="dataNascimento" checked class="text-pink-600 rounded"> Data Nasc.</label>
                                <label class="flex items-center gap-2 cursor-pointer bg-white px-3 py-1 rounded border shadow-sm"><input type="checkbox" value="bairro" checked class="text-pink-600 rounded"> Bairro</label>
                                <label class="flex items-center gap-2 cursor-pointer bg-white px-3 py-1 rounded border shadow-sm"><input type="checkbox" value="status" class="text-pink-600 rounded"> Status</label>
                                <label class="flex items-center gap-2 cursor-pointer bg-white px-3 py-1 rounded border shadow-sm"><input type="checkbox" value="cpf" class="text-pink-600 rounded"> CPF</label>
                                <label class="flex items-center gap-2 cursor-pointer bg-white px-3 py-1 rounded border shadow-sm"><input type="checkbox" value="inscricao" class="text-pink-600 rounded"> N° Insc.</label>
                                <label class="flex items-center gap-2 cursor-pointer bg-white px-3 py-1 rounded border shadow-sm"><input type="checkbox" value="zona" class="text-pink-600 rounded"> Zona Eleitoral</label>
                                <label class="flex items-center gap-2 cursor-pointer bg-white px-3 py-1 rounded border shadow-sm"><input type="checkbox" value="hipertenso" class="text-pink-600 rounded"> Hipertenso</label>
                                <label class="flex items-center gap-2 cursor-pointer bg-white px-3 py-1 rounded border shadow-sm"><input type="checkbox" value="diabetico" class="text-pink-600 rounded"> Diabético</label>
                            </div>
                        </div>

                        <div class="flex flex-col md:flex-row gap-3">
                            <button id="generate-report-btn" class="btn btn-primary shadow-md w-full md:w-auto"><i data-lucide="search" class="w-4 h-4 mr-2"></i> Gerar Relatório na Tela</button>
                            <button id="clear-filters-btn" class="btn btn-secondary w-full md:w-auto">Limpar Filtros</button>
                        </div>
                    </div>

                    <div id="report-results-container" class="hidden-section bg-white rounded-xl shadow-sm border border-gray-200 p-4 md:p-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 bg-blue-50 p-4 rounded-lg border border-blue-100">
                            <div class="text-center border-b md:border-b-0 md:border-r border-blue-200 last:border-0 p-2">
                                <span class="block text-sm text-blue-600 font-bold uppercase">Total Encontrado</span>
                                <span class="text-4xl font-bold text-gray-800" id="summary-total">0</span>
                            </div>
                            <div class="col-span-2 text-sm md:pl-4 flex flex-col justify-center">
                                <p class="font-bold text-blue-800 mb-2">Resumo de Camisas (Deste filtro):</p>
                                <div id="summary-camisas" class="flex flex-wrap gap-2"></div>
                            </div>
                        </div>

                        <div class="overflow-x-auto border rounded-lg mb-4 max-h-[500px]">
                            <table class="min-w-full divide-y divide-gray-200" id="report-table">
                                <thead class="bg-gray-100 sticky top-0" id="report-table-head"></thead>
                                <tbody class="bg-white divide-y divide-gray-200 text-xs" id="report-table-body"></tbody>
                            </table>
                        </div>

                        <div class="flex flex-col md:flex-row justify-end gap-2 border-t pt-4">
                            <span class="text-sm text-gray-500 self-center md:mr-2 text-center md:text-left mb-2 md:mb-0">Exportar dados:</span>
                            <div class="flex gap-2 justify-center">
                                <button id="export-csv-btn-2" class="btn btn-secondary text-sm gap-2 hover:text-green-600"><i data-lucide="file-spreadsheet" class="w-4 h-4"></i> Excel (CSV)</button>
                                <button id="export-xlsx-btn-2" class="btn btn-secondary text-sm gap-2 hover:text-green-600"><i data-lucide="sheet" class="w-4 h-4"></i> Excel (XLSX)</button>
                                <button id="export-pdf-btn-2" class="btn btn-secondary text-sm gap-2 hover:text-red-600"><i data-lucide="file-text" class="w-4 h-4"></i> PDF (Lista)</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- POLOS -->
                <div id="tab-polos-manage" class="admin-tab-content hidden-section space-y-6">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <h2 class="text-xl font-bold text-gray-800 mb-2 flex items-center gap-2"><i data-lucide="map-pin" class="w-5 h-5"></i> Gerenciar Polos</h2>
                        <p class="text-sm text-gray-600 mb-4">Adicione, edite e remova polos. Relacionado às configurações.</p>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                            <input class="form-input" placeholder="Nome do Polo">
                            <button class="btn btn-primary">Salvar</button>
                            <button class="btn btn-secondary">Limpar</button>
                        </div>
                        <div class="mt-6 border rounded-lg overflow-hidden">
                            <div class="p-4 bg-gray-50 border-b font-bold text-gray-700">Polos Cadastrados</div>
                            <div class="p-4 text-sm text-gray-500">Integração futura com Firestore.</div>
                        </div>
                    </div>
                </div>

                <!-- CONFIGURAÇÕES -->
                <div id="tab-settings" class="admin-tab-content hidden-section">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 max-w-2xl mx-auto">
                        <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2"><i data-lucide="settings" class="w-5 h-5 text-gray-500"></i> Configurações do Sistema</h2>
                        <div class="space-y-6">
                            <div class="bg-gray-50 p-5 rounded-lg border border-gray-100">
                                <label class="block text-sm font-bold text-gray-700 mb-2">Lista de Polos Oficiais</label>
                                <p class="text-xs text-gray-500 mb-3">Digite os nomes dos polos separados por vírgula.</p>
                                <textarea id="settings-polos" class="form-input w-full h-32 font-mono text-sm" placeholder="CENTRO, ZONA NORTE, ZONA SUL, COHATRAC..."></textarea>
                                <div class="mt-3 flex justify-end">
                                    <button id="save-settings-btn" class="btn btn-primary text-sm">Salvar Lista de Polos</button>
                                </div>
                            </div>
                            
                            <div class="bg-red-50 p-5 rounded-lg border border-red-100">
                                <label class="block text-sm font-bold text-red-800 mb-2"><i data-lucide="alert-triangle" class="w-4 h-4 inline mr-1"></i> Zona de Manutenção</label>
                                <p class="text-xs text-red-700 mb-3">Use isto apenas se a numeração das inscrições estiver bagunçada. Isso irá renumerar todos os cadastros sequencialmente baseados na data de criação.</p>
                                <button id="renumber-all-btn" class="btn btn-danger text-sm w-full md:w-auto"><span id="renumber-text">Renumerar Automaticamente</span><span id="renumber-loading" class="hidden-section">Processando...</span></button>
                                <p id="renumber-status" class="mt-2 text-xs font-bold text-center"></p>
                            </div>
                        </div>
                    </div>
                </div>

                </main>
            </div>
        </section>

        <!-- ===== MODAL DE EDIÇÃO AVANÇADA ===== -->
        <div id="details-modal" class="p-0 md:p-4">
            <div class="bg-white rounded-none md:rounded-xl shadow-2xl w-full max-w-4xl h-full md:h-auto md:max-h-[90vh] flex flex-col overflow-hidden">
                <div class="p-4 border-b flex justify-between items-center bg-gray-50 shrink-0">
                    <div>
                        <h3 class="font-bold text-xl text-gray-800">Editar Ficha</h3>
                        <p class="text-xs text-gray-500">Alterações salvas automaticamente.</p>
                    </div>
                    <button id="close-modal-btn" class="p-2 hover:bg-gray-200 rounded-full transition-colors"><i data-lucide="x" class="w-6 h-6 text-gray-500"></i></button>
                </div>
                
                <div class="p-6 overflow-y-auto flex-grow bg-white">
                    <form id="edit-form" class="space-y-6">
                        <input type="hidden" id="edit-doc-id">
                        
                        <!-- Barra de Status e Ações Rápidas -->
                        <div class="flex flex-col md:flex-row gap-4 p-4 bg-gray-50 rounded-lg border border-gray-200 items-end">
                            <div class="w-full md:w-1/3">
                                <label class="text-xs font-bold text-gray-500 uppercase">Status</label>
                                <select id="edit-status" class="form-select mt-1 font-bold">
                                    <option value="pending" class="text-yellow-600">PENDENTE</option>
                                    <option value="approved" class="text-green-600">APROVADO</option>
                                    <option value="rejected" class="text-red-600">REJEITADO</option>
                                </select>
                            </div>
                            <div class="w-full md:w-1/3">
                                <label class="text-xs font-bold text-gray-500 uppercase">Nº Inscrição</label>
                                <input type="text" id="edit-inscricao" class="form-input mt-1 bg-gray-100" readonly>
                            </div>
                            <div class="w-full md:w-1/3">
                                <label class="text-xs font-bold text-gray-500 uppercase">Cadastro</label>
                                <input type="text" id="edit-createdAtDisplay" class="form-input mt-1 bg-gray-100" readonly>
                            </div>
                        </div>

                        <!-- Grid de Edição Completa -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Coluna 1 -->
                            <div class="space-y-4">
                                <h4 class="font-bold text-pink-600 border-b pb-1">Dados Pessoais</h4>
                                <div><label class="form-label text-sm">Nome Completo</label><input type="text" id="edit-nome" class="form-input"></div>
                                <div><label class="form-label text-sm">CPF</label><input type="text" id="edit-cpf" class="form-input"></div>
                                <div><label class="form-label text-sm">RG</label><input type="text" id="edit-rg" class="form-input"></div>
                                <div class="grid grid-cols-2 gap-2">
                                    <div><label class="form-label text-sm">Data Nasc.</label><input type="date" id="edit-dataNascimento" class="form-input"></div>
                                    <div><label class="form-label text-sm">Idade</label><input type="number" id="edit-idade" class="form-input bg-gray-100"></div>
                                </div>
                                <div class="grid grid-cols-2 gap-2">
                                    <div><label class="form-label text-sm">Sexo</label><select id="edit-sexo" class="form-select"><option value="Feminino">Feminino</option><option value="Masculino">Masculino</option></select></div>
                                    <div><label class="form-label text-sm">Camisa</label><input type="text" id="edit-camisa" class="form-input"></div>
                                </div>
                                <div><label class="form-label text-sm">Telefone/Zap</label><input type="text" id="edit-telefone" class="form-input"></div>
                            </div>

                            <!-- Coluna 2 -->
                            <div class="space-y-4">
                                <h4 class="font-bold text-pink-600 border-b pb-1">Endereço e Polo</h4>
                                <div><label class="form-label text-sm">Polo</label><input type="text" id="edit-polo" class="form-input font-bold text-blue-800"></div>
                                <div><label class="form-label text-sm">CEP</label><input type="text" id="edit-cep" class="form-input"></div>
                                <div><label class="form-label text-sm">Logradouro</label><input type="text" id="edit-endereco" class="form-input"></div>
                                <div class="grid grid-cols-2 gap-2">
                                    <div><label class="form-label text-sm">Bairro</label><input type="text" id="edit-bairro" class="form-input"></div>
                                    <div><label class="form-label text-sm">Número</label><input type="text" id="edit-numero" class="form-input"></div>
                                </div>
                                <div><label class="form-label text-sm">Cidade</label><input type="text" id="edit-cidade" class="form-input"></div>
                            </div>
                        </div>

                        <!-- Dados Extras -->
                        <div class="bg-gray-50 p-4 rounded border border-gray-200 space-y-3">
                            <h4 class="font-bold text-gray-600 text-sm uppercase">Dados Complementares & Saúde</h4>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                                <div><label class="text-xs text-gray-500 block">Profissão</label><input type="text" id="edit-profissao" class="form-input text-sm py-1"></div>
                                <div><label class="text-xs text-gray-500 block">Estado Civil</label><input type="text" id="edit-estadoCivil" class="form-input text-sm py-1"></div>
                                <div><label class="text-xs text-gray-500 block">Zona Eleitoral</label><input type="text" id="edit-zona" class="form-input text-sm py-1"></div>
                                <div><label class="text-xs text-gray-500 block">Tipo Sanguíneo</label><input type="text" id="edit-tipoSanguineo" class="form-input text-sm py-1"></div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-2">
                                <div><label class="text-xs text-gray-500 block">Problemas de Saúde (Resumo)</label><textarea id="edit-obs-saude" class="form-input text-sm" rows="3" placeholder="Alergias, Cirurgias, etc..."></textarea></div>
                                <div class="flex flex-col justify-end">
                                    <div class="flex gap-4 text-xs font-bold text-gray-600 border p-2 bg-white rounded flex-wrap">
                                        <label><input type="checkbox" id="edit-check-hipertenso"> Hipertenso</label>
                                        <label><input type="checkbox" id="edit-check-diabetico"> Diabético</label>
                                        <label><input type="checkbox" id="edit-check-cardiaco"> Cardíaco</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>

                <div class="p-4 border-t bg-gray-50 flex flex-col md:flex-row justify-between items-center gap-3 shrink-0">
                    <button id="modal-delete-btn" class="btn btn-danger text-sm flex gap-2 w-full md:w-auto"><i data-lucide="trash-2" class="w-4 h-4"></i> Excluir</button>
                    <div class="flex gap-3 w-full md:w-auto">
                        <button onclick="document.getElementById('close-modal-btn').click()" class="btn btn-secondary text-sm flex-1 md:flex-none">Cancelar</button>
                        <button id="modal-save-btn" class="btn btn-success text-sm px-6 py-2 shadow-sm font-bold flex gap-2 flex-1 md:flex-none justify-center"><i data-lucide="save" class="w-4 h-4"></i> SALVAR</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signInAnonymously, signOut, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, getDoc, updateDoc, deleteDoc, onSnapshot, setDoc, getCountFromServer, getDocs, query, orderBy, limit, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ===========================================
        // CONFIGURAÇÃO DO FIREBASE
        // ===========================================
        const firebaseConfig = {
          apiKey: "AIzaSyCrH_LFHenyWx-ITRCTWeNVqf8O-0e3pJY",
          authDomain: "zumba-2a827.firebaseapp.com",
          projectId: "zumba-2a827",
          storageBucket: "zumba-2a827.firebasestorage.app",
          messagingSenderId: "325248310095",
          appId: "1:325248310095:web:2673845967b7bc60f6833a"
        };
        const ADMIN_UID = "mNenvFEpf1SnDCY2kXLUaDlgtP03"; 
        const INSCRICOES_COLLECTION = "inscricoes_zumba";
        const SETTINGS_COLLECTION = "config_zumba";

        // Inicialização
        var app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (error) { console.error("Firebase Error:", error); }

        const views = {
            login: document.getElementById('login-view'),
            register: document.getElementById('register-view'),
            admin: document.getElementById('admin-panel')
        };
        
        // ===========================================
        // LÓGICA DE UTILITÁRIOS (TEXTO)
        // ===========================================
        // Normaliza texto: remove acentos, espaços duplos e poe em maiusculo (Ex: "São   Luís " -> "SAO LUIS")
        const normalizeText = (text) => {
            if(!text) return "";
            return text.toString()
                .normalize("NFD")
                .replace(/[\u0300-\u036f]/g, "") // Remove acentos
                .toUpperCase()
                .replace(/\s+/g, ' ') // Substitui múltiplos espaços por um só
                .trim();
        };

        const maskCPF = (v) => {
            v = v.replace(/\D/g, "").slice(0, 11);
            return v.replace(/(\d{3})(\d)/, "$1.$2")
                    .replace(/(\d{3})(\d)/, "$1.$2")
                    .replace(/(\d{3})(\d{1,2})$/, "$1-$2");
        };
        const maskPhone = (v) => {
             v = v.replace(/\D/g, "").slice(0, 11);
             if (v.length > 10) return v.replace(/^(\d\d)(\d{5})(\d{4}).*/, "($1) $2-$3");
             return v.replace(/^(\d\d)(\d{4})(\d{0,4}).*/, "($1) $2-$3");
        };
        const maskCEP = (v) => {
            v = v.replace(/\D/g, "").slice(0, 8);
            return v.replace(/^(\d{5})(\d)/, "$1-$2");
        };

        // ===========================================
        // CONTROLE DO MENU MOBILE
        // ===========================================
        const sidebar = document.getElementById('admin-sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const closeSidebarBtn = document.getElementById('close-sidebar-btn');

        function toggleSidebar() {
            // Verifica se está fechado (tem -translate-x-full)
            const isClosed = sidebar.classList.contains('-translate-x-full');
            
            if (isClosed) {
                // Abrir
                sidebar.classList.remove('-translate-x-full');
                sidebarOverlay.classList.remove('hidden');
            } else {
                // Fechar
                sidebar.classList.add('-translate-x-full');
                sidebarOverlay.classList.add('hidden');
            }
        }

        // Eventos do Menu
        if(mobileMenuBtn) mobileMenuBtn.addEventListener('click', toggleSidebar);
        if(closeSidebarBtn) closeSidebarBtn.addEventListener('click', toggleSidebar);
        if(sidebarOverlay) sidebarOverlay.addEventListener('click', toggleSidebar);

        // ===========================================
        // NAVEGAÇÃO E AUTENTICAÇÃO
        // ===========================================
        const adminTabs = document.querySelectorAll('.nav-tab');
        const adminTabContents = document.querySelectorAll('.admin-tab-content');
        
        adminTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                adminTabs.forEach(t => t.classList.remove('active'));
                adminTabContents.forEach(c => c.classList.add('hidden-section'));
                tab.classList.add('active');
                document.getElementById(`tab-${tab.dataset.tab}`).classList.remove('hidden-section');
            });
        });

        // Navegação Sidebar
        const sidebarLinks = document.querySelectorAll('.sidebar-link');
        const showSection = (id) => {
            document.querySelectorAll('.admin-tab-content').forEach(c => c.classList.add('hidden-section'));
            const el = document.getElementById(id);
            if (el) el.classList.remove('hidden-section');
            if(window.lucide) lucide.createIcons();
            
            // Fecha sidebar no mobile ao clicar
            if (window.innerWidth < 768) {
                toggleSidebar();
            }
        };
        sidebarLinks.forEach(btn => {
            btn.addEventListener('click', () => {
                sidebarLinks.forEach(b => b.classList.remove('bg-pink-100'));
                btn.classList.add('bg-pink-100');
                const id = btn.dataset.section;
                showSection(id);
                if(id === 'tab-dashboard') renderDashboard();
                else if(id === 'tab-charts') renderCharts();
                else if(id === 'tab-participants') renderTable();
                else if(id === 'tab-participants-pending') renderPendingPage();
                else if(id === 'tab-participants-approved') renderStatusTable('approved');
                else if(id === 'tab-participants-rejected') renderStatusTable('rejected');
                else if(id === 'tab-health-restrictions') renderHealthRisks();
                else if(id === 'tab-comms-whatsapp') renderWhatsappDirectory();
            });
        });

        document.getElementById('whatsapp-search').addEventListener('input', renderWhatsappDirectory);

        const showView = async (viewName) => {
            Object.values(views).forEach(el => el.classList.add('hidden-section'));
            views[viewName].classList.remove('hidden-section');
            window.scrollTo(0, 0);
            
            if(viewName === 'register') {
                if (!auth.currentUser) {
                    try {
                        await signInAnonymously(auth);
                    } catch(e) { console.warn("Erro no login anônimo:", e); }
                }
                initRegisterForm();
            }
            if(window.lucide) lucide.createIcons();
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                if (user.uid === ADMIN_UID) {
                    showView('admin');
                    initAdminPanel();
                } else if (!user.isAnonymous) {
                    signOut(auth);
                    showView('login');
                } else {
                    // É usuário anonimo, se não tiver na tela de registro, manda pro login
                    if(document.getElementById('register-view').classList.contains('hidden-section')) showView('login');
                }
            } else {
                 showView('login');
            }
        });

        document.getElementById('admin-login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('admin-email').value;
            const pass = document.getElementById('admin-password').value;
            try {
                await setPersistence(auth, browserLocalPersistence);
                await signInWithEmailAndPassword(auth, email, pass);
            } catch (e) {
                document.getElementById('auth-error').textContent = 'Email ou senha incorretos.';
            }
        });

        document.getElementById('admin-logout-btn').addEventListener('click', () => {
            signOut(auth).then(() => window.location.reload());
        });

        document.getElementById('go-to-register-btn').addEventListener('click', () => showView('register'));
        document.getElementById('back-to-login-btn').addEventListener('click', () => {
             if(auth.currentUser?.isAnonymous) signOut(auth);
             showView('login');
        });

        // ===========================================
        // CEP & ENDEREÇO
        // ===========================================
        async function fetchAddress(cep) {
            try {
                const res = await fetch(`https://viacep.com.br/ws/${cep.replace(/\D/g, '')}/json/`);
                const data = await res.json();
                if (!data.erro) {
                    if(document.getElementById('endereco')) document.getElementById('endereco').value = data.logradouro.toUpperCase();
                    if(document.getElementById('bairro')) document.getElementById('bairro').value = data.bairro.toUpperCase();
                    if(document.getElementById('cidade')) document.getElementById('cidade').value = data.localidade.toUpperCase();
                    if(document.getElementById('uf')) document.getElementById('uf').value = data.uf.toUpperCase();
                }
            } catch(e) {}
        }

        // ===========================================
        // LÓGICA DE CADASTRO (CLIENTE)
        // ===========================================
        async function initRegisterForm() {
            document.getElementById('data').value = new Date().toISOString().split('T')[0];
            
            // Busca próximo número
            try {
                const snapshot = await getCountFromServer(collection(db, INSCRICOES_COLLECTION));
                document.getElementById('inscricao').value = String(snapshot.data().count + 1).padStart(3, '0');
            } catch (e) { document.getElementById('inscricao').value = "Automático"; }
            
            // Busca Polos Configuradas
            try {
                const settingsDoc = await getDoc(doc(db, SETTINGS_COLLECTION, "geral"));
                const polosStr = settingsDoc.exists() ? (settingsDoc.data().polos || "") : "";
                
                if (polosStr.trim().length > 0) {
                    const polos = polosStr.split(',').map(p => p.trim().toUpperCase()).filter(p => p);
                    // Adiciona opção "Outro" caso o polo não esteja na lista
                    const options = polos.map(p => `<option value="${p}">${p}</option>`).join('');
                    
                    document.getElementById('polo-container').innerHTML = `
                        <label for="polo" class="form-label">Selecione seu Polo <span class="text-red-500">*</span></label>
                        <select id="polo" class="form-select font-bold text-blue-800">
                            <option value="">Clique para selecionar...</option>
                            ${options}
                            <option value="OUTRO">OUTRO (DIGITAR)</option>
                        </select>
                        <input type="text" id="polo-custom" class="form-input mt-2 hidden-section" placeholder="Digite o nome do polo" />
                    `;
                    
                    document.getElementById('polo').addEventListener('change', (e) => {
                        const customInput = document.getElementById('polo-custom');
                        if(e.target.value === 'OUTRO') {
                            customInput.classList.remove('hidden-section');
                            customInput.required = true;
                        } else {
                            customInput.classList.add('hidden-section');
                            customInput.required = false;
                        }
                    });
                }
            } catch (e) { console.log(e); }

            // Listeners
            document.getElementById('cpf').oninput = (e) => e.target.value = maskCPF(e.target.value);
            document.getElementById('telefone').oninput = (e) => e.target.value = maskPhone(e.target.value);
            document.getElementById('cep').oninput = (e) => { e.target.value = maskCEP(e.target.value); if(e.target.value.length === 9) fetchAddress(e.target.value); };
            document.getElementById('rg').onkeydown = (e) => { if (!/[0-9]/.test(e.key) && e.key.length === 1 && !e.ctrlKey) e.preventDefault(); };
            document.getElementById('dataNascimento').onchange = function() { 
                if(this.value) {
                    const diff = Date.now() - new Date(this.value).getTime();
                    document.getElementById('idade').value = Math.abs(new Date(diff).getUTCFullYear() - 1970);
                }
            };
            
            // Gera Perguntas de Saúde
            const hc = document.getElementById('health-questions-container');
            if(hc.children.length === 0) {
                const qs = [
                    {id:'bebidaAlcoolica',l:'Consome Bebida Alcoólica?'},
                    {id:'fumante',l:'É Fumante?'},
                    {id:'doadorSangue',l:'É Doador de Sangue?'},
                    {id:'cardiaco',l:'Possui problema Cardíaco?'},
                    {id:'hipertenso',l:'É Hipertenso (Pressão Alta)?'},
                    {id:'diabetico',l:'É Diabético?'}
                ];
                const t = document.getElementById('health-question-template');
                qs.forEach(q => {
                    const c = t.content.cloneNode(true);
                    c.querySelector('label').textContent = q.l;
                    c.querySelector('select').id = q.id;
                    hc.appendChild(c);
                });
            }
        }

        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submit-register-btn');
            const msg = document.getElementById('register-message');
            
            btn.disabled = true;
            document.getElementById('submit-loading').classList.remove('hidden-section');
            document.getElementById('submit-text').classList.add('hidden-section');
            
            try {
                const form = document.getElementById('register-form');
                const data = {};
                
                // Coleta dados genéricos
                form.querySelectorAll('input:not([type=radio]), select').forEach(el => { 
                    if(el.id && !el.id.includes('custom')) data[el.id] = el.value.toUpperCase(); // Força Uppercase em tudo que é texto
                });
                
                // Trata Polo Específico
                const poloSelect = document.getElementById('polo');
                if(poloSelect && poloSelect.tagName === 'SELECT' && poloSelect.value === 'OUTRO') {
                    data.polo = document.getElementById('polo-custom').value.toUpperCase().trim();
                } else if (poloSelect) {
                    data.polo = poloSelect.value.toUpperCase().trim();
                }

                // Normalização Extra
                if(data.polo) data.polo = normalizeText(data.polo);
                if(data.nome) data.nome = normalizeText(data.nome);
                
                // Radios
                const sex = form.querySelector('input[name="sexo"]:checked'); if(sex) data.sexo = sex.value;
                const shirt = form.querySelector('input[name="camisa"]:checked'); 
                if(shirt) data.camisa = shirt.value === 'Outro' ? (document.getElementById('camisaOutro').value.toUpperCase() || 'OUTRO') : shirt.value;
                
                // Saúde Detalhada
                ['alergias', 'cirurgiaRecente', 'tratamentoMedico', 'tomaMedicamento', 'problemaOrtopedico'].forEach(k => {
                    const sel = document.getElementById(k);
                    if (sel && sel.value === 'Sim') data[k] = `SIM (${document.getElementById(k+'Qual').value.toUpperCase() || ''})`;
                    else data[k] = "NÃO";
                });
                
                if(data.idade) data.idade = parseInt(data.idade);
                
                // Metadados
                data.status = 'pending'; 
                data.createdAt = new Date().toISOString();
                
                // Transação Segura para gerar ID sequencial
                try {
                    const counterRef = doc(db, SETTINGS_COLLECTION, "contador");
                    
                    await runTransaction(db, async (transaction) => {
                        const counterDoc = await transaction.get(counterRef);
                        let newCount = 1;
                        
                        if (!counterDoc.exists()) {
                            // Se não existe contador, inicializa baseado na contagem atual + 1
                            const snap = await getCountFromServer(collection(db, INSCRICOES_COLLECTION));
                            newCount = snap.data().count + 1;
                            transaction.set(counterRef, { total: newCount });
                        } else {
                            newCount = (counterDoc.data().total || 0) + 1;
                            transaction.update(counterRef, { total: newCount });
                        }
                        
                        data.inscricao = String(newCount).padStart(3, '0');
                        const newDocRef = doc(collection(db, INSCRICOES_COLLECTION));
                        transaction.set(newDocRef, data);
                    });
                } catch(e) {
                    console.error("Erro na transação:", e);
                    // Fallback para inserção simples em caso de falha crítica na transação
                    data.inscricao = "PENDENTE";
                    await addDoc(collection(db, INSCRICOES_COLLECTION), data);
                }
                
                msg.textContent = '✅ CADASTRO REALIZADO COM SUCESSO!';
                msg.className = 'mt-4 text-center text-lg font-bold text-green-600';
                
                // Scroll to message
                msg.scrollIntoView({ behavior: 'smooth' });
                
                setTimeout(() => {
                    if(auth.currentUser?.isAnonymous) signOut(auth);
                    window.location.reload();
                }, 3000);

            } catch (err) {
                console.error(err);
                msg.textContent = 'Erro ao salvar. Verifique sua internet.';
                msg.className = 'mt-4 text-center text-lg font-bold text-red-600';
                btn.disabled = false;
                document.getElementById('submit-loading').classList.add('hidden-section');
                document.getElementById('submit-text').classList.remove('hidden-section');
            }
        });

        // ===========================================
        // LÓGICA DO ADMIN
        // ===========================================
        var allData = [];
        var unsubscribe = null;

        function initAdminPanel() {
            if(unsubscribe) unsubscribe();
            
            // Carrega Configs
            getDoc(doc(db, SETTINGS_COLLECTION, "geral")).then(s => {
                if(s.exists()) document.getElementById('settings-polos').value = s.data().polos || "";
            });

            // Ouve dados em tempo real
            const q = collection(db, INSCRICOES_COLLECTION);
            unsubscribe = onSnapshot(q, (snap) => {
                allData = [];
                snap.forEach(d => {
                    let item = d.data();
                    item.id = d.id;
                    if(typeof item.idade === 'string') item.idade = parseInt(item.idade);
                    allData.push(item);
                });
                
                updatePoloFilters(); // Atualiza dropdowns de filtro
                renderDashboard();
                renderTable();

                // Atualiza view ativa se necessário
                const activeTab = [...document.querySelectorAll('.sidebar-link')].find(b => b.classList.contains('bg-pink-100'));
                if(activeTab) {
                    const id = activeTab.dataset.section;
                    if(id === 'tab-charts') renderCharts();
                    else if(id === 'tab-participants-pending') renderPendingPage();
                    else if(id === 'tab-participants-approved') renderStatusTable('approved');
                    else if(id === 'tab-participants-rejected') renderStatusTable('rejected');
                    else if(id === 'tab-health-restrictions') renderHealthRisks();
                    else if(id === 'tab-comms-whatsapp') renderWhatsappDirectory();
                }
            }, (error) => {
                console.error("Erro de permissão ou conexão:", error);
                if (error.code === 'permission-denied') {
                    alert("Acesso Negado: Seu usuário não tem permissão para visualizar os dados. Verifique se você está logado com a conta correta.");
                }
            });
        }
        
        // Atualiza filtro de polo baseado nos dados existentes
        function updatePoloFilters() {
            // Pega todos os polos únicos, normalizados para evitar duplicatas "sujas"
            const uniquePolos = new Set();
            
            allData.forEach(i => {
                const raw = i.polo || "SEM POLO";
                // Normaliza antes de adicionar ao Set para garantir unicidade visual
                const normalized = normalizeText(raw); 
                if(normalized) uniquePolos.add(normalized);
            });
            
            const sortedPolos = [...uniquePolos].sort();
            
            const createOptions = (list) => `<option value="all">Todos os Polos</option>` + list.map(p => `<option value="${p}">${p}</option>`).join('');
            
            // Atualiza dropdown de filtro do relatório
            const reportSelect = document.getElementById('report-polo-filter');
            const currentVal = reportSelect.value;
            
            reportSelect.innerHTML = createOptions(sortedPolos);
            
            // Tenta manter a seleção se ela ainda existir na lista nova, senão reseta
            if(sortedPolos.includes(currentVal)) {
                reportSelect.value = currentVal;
            } else {
                reportSelect.value = 'all';
            }
        }

        document.getElementById('save-settings-btn').addEventListener('click', async () => {
            const polos = document.getElementById('settings-polos').value.toUpperCase(); // Força upper na config
            try { await setDoc(doc(db, SETTINGS_COLLECTION, "geral"), { polos: polos }); alert('Configurações salvas!'); } catch(e) { alert('Erro.'); }
        });

        // Renumerar
        document.getElementById('renumber-all-btn').addEventListener('click', async () => {
            if (!confirm("Isso irá reescrever o número de TODAS as inscrições com base na data. Continuar?")) return;
            const btn = document.getElementById('renumber-all-btn'); const status = document.getElementById('renumber-status');
            btn.disabled = true; status.textContent = "Iniciando renumeração...";
            
            try {
                // Pega todos e ordena por data
                let docs = [...allData].sort((a, b) => new Date(a.createdAt || 0) - new Date(b.createdAt || 0));
                
                for (let i = 0; i < docs.length; i++) {
                    const newId = String(i + 1).padStart(3, '0');
                    if (docs[i].inscricao !== newId) {
                        await updateDoc(doc(db, INSCRICOES_COLLECTION, docs[i].id), { inscricao: newId });
                        status.textContent = `Atualizando registro ${i+1} de ${docs.length}...`;
                    }
                }
                status.textContent = "Concluído! Todos renumerados.";
            } catch (e) { status.textContent = "Erro ao processar."; }
            btn.disabled = false;
        });

        const getWhatsappLink = (phone) => {
            if(!phone) return '#';
            let num = phone.replace(/\D/g, '');
            if(num.length < 10) return '#'; 
            if(!num.startsWith('55')) num = '55' + num;
            return `https://wa.me/${num}`;
        };

        let chartPolosInstance = null;
        let chartBairrosInstance = null;
        let chartIdadeInstance = null;
        let chartSaudeInstance = null;

        function renderCharts() {
            // Safety check for Chart.js
            if (typeof Chart === 'undefined') {
                console.error("Chart.js não foi carregado corretamente.");
                return;
            }

            try {
                const ctxPolos = document.getElementById('chart-polos');
                const ctxBairros = document.getElementById('chart-bairros');
                const ctxIdade = document.getElementById('chart-idade');
                const ctxSaude = document.getElementById('chart-saude');
                
                if(!ctxPolos || !ctxBairros || !ctxIdade || !ctxSaude) return;

                // DESTROY OLD INSTANCES
                if(chartPolosInstance) chartPolosInstance.destroy();
                if(chartBairrosInstance) chartBairrosInstance.destroy();
                if(chartIdadeInstance) chartIdadeInstance.destroy();
                if(chartSaudeInstance) chartSaudeInstance.destroy();

                // 1. Agregação de Polos
                const polosCount = {};
                allData.forEach(i => {
                    let p = normalizeText(i.polo || 'SEM POLO');
                    if(p.includes('RADIOBAL')) p = 'RADIONAL';
                    polosCount[p] = (polosCount[p] || 0) + 1;
                });
                const polosLabels = Object.keys(polosCount);
                const polosValues = Object.values(polosCount);

                // 2. Agregação de Bairros (Top 10)
                const bairrosCount = {};
                allData.forEach(i => {
                    const b = normalizeText(i.bairro || 'NÃO INFORMADO');
                    bairrosCount[b] = (bairrosCount[b] || 0) + 1;
                });
                const sortedBairros = Object.entries(bairrosCount).sort((a,b) => b[1] - a[1]).slice(0, 10);

                // 3. Agregação de Idade
                const ageRanges = { 'Menor 18': 0, '18-29': 0, '30-39': 0, '40-49': 0, '50-59': 0, '60+': 0 };
                allData.forEach(i => {
                    const age = i.idade || 0;
                    if(age < 18) ageRanges['Menor 18']++;
                    else if(age < 30) ageRanges['18-29']++;
                    else if(age < 40) ageRanges['30-39']++;
                    else if(age < 50) ageRanges['40-49']++;
                    else if(age < 60) ageRanges['50-59']++;
                    else ageRanges['60+']++;
                });

                // 4. Agregação de Saúde
                const saudeStats = { 'Hipertenso': 0, 'Diabético': 0, 'Cardíaco': 0, 'Outros Riscos': 0 };
                allData.forEach(i => {
                    if(i.hipertenso === 'Sim') saudeStats['Hipertenso']++;
                    if(i.diabetico === 'Sim') saudeStats['Diabético']++;
                    if(i.cardiaco === 'Sim') saudeStats['Cardíaco']++;
                    // Verifica se tem outros riscos
                    if((i.alergias && i.alergias.includes('SIM')) || (i.problemaOrtopedico && i.problemaOrtopedico.includes('SIM'))) saudeStats['Outros Riscos']++;
                });

                // Destroi anteriores se existirem e forem válidos
                if(chartPolosInstance) { try { chartPolosInstance.destroy(); } catch(e){} }
                if(chartBairrosInstance) { try { chartBairrosInstance.destroy(); } catch(e){} }
                if(chartIdadeInstance) { try { chartIdadeInstance.destroy(); } catch(e){} }
                if(chartSaudeInstance) { try { chartSaudeInstance.destroy(); } catch(e){} }

                // CHART POLOS
                chartPolosInstance = new Chart(ctxPolos, {
                    type: 'doughnut',
                    data: {
                        labels: polosLabels,
                        datasets: [{
                            data: polosValues,
                            backgroundColor: ['#ec4899', '#f472b6', '#db2777', '#be185d', '#9d174d', '#831843', '#fbcfe8', '#f9a8d4', '#fda4af', '#e11d48'],
                            borderWidth: 1
                        }]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'right', labels: { boxWidth: 10, font: { size: 10 } } } }
                    }
                });

                // CHART BAIRROS
                chartBairrosInstance = new Chart(ctxBairros, {
                    type: 'bar',
                    data: {
                        labels: sortedBairros.map(i => i[0]),
                        datasets: [{
                            label: 'Inscritos',
                            data: sortedBairros.map(i => i[1]),
                            backgroundColor: '#3b82f6',
                            borderRadius: 4
                        }]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: { y: { beginAtZero: true, ticks: { precision: 0 } }, x: { ticks: { autoSkip: false, maxRotation: 45, minRotation: 45, font: { size: 9 } } } }
                    }
                });

                // CHART IDADE
                chartIdadeInstance = new Chart(ctxIdade, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(ageRanges),
                        datasets: [{
                            label: 'Faixa Etária',
                            data: Object.values(ageRanges),
                            backgroundColor: '#10b981',
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
                    }
                });

                // CHART SAUDE
                chartSaudeInstance = new Chart(ctxSaude, {
                    type: 'pie',
                    data: {
                        labels: Object.keys(saudeStats),
                        datasets: [{
                            data: Object.values(saudeStats),
                            backgroundColor: ['#ef4444', '#3b82f6', '#f97316', '#8b5cf6'],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'right', labels: { boxWidth: 10, font: { size: 10 } } } }
                    }
                });
            } catch (err) {
                console.error("Erro ao renderizar gráficos:", err);
            }
        }

        function renderDashboard() {
            const approved = allData.filter(i => i.status === 'approved').length;
            const pending = allData.filter(i => !i.status || i.status === 'pending');
            
            document.getElementById('admin-stats').innerHTML = `
                <div class="bg-white p-5 rounded-xl border border-gray-100 shadow-sm flex justify-between items-center"><div><p class="text-xs font-bold text-gray-400 uppercase">Total Geral</p><p class="text-3xl font-bold text-gray-800">${allData.length}</p></div><div class="p-3 bg-gray-100 rounded-full text-gray-500"><i data-lucide="users"></i></div></div>
                <div class="bg-white p-5 rounded-xl border border-green-100 shadow-sm flex justify-between items-center"><div><p class="text-xs font-bold text-green-600 uppercase">Aprovados</p><p class="text-3xl font-bold text-green-700">${approved}</p></div><div class="p-3 bg-green-100 rounded-full text-green-600"><i data-lucide="check-circle"></i></div></div>
                <div class="bg-white p-5 rounded-xl border border-yellow-100 shadow-sm flex justify-between items-center"><div><p class="text-xs font-bold text-yellow-600 uppercase">Pendentes</p><p class="text-3xl font-bold text-yellow-700">${pending.length}</p></div><div class="p-3 bg-yellow-100 rounded-full text-yellow-600"><i data-lucide="clock"></i></div></div>
            `;
            
            const list = document.getElementById('pending-registrations-list');
            document.getElementById('pending-count-badge').textContent = pending.length;
            
            if(pending.length === 0) {
                list.innerHTML = '';
                document.getElementById('no-pending-message').classList.remove('hidden-section');
            } else {
                document.getElementById('no-pending-message').classList.add('hidden-section');
                list.innerHTML = pending.map(i => `
                    <div class="bg-white p-4 rounded-lg border border-yellow-200 shadow-sm flex flex-col md:flex-row justify-between items-center gap-4">
                        <div class="flex items-center gap-3">
                            <div class="bg-yellow-100 p-2 rounded text-yellow-700 font-bold text-xs">#${i.inscricao}</div>
                            <div>
                                <div class="font-bold text-gray-800 text-lg">${i.nome}</div>
                                <div class="text-xs text-gray-500 font-medium">${i.polo || 'Sem Polo'} • ${i.telefone}</div>
                            </div>
                        </div>
                        <div class="flex gap-2 w-full md:w-auto">
                            <button onclick="window.quickApprove('${i.id}')" class="btn btn-success flex-grow md:flex-grow-0 text-sm py-2"><i data-lucide="check" class="w-4 h-4 mr-1"></i> Aprovar</button>
                            <button onclick="window.openEditor('${i.id}')" class="btn btn-secondary flex-grow md:flex-grow-0 text-sm py-2"><i data-lucide="edit" class="w-4 h-4 mr-1"></i> Detalhes</button>
                        </div>
                    </div>
                `).join('');
            }
            if(window.lucide) lucide.createIcons();
        }

        function renderHealthRisks() {
            const risks = allData.filter(i => {
                return (i.hipertenso === 'Sim') || 
                       (i.diabetico === 'Sim') || 
                       (i.cardiaco === 'Sim') || 
                       (i.alergias && i.alergias.includes('SIM')) ||
                       (i.cirurgiaRecente && i.cirurgiaRecente.includes('SIM')) ||
                       (i.tratamentoMedico && i.tratamentoMedico.includes('SIM')) ||
                       (i.tomaMedicamento && i.tomaMedicamento.includes('SIM')) ||
                       (i.problemaOrtopedico && i.problemaOrtopedico.includes('SIM'));
            });

            const list = document.getElementById('health-risk-list');
            const count = document.getElementById('health-risk-count');
            const empty = document.getElementById('no-health-risks');
            
            if(!list || !count) return;

            count.textContent = risks.length;

            if(risks.length === 0) {
                list.innerHTML = '';
                empty.classList.remove('hidden-section');
            } else {
                empty.classList.add('hidden-section');
                list.innerHTML = risks.map(i => {
                    let tags = [];
                    if(i.hipertenso === 'Sim') tags.push('<span class="bg-red-100 text-red-700 px-2 py-1 rounded text-xs font-bold">Hipertenso</span>');
                    if(i.diabetico === 'Sim') tags.push('<span class="bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs font-bold">Diabético</span>');
                    if(i.cardiaco === 'Sim') tags.push('<span class="bg-orange-100 text-orange-700 px-2 py-1 rounded text-xs font-bold">Cardíaco</span>');
                    
                    // Detalhes extras
                    let details = [];
                    if(i.alergias && i.alergias.includes('SIM')) details.push(`<b>Alergias:</b> ${i.alergias}`);
                    if(i.cirurgiaRecente && i.cirurgiaRecente.includes('SIM')) details.push(`<b>Cirurgias:</b> ${i.cirurgiaRecente}`);
                    if(i.tratamentoMedico && i.tratamentoMedico.includes('SIM')) details.push(`<b>Tratamento:</b> ${i.tratamentoMedico}`);
                    if(i.tomaMedicamento && i.tomaMedicamento.includes('SIM')) details.push(`<b>Remédios:</b> ${i.tomaMedicamento}`);
                    if(i.problemaOrtopedico && i.problemaOrtopedico.includes('SIM')) details.push(`<b>Ortopédico:</b> ${i.problemaOrtopedico}`);

                    return `
                    <div class="bg-white p-4 rounded-lg border border-red-200 shadow-sm hover:shadow-md transition-shadow">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h3 class="font-bold text-gray-800 text-lg">${i.nome}</h3>
                                <p class="text-xs text-gray-500 font-bold">${i.polo || 'Sem Polo'}</p>
                            </div>
                            <button onclick="window.openEditor('${i.id}')" class="text-blue-600 hover:text-blue-800"><i data-lucide="external-link" class="w-5 h-5"></i></button>
                        </div>
                        <div class="flex flex-wrap gap-2 mb-3">${tags.join('')}</div>
                        ${details.length > 0 ? `<div class="text-xs text-gray-600 bg-gray-50 p-2 rounded border border-gray-100 space-y-1">${details.map(d => `<div>${d}</div>`).join('')}</div>` : ''}
                        <div class="mt-3 pt-3 border-t flex justify-between items-center">
                            <span class="text-xs font-bold text-gray-400">Idade: ${i.idade||'-'}</span>
                            <a href="${getWhatsappLink(i.telefone)}" target="_blank" class="text-green-600 hover:text-green-700 font-bold text-xs flex items-center gap-1"><i data-lucide="message-circle" class="w-4 h-4"></i> Contatar</a>
                        </div>
                    </div>
                    `;
                }).join('');
            }
            if(window.lucide) lucide.createIcons();
        }

        function renderWhatsappDirectory() {
            const term = document.getElementById('whatsapp-search').value.toLowerCase();
            const list = document.getElementById('whatsapp-list-body');
            if(!list) return;

            const filtered = allData.filter(i => (i.nome||'').toLowerCase().includes(term) || (i.polo||'').toLowerCase().includes(term));
            
            // Limita a 50 para não travar se tiver muitos
            const display = filtered.slice(0, 50);

            list.innerHTML = display.map(i => `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3">
                        <div class="font-medium text-gray-900">${i.nome}</div>
                        <div class="text-xs text-gray-400">#${i.inscricao||'--'}</div>
                    </td>
                    <td class="px-4 py-3 text-xs font-bold text-blue-800">${i.polo||'-'}</td>
                    <td class="px-4 py-3 text-xs text-gray-500">${i.telefone||'-'}</td>
                    <td class="px-4 py-3 text-center">
                        <a href="${getWhatsappLink(i.telefone)}" target="_blank" class="btn btn-whatsapp text-xs py-1 px-3 rounded-full inline-flex items-center gap-1">
                            <i data-lucide="message-circle" class="w-3 h-3"></i> Conversar
                        </a>
                    </td>
                </tr>
            `).join('');
            
            if(filtered.length === 0) {
                list.innerHTML = `<tr><td colspan="4" class="px-4 py-8 text-center text-gray-400">Nenhum contato encontrado.</td></tr>`;
            }
            if(window.lucide) lucide.createIcons();
        }

        function renderTable() {
            const q = document.getElementById('admin-search').value.toLowerCase();
            const s = document.getElementById('admin-sort').value;
            
            // Filtra e Ordena
            let d = allData.filter(i => (i.nome + i.cpf + (i.polo||'')).toLowerCase().includes(q));
            
            if(s === 'name_asc') d.sort((a,b) => (a.nome||'').localeCompare(b.nome||''));
            else if (s === 'polo_asc') d.sort((a,b) => (a.polo||'').localeCompare(b.polo||''));
            else d.sort((a,b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0));

            const tb = document.getElementById('all-participants-table-body');
            
            if(d.length === 0) {
                tb.innerHTML = '';
                document.getElementById('no-participants-message').classList.remove('hidden-section');
            } else {
                document.getElementById('no-participants-message').classList.add('hidden-section');
                tb.innerHTML = d.map(i => {
                    // Traduz status visual
                    let stClass = 'bg-gray-100 text-gray-600';
                    let stText = 'Desconhecido';
                    if(i.status === 'approved') { stClass = 'bg-green-100 text-green-800 border border-green-200'; stText = 'Aprovado'; }
                    else if(i.status === 'rejected') { stClass = 'bg-red-100 text-red-800 border border-red-200'; stText = 'Rejeitado'; }
                    else { stClass = 'bg-yellow-100 text-yellow-800 border border-yellow-200'; stText = 'Pendente'; }

                    return `
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-4 md:px-6 py-4">
                            <div class="flex items-center">
                                <span class="font-mono font-bold text-pink-600 bg-pink-50 px-2 py-1 rounded text-xs mr-3">#${i.inscricao||'--'}</span>
                                <div class="font-medium text-gray-900">${i.nome}</div>
                            </div>
                        </td>
                        <td class="px-4 md:px-6 py-4 text-xs font-bold text-blue-800">${i.polo || '-'}</td>
                        <td class="px-4 md:px-6 py-4 text-xs text-gray-500">
                            <div>${i.telefone}</div>
                            <div class="text-xs text-gray-400">${i.cpf}</div>
                        </td>
                        <td class="px-4 md:px-6 py-4"><span class="px-2 py-1 text-xs font-bold bg-gray-100 rounded border">${i.camisa||'-'}</span></td>
                        <td class="px-4 md:px-6 py-4"><span class="px-3 py-1 text-xs font-bold rounded-full ${stClass}">${stText}</span></td>
                        <td class="px-4 md:px-6 py-4 text-right flex gap-2 justify-end">
                            <a href="${getWhatsappLink(i.telefone)}" target="_blank" class="p-2 text-green-600 hover:bg-green-50 rounded-full" title="WhatsApp"><i data-lucide="message-circle" class="w-4 h-4"></i></a>
                            <button onclick="window.openEditor('${i.id}')" class="p-2 text-blue-600 hover:bg-blue-50 rounded-full font-bold flex items-center gap-1 text-xs"><i data-lucide="edit-2" class="w-4 h-4"></i> Editar</button>
                        </td>
                    </tr>
                `}).join('');
            }
            document.getElementById('table-footer-count').textContent = `Mostrando ${d.length} registros`;
            if(window.lucide) lucide.createIcons();
        }
        
        document.getElementById('admin-search').addEventListener('input', renderTable);
        document.getElementById('admin-sort').addEventListener('change', renderTable);

        // Ações Globais
        window.quickApprove = async (id) => { 
            if(!confirm('Aprovar esta inscrição?')) return; 
            try { await updateDoc(doc(db, INSCRICOES_COLLECTION, id), {status: 'approved'}); } catch(e) { alert('Erro'); } 
        };

        // Tabelas/Cartões filtrados por status
        function renderPendingPage() {
            const pending = allData.filter(i => !i.status || i.status === 'pending');
            const list = document.getElementById('pending-page-list');
            const badge = document.getElementById('pending-page-count');
            if(!list || !badge) return;
            badge.textContent = pending.length;
            if(pending.length === 0) {
                list.innerHTML = '';
                document.getElementById('pending-page-empty').classList.remove('hidden-section');
            } else {
                document.getElementById('pending-page-empty').classList.add('hidden-section');
                list.innerHTML = pending.map(i => `
                    <div class="bg-white p-4 rounded-lg border border-yellow-200 shadow-sm flex flex-col md:flex-row justify-between items-center gap-4">
                        <div class="flex items-center gap-3">
                            <div class="bg-yellow-100 p-2 rounded text-yellow-700 font-bold text-xs">#${i.inscricao||'--'}</div>
                            <div>
                                <div class="font-bold text-gray-800 text-lg">${i.nome}</div>
                                <div class="text-xs text-gray-500 font-medium">${i.polo || 'Sem Polo'} • ${i.telefone||'-'}</div>
                            </div>
                        </div>
                        <div class="flex gap-2 w-full md:w-auto">
                            <button onclick="window.quickApprove('${i.id}')" class="btn btn-success flex-grow md:flex-grow-0 text-sm py-2"><i data-lucide="check" class="w-4 h-4 mr-1"></i> Aprovar</button>
                            <button onclick="window.openEditor('${i.id}')" class="btn btn-secondary flex-grow md:flex-grow-0 text-sm py-2"><i data-lucide="edit" class="w-4 h-4 mr-1"></i> Detalhes</button>
                        </div>
                    </div>
                `).join('');
            }
            if(window.lucide) lucide.createIcons();
        }

        function renderStatusTable(status) {
            const filtered = allData.filter(i => i.status === status);
            const bodyId = status === 'approved' ? 'approved-table-body' : 'rejected-table-body';
            const tb = document.getElementById(bodyId);
            if(!tb) return;
            tb.innerHTML = filtered.map(i => `
                <tr class="hover:bg-gray-50 transition-colors">
                    <td class="px-4 py-3">
                        <div class="flex items-center">
                            <span class="font-mono font-bold text-pink-600 bg-pink-50 px-2 py-1 rounded text-xs mr-3">#${i.inscricao||'--'}</span>
                            <div class="font-medium text-gray-900">${i.nome}</div>
                        </div>
                    </td>
                    <td class="px-4 py-3 text-xs font-bold text-blue-800">${i.polo || '-'}</td>
                    <td class="px-4 py-3 text-xs text-gray-500">
                        <div>${i.telefone||'-'}</div>
                        <div class="text-xs text-gray-400">${i.cpf||'-'}</div>
                    </td>
                </tr>
            `).join('');
            if(window.lucide) lucide.createIcons();
        }

        // --- LÓGICA DO MODAL DE EDIÇÃO AVANÇADA ---
        window.openEditor = (id) => {
            const data = allData.find(x => x.id === id);
            if(!data) return;

            document.getElementById('edit-doc-id').value = id;
            
            // Popula campos simples (IDs devem bater com campos do objeto)
            // Mapeamento manual para garantir que pegamos tudo
            const fields = ['nome', 'cpf', 'rg', 'dataNascimento', 'idade', 'sexo', 'camisa', 'telefone', 
                            'polo', 'cep', 'endereco', 'bairro', 'numero', 'cidade', 
                            'profissao', 'estadoCivil', 'zona', 'tipoSanguineo', 'inscricao', 'status'];
            
            fields.forEach(f => {
                const el = document.getElementById(`edit-${f}`);
                if(el) el.value = data[f] || "";
            });
            
            document.getElementById('edit-createdAtDisplay').value = new Date(data.createdAt || Date.now()).toLocaleDateString('pt-BR');

            // Popula Obs de saúde (Junta os campos em um texto só para facilitar leitura/edição)
            let saudeResumo = "";
            if(data.alergias && data.alergias.includes('SIM')) saudeResumo += `Alergias: ${data.alergias}\n`;
            if(data.cirurgiaRecente && data.cirurgiaRecente.includes('SIM')) saudeResumo += `Cirurgias: ${data.cirurgiaRecente}\n`;
            if(data.tratamentoMedico && data.tratamentoMedico.includes('SIM')) saudeResumo += `Tratamento: ${data.tratamentoMedico}\n`;
            if(data.tomaMedicamento && data.tomaMedicamento.includes('SIM')) saudeResumo += `Remédios: ${data.tomaMedicamento}\n`;
            if(data.problemaOrtopedico && data.problemaOrtopedico.includes('SIM')) saudeResumo += `Ortopédico: ${data.problemaOrtopedico}\n`;
            document.getElementById('edit-obs-saude').value = saudeResumo;

            // Checkboxes Saúde
            document.getElementById('edit-check-hipertenso').checked = (data.hipertenso === 'Sim');
            document.getElementById('edit-check-diabetico').checked = (data.diabetico === 'Sim');
            document.getElementById('edit-check-cardiaco').checked = (data.cardiaco === 'Sim');

            // Exibe
            const modal = document.getElementById('details-modal');
            modal.style.display = 'flex';
            setTimeout(() => modal.style.opacity = 1, 10);
        };

        // Salvar Edição
        document.getElementById('modal-save-btn').onclick = async () => {
            const id = document.getElementById('edit-doc-id').value;
            if(!id) return;
            
            const btn = document.getElementById('modal-save-btn');
            const originalText = btn.innerHTML;
            btn.textContent = "Salvando...";
            btn.disabled = true;

            const updateData = {};
            // Pega campos de input direto
            document.getElementById('edit-form').querySelectorAll('input:not([type=checkbox]), select, textarea').forEach(el => {
                if(el.id.startsWith('edit-') && !el.id.includes('obs-saude')) {
                    const key = el.id.replace('edit-', '');
                    // Força Upper ao salvar edição + normalização
                    let val = el.value.toUpperCase();
                    if(key === 'polo' || key === 'nome') val = normalizeText(val);
                    updateData[key] = (key !== 'status' && key !== 'sexo') ? val : el.value;
                }
            });
            
            // Trata saúde
            updateData.hipertenso = document.getElementById('edit-check-hipertenso').checked ? 'Sim' : 'Não';
            updateData.diabetico = document.getElementById('edit-check-diabetico').checked ? 'Sim' : 'Não';
            updateData.cardiaco = document.getElementById('edit-check-cardiaco').checked ? 'Sim' : 'Não';
            
            // Obs saude vai para um campo genérico de notas se quiser, ou ignoramos pois é só visualização concatenada
            // Vamos salvar num campo 'observacoesAdmin'
            updateData.observacoesAdmin = document.getElementById('edit-obs-saude').value;

            try {
                await updateDoc(doc(db, INSCRICOES_COLLECTION, id), updateData);
                alert('Alterações salvas com sucesso!');
                document.getElementById('close-modal-btn').click();
            } catch(e) {
                console.error(e);
                alert('Erro ao salvar edição.');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        };

        // Excluir
        document.getElementById('modal-delete-btn').onclick = async () => { 
            if(confirm('Tem certeza que deseja EXCLUIR DEFINITIVAMENTE este cadastro?')) { 
                try { 
                    await deleteDoc(doc(db, INSCRICOES_COLLECTION, document.getElementById('edit-doc-id').value)); 
                    document.getElementById('close-modal-btn').click(); 
                } catch(e) { alert('Erro'); } 
            }
        };

        document.getElementById('close-modal-btn').onclick = () => { 
            document.getElementById('details-modal').style.opacity = 0; 
            setTimeout(() => document.getElementById('details-modal').style.display = 'none', 200); 
        };

        // ===========================================
        // RELATÓRIOS (Traduzido e Filtrado)
        // ===========================================
        document.getElementById('generate-report-btn').addEventListener('click', () => {
            const st = document.getElementById('report-status-filter').value;
            const polo = document.getElementById('report-polo-filter').value;
            const sh = document.getElementById('report-camisa-filter').value;
            const sx = document.getElementById('report-sexo-filter').value;
            const ci = document.getElementById('report-city-filter').value.toUpperCase();
            const minAge = document.getElementById('report-age-min').value;
            const maxAge = document.getElementById('report-age-max').value;
            
            const res = allData.filter(i => {
                if(st !== 'all' && (i.status||'pending') !== st) return false;
                
                // --- Correção da Lógica de Filtro de Polo ---
                // Se o filtro não for "todos", normaliza o dado do banco para comparar com o filtro normalizado
                if(polo !== 'all') {
                    const itemPolo = normalizeText(i.polo || "SEM POLO");
                    if(itemPolo !== polo) return false;
                }
                
                if(sh !== 'all' && i.camisa !== sh) return false;
                if(sx !== 'all' && i.sexo !== sx) return false;
                if(ci && !(i.cidade||'').includes(ci)) return false;
                if(minAge && (i.idade < minAge)) return false;
                if(maxAge && (i.idade > maxAge)) return false;
                return true;
            });
            
            document.getElementById('report-results-container').classList.remove('hidden-section');
            document.getElementById('summary-total').textContent = res.length;
            const cam = {}; res.forEach(r => cam[r.camisa] = (cam[r.camisa]||0)+1);
            document.getElementById('summary-camisas').innerHTML = Object.entries(cam).map(([k,v]) => `<span class="px-2 py-1 bg-white border border-blue-200 rounded text-xs font-bold text-blue-800">${k}: ${v}</span>`).join('');
            
            // Colunas
            const cols = Array.from(document.querySelectorAll('#report-fields input:checked')).map(c => c.value);
            
            // Header
            document.getElementById('report-table-head').innerHTML = `<tr>${cols.map(c => `<th class="px-4 py-3 text-left font-bold text-gray-600 uppercase bg-gray-100 border-b">${c}</th>`).join('')}</tr>`;
            
            // Body (Com tradução de Status)
            document.getElementById('report-table-body').innerHTML = res.map(r => {
                return `<tr class="border-b hover:bg-gray-50">${cols.map(c => {
                    let val = r[c] || '-';
                    // Tradução específica para relatório
                    if(c === 'status') {
                        if(val === 'approved') val = 'Aprovado';
                        else if(val === 'rejected') val = 'Rejeitado';
                        else val = 'Pendente';
                    }
                    return `<td class="px-4 py-2">${val}</td>`;
                }).join('')}</tr>`;
            }).join('');
            
            // Prepara objeto para exportação (com status traduzido)
            window.lastReport = { 
                headers: cols.map(c => c.toUpperCase()), 
                data: res.map(r => cols.map(c => {
                    let val = r[c] || '';
                    if(c === 'status') {
                        if(val === 'approved') return 'Aprovado';
                        if(val === 'rejected') return 'Rejeitado';
                        return 'Pendente';
                    }
                    return val;
                })) 
            };
        });
        
        const exportXlsx = () => { if(window.lastReport) { const ws = XLSX.utils.aoa_to_sheet([window.lastReport.headers, ...window.lastReport.data]); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Relatorio"); XLSX.writeFile(wb, "relatorio_zumba.xlsx"); }};
        const exportCsv = () => { if(window.lastReport) { const ws = XLSX.utils.aoa_to_sheet([window.lastReport.headers, ...window.lastReport.data]); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Relatorio"); XLSX.writeFile(wb, "relatorio_zumba.csv"); }};
        const exportPdf = () => { if(window.lastReport) { const doc = new window.jspdf.jsPDF({orientation:'landscape'}); doc.text("Relatório Projeto Zumba", 14, 15); doc.autoTable({head:[window.lastReport.headers], body:window.lastReport.data, startY: 20}); doc.save("relatorio_zumba.pdf"); }};

        if(document.getElementById('export-xlsx-btn')) document.getElementById('export-xlsx-btn').onclick = exportXlsx;
        if(document.getElementById('export-csv-btn')) document.getElementById('export-csv-btn').onclick = exportCsv;
        if(document.getElementById('export-pdf-btn')) document.getElementById('export-pdf-btn').onclick = exportPdf;

        if(document.getElementById('export-xlsx-btn-2')) document.getElementById('export-xlsx-btn-2').onclick = exportXlsx;
        if(document.getElementById('export-csv-btn-2')) document.getElementById('export-csv-btn-2').onclick = exportCsv;
        if(document.getElementById('export-pdf-btn-2')) document.getElementById('export-pdf-btn-2').onclick = exportPdf;

        if(window.lucide) lucide.createIcons();
    </script>
</body>
</html>
