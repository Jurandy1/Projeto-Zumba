<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro Projeto Zumba</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Font (Inter) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">

    <!-- Ícones (Lucide) -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <!-- Export libs -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.28/dist/jspdf.plugin.autotable.min.js"></script>

    <style>
        /* Estilo base com a fonte Inter */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0fdf4; /* Verde bem claro */
        }

        /* Tema Zumba: Cores vibrantes */
        .zumba-gradient {
            background: linear-gradient(135deg, #ec4899, #d946ef, #a855f7); /* Pink -> Fuchsia -> Roxo */
        }
        
        .zumba-gradient-alt {
            background: linear-gradient(135deg, #a3e635, #34d399, #22d3ee); /* Verde-limão -> Esmeralda -> Ciano */
        }

        .btn-zumba {
            padding: 0.75rem 1.5rem;
            font-weight: 700;
            color: #ffffff;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            transition: transform 300ms ease-in-out, background-color 300ms ease-in-out, box-shadow 300ms ease-in-out;
            background: linear-gradient(135deg, #ec4899, #e11d48);
        }
        .btn-zumba:hover { transform: scale(1.05); }
        
        .btn-zumba-alt {
            padding: 0.75rem 1.5rem;
            font-weight: 700;
            color: #ffffff;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            transition: transform 300ms ease-in-out, background-color 300ms ease-in-out, box-shadow 300ms ease-in-out;
            background: linear-gradient(135deg, #a3e635, #4d7c0f);
        }
        .btn-zumba-alt:hover { transform: scale(1.05); }
        
        .btn-zumba-secondary {
            padding: 0.5rem 1rem;
            font-weight: 600;
            color: #374151;
            background-color: #e5e7eb;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            transition: background-color 300ms ease-in-out, transform 300ms ease-in-out;
        }
        .btn-zumba-secondary:hover { background-color: #d1d5db; transform: scale(1.05); }

        /* Estilo para inputs */
        .form-input {
            width: 100%;
            padding: 0.5rem 1rem;
            margin-top: 0.25rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            box-shadow: 0 1px 2px 0 rgba(0,0,0,0.05);
            outline: none;
        }
        .form-input:focus { box-shadow: 0 0 0 2px #ec4899; border-color: transparent; }
        
        .form-select {
            width: 100%;
            padding: 0.5rem 1rem;
            margin-top: 0.25rem;
            background-color: #ffffff;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            box-shadow: 0 1px 2px 0 rgba(0,0,0,0.05);
            outline: none;
        }
        .form-select:focus { box-shadow: 0 0 0 2px #ec4899; border-color: transparent; }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
        }

        /* Ocultar/Mostrar seções */
        .hidden-section {
            display: none;
        }

        /* Estilo do Modal */
        #details-modal {
            position: fixed;
            inset: 0;
            z-index: 50;
            display: none; /* Alterado para começar como none */
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.75);
            opacity: 0; /* Alterado para começar com opacidade 0 */
            transition: opacity 300ms ease-in-out;
        }
    </style>
</head>
<body class="antialiased text-gray-900">

    <!-- Container Principal -->
    <div class="container mx-auto p-4 md:p-8 max-w-7xl">

        <!-- ===== SEÇÃO DE LOGIN ===== -->
        <section id="login-view">
            <div class="flex flex-col items-center justify-center min-h-screen py-12">
                <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-2xl shadow-2xl">
                    <div class="text-center">
                        <h1 class="text-4xl font-black zumba-gradient bg-clip-text text-transparent">Projeto Zumba</h1>
                        <p class="mt-2 text-lg text-gray-600">Bem-vindo(a)!</p>
                    </div>
                    
                    <!-- Formulário de Login (Admin) -->
                    <form id="admin-login-form" class="space-y-4">
                        <h2 class="text-xl font-bold text-center text-gray-700">Login do Administrador</h2>
                        <div>
                            <label for="admin-email" class="form-label">Email</label>
                            <input type="email" id="admin-email" class="form-input" required>
                        </div>
                        <div>
                            <label for="admin-password" class="form-label">Senha</label>
                            <input type="password" id="admin-password" class="form-input" required>
                        </div>
                        <button type="submit" class="w-full btn-zumba">Entrar</button>
                    </form>
                    
                    <div class="relative flex items-center justify-center">
                        <div class="absolute inset-0 flex items-center">
                            <div class="w-full border-t border-gray-300"></div>
                        </div>
                        <div class="relative px-2 text-sm text-gray-500 bg-white">
                            ou
                        </div>
                    </div>

                    <!-- Botão para ir ao Cadastro -->
                    <button type="button" id="go-to-register-btn" class="w-full btn-zumba-alt">
                        Fazer Inscrição
                    </button>
                    
                    <p id="auth-error" class="text-sm text-center text-red-500"></p>
                </div>
            </div>
        </section>

        <!-- ===== SEÇÃO DE CADASTRO ===== -->
        <section id="register-view" class="hidden-section">
            <div class="max-w-4xl p-8 mx-auto space-y-8 bg-white rounded-2xl shadow-2xl">
                <div class="text-center">
                    <h1 class="text-4xl font-black zumba-gradient-alt bg-clip-text text-transparent">Ficha de Cadastro</h1>
                    <p class="mt-2 text-lg text-gray-600">Preencha seus dados para participar</p>
                </div>

                <form id="register-form" class="space-y-6">
                    
                    <!-- Seção 1: Dados Iniciais -->
                    <fieldset class="p-4 border rounded-lg">
                        <legend class="px-2 text-lg font-bold text-gray-800">Identificação</legend>
                        <div class="grid grid-cols-1 gap-4 md:grid-cols-3">
                            <div>
                                <label for="polo" class="form-label">Polo</label>
                                <input type="text" id="polo" class="form-input">
                            </div>
                            <div>
                                <label for="inscricao" class="form-label">N° Inscrição</label>
                                <!-- Tornar o campo readonly e adicionar bg-gray-100 para indicar auto-preenchimento -->
                                <input type="text" id="inscricao" class="form-input bg-gray-100" readonly>
                            </div>
                            <div>
                                <label for="data" class="form-label">Data</label>
                                <input type="date" id="data" class="form-input" required>
                            </div>
                        </div>
                    </fieldset>

                    <!-- Seção 2: Dados Pessoais -->
                    <fieldset class="p-4 border rounded-lg">
                        <legend class="px-2 text-lg font-bold text-gray-800">Dados Pessoais</legend>
                        <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
                             <div>
                                <label for="nome" class="form-label">Nome Completo</label>
                                <input type="text" id="nome" class="form-input" required>
                            </div>
                            <div>
                                <label class="form-label">Sexo</label>
                                <div class="flex items-center mt-2 space-x-4">
                                    <label class="flex items-center">
                                        <input type="radio" name="sexo" value="Masculino" class="text-pink-600 focus:ring-pink-500" required>
                                        <span class="ml-2">Masculino</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="radio" name="sexo" value="Feminino" class="text-pink-600 focus:ring-pink-500" required>
                                        <span class="ml-2">Feminino</span>
                                    </label>
                                </div>
                            </div>
                            <div>
                                <label for="dataNascimento" class="form-label">Data de Nascimento</label>
                                <input type="date" id="dataNascimento" class="form-input" required>
                            </div>
                            <div>
                                <label for="idade" class="form-label">Idade</label>
                                <!-- Tornar o campo readonly e adicionar bg-gray-100 para indicar auto-preenchimento -->
                                <input type="number" id="idade" class="form-input bg-gray-100" readonly required>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 gap-4 mt-4 md:grid-cols-3">
                            <div>
                                <label for="endereco" class="form-label">Endereço (Rua, Av.)</label>
                                <input type="text" id="endereco" class="form-input">
                            </div>
                            <div>
                                <label for="numero" class="form-label">N°</label>
                                <input type="text" id="numero" class="form-input">
                            </div>
                             <div>
                                <label for="bairro" class="form-label">Bairro</label>
                                <input type="text" id="bairro" class="form-input">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 gap-4 mt-4 md:grid-cols-3">
                            <div>
                                <label for="cep" class="form-label">CEP</label>
                                <input type="text" id="cep" class="form-input">
                            </div>
                            <div>
                                <label for="cidade" class="form-label">Cidade</label>
                                <input type="text" id="cidade" class="form-input">
                            </div>
                            <div>
                                <label for="telefone" class="form-label">Telefone</label>
                                <input type="tel" id="telefone" class="form-input">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 gap-4 mt-4 md:grid-cols-3">
                            <div>
                                <label for="profissao" class="form-label">Profissão</label>
                                <input type="text" id="profissao" class="form-input">
                            </div>
                            <div>
                                <label class="form-label">Empregado?</label>
                                <select id="empregado" class="form-select">
                                    <option value="Sim">Sim</option>
                                    <option value="Não">Não</option>
                                </select>
                            </div>
                            <div>
                                <label for="estadoCivil" class="form-label">Estado Civil</label>
                                <input type="text" id="estadoCivil" class="form-input">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 gap-4 mt-4 md:grid-cols-4">
                            <div>
                                <label for="rg" class="form-label">RG</label>
                                <input type="text" id="rg" class="form-input" required>
                            </div>
                            <div>
                                <label for="cpf" class="form-label">CPF</label>
                                <input type="text" id="cpf" class="form-input" required>
                            </div>
                            <div>
                                <label for="titulo" class="form-label">Título</label>
                                <input type="text" id="titulo" class="form-input">
                            </div>
                            <div>
                                <label for="secao" class="form-label">Seção</label>
                                <input type="text" id="secao" class="form-input">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 gap-4 mt-4 md:grid-cols-2">
                             <div>
                                <label class="form-label">Mora em casa própria?</label>
                                <select id="casaPropria" class="form-select">
                                    <option value="Sim">Sim</option>
                                    <option value="Não">Não</option>
                                </select>
                            </div>
                            <div>
                                <label for="zona" class="form-label">Zona (Eleitoral)</label>
                                <input type="text" id="zona" class="form-input">
                            </div>
                        </div>
                    </fieldset>
                    
                    <!-- Seção 3: Medidas e Uploads -->
                    <fieldset class="p-4 border rounded-lg">
                        <legend class="px-2 text-lg font-bold text-gray-800">Medidas e Arquivos</legend>
                        <div>
                            <label class="form-label">Medida da Camisa</label>
                            <div class="flex flex-wrap gap-4 mt-2">
                                <label><input type="radio" name="camisa" value="PP" class="text-pink-600 focus:ring-pink-500"> PP</label>
                                <label><input type="radio" name="camisa" value="P" class="text-pink-600 focus:ring-pink-500"> P</label>
                                <label><input type="radio" name="camisa" value="M" class="text-pink-600 focus:ring-pink-500"> M</label>
                                <label><input type="radio" name="camisa" value="G" class="text-pink-600 focus:ring-pink-500"> G</label>
                                <label><input type="radio" name="camisa" value="GG" class="text-pink-600 focus:ring-pink-500"> GG</label>
                                <div>
                                    <label><input type="radio" name="camisa" value="Outro" class="text-pink-600 focus:ring-pink-500"> Outro:</label>
                                    <input type="text" id="camisaOutro" class="form-input inline-block w-auto ml-2" placeholder="Especifique">
                                </div>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 gap-4 mt-4 md:grid-cols-2">
                            <div>
                                <label for="uploadFoto" class="form-label">Sua Foto (3x4) - *Opcional*</label>
                                <!-- Storage não está configurado, upload não funcionará sem regras -->
                                <input type="file" id="uploadFoto" class="form-input" accept="image/*">
                                <span class="text-xs text-gray-500">Para identificação. (Upload desabilitado temporariamente)</span>
                            </div>
                            <div>
                                <label for="uploadRG" class="form-label">Documento RG (Frente e Verso) - *Opcional*</label>
                                <!-- Storage não está configurado, upload não funcionará sem regras -->
                                <input type="file" id="uploadRG" class="form-input" accept="image/*,application/pdf">
                                <span class="text-xs text-gray-500">Pode ser foto ou PDF. (Upload desabilitado temporariamente)</span>
                            </div>
                        </div>
                    </fieldset>

                    <!-- Seção 4: Histórico Patológico -->
                    <fieldset class="p-4 border rounded-lg">
                        <legend class="px-2 text-lg font-bold text-gray-800">Histórico Patológico (Saúde)</legend>
                        <div class="grid grid-cols-1 gap-y-4 gap-x-6 md:grid-cols-3">
                            <!-- Helper para criar Sim/Não -->
                            <script>
                                // Este script é apenas para o template, não é executável aqui
                                const healthQuestions = [
                                    { id: 'bebidaAlcoolica', label: 'Faz uso de bebida alcoólica?' },
                                    { id: 'fumante', label: 'É fumante?' },
                                    { id: 'doadorSangue', label: 'Doador de sangue?' },
                                    { id: 'cardiaco', label: 'Cardíaco?' },
                                    { id: 'hipertenso', label: 'Hipertenso?' },
                                    { id: 'diabetico', label: 'Diabético?' },
                                    { id: 'epiletico', label: 'É epilético(a)?' }
                                ];
                            </script>
                            
                            <!-- Perguntas Sim/Não -->
                            <template id="health-question-template">
                                <div>
                                    <label class="form-label"></label>
                                    <select class="form-select">
                                        <option value="Não" selected>Não</option>
                                        <option value="Sim">Sim</option>
                                    </select>
                                </div>
                            </template>

                            <div id="health-questions-container" class="contents"></div>

                            <!-- Perguntas com "QUAL" -->
                            <div>
                                <label for="tipoSanguineo" class="form-label">Tipo Sanguíneo</label>
                                <input type="text" id="tipoSanguineo" class="form-input">
                            </div>
                            
                            <div class="md:col-span-2">
                                <label for="alergias" class="form-label">Alergias?</label>
                                <div class="flex gap-2">
                                    <select id="alergias" class="form-select w-1/3">
                                        <option value="Não" selected>Não</option>
                                        <option value="Sim">Sim</option>
                                    </select>
                                    <input type="text" id="alergiasQual" class="form-input w-2/3" placeholder="Qual?">
                                </div>
                            </div>
                            <div class="md:col-span-2">
                                <label for="cirurgiaRecente" class="form-label">Cirurgia recente?</label>
                                <div class="flex gap-2">
                                    <select id="cirurgiaRecente" class="form-select w-1/3">
                                        <option value="Não" selected>Não</option>
                                        <option value="Sim">Sim</option>
                                    </select>
                                    <input type="text" id="cirurgiaRecenteQual" class="form-input w-2/3" placeholder="Qual?">
                                </div>
                            </div>
                            <div class="md:col-span-2">
                                <label for="tratamentoMedico" class="form-label">Está em tratamento médico?</label>
                                <div class="flex gap-2">
                                    <select id="tratamentoMedico" class="form-select w-1/3">
                                        <option value="Não" selected>Não</option>
                                        <option value="Sim">Sim</option>
                                    </select>
                                    <input type="text" id="tratamentoMedicoQual" class="form-input w-2/3" placeholder="Qual?">
                                </div>
                            </div>
                            <div class="md:col-span-2">
                                <label for="tomaMedicamento" class="form-label">Toma algum medicamento?</label>
                                <div class="flex gap-2">
                                    <select id="tomaMedicamento" class="form-select w-1/3">
                                        <option value="Não" selected>Não</option>
                                        <option value="Sim">Sim</option>
                                    </select>
                                    <input type="text" id="tomaMedicamentoQual" class="form-input w-2/3" placeholder="Qual?">
                                </div>
                            </div>
                            <div class="md:col-span-2">
                                <label for="problemaOrtopedico" class="form-label">Problema Ortopédico?</label>
                                <div class="flex gap-2">
                                    <select id="problemaOrtopedico" class="form-select w-1/3">
                                        <option value="Não" selected>Não</option>
                                        <option value="Sim">Sim</option>
                                    </select>
                                    <input type="text" id="problemaOrtopedicoQual" class="form-input w-2/3" placeholder="Qual?">
                                </div>
                            </div>
                        </div>
                    </fieldset>

                    <!-- Botões de Ação -->
                    <div class="flex flex-col gap-4 md:flex-row md:justify-between">
                        <button type="button" id="back-to-login-btn" class="btn-zumba-secondary">
                            Voltar para o Login
                        </button>
                        <button type="submit" id="submit-register-btn" class="btn-zumba-alt">
                            <span id="submit-text">Enviar Inscrição</span>
                            <span id="submit-loading" class="hidden-section">Enviando...</span>
                        </button>
                    </div>
                    <p id="register-message" class="text-sm text-center"></p>

                </form>
            </div>
        </section>

        <!-- ===== PAINEL DO ADMIN ===== -->
        <section id="admin-panel" class="hidden-section space-y-8">
            <!-- Header do Admin -->
            <header class="flex flex-col items-center justify-between p-6 bg-white rounded-lg shadow-lg md:flex-row zumba-gradient">
                <h1 class="text-3xl font-black text-white">Painel de Administração</h1>
                <button id="admin-logout-btn" class="px-4 py-2 mt-4 font-semibold text-pink-600 bg-white rounded-lg shadow-md md:mt-0 hover:bg-gray-100">
                    Sair
                </button>
            </header>

            <!-- Seção: Inscrições Pendentes -->
            <div class="p-6 bg-white rounded-lg shadow-lg">
                <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between pb-4 border-b border-gray-200">
                    <h2 class="text-2xl font-bold">Inscrições Pendentes</h2>
                    <div class="flex gap-2 flex-col md:flex-row">
                        <input id="admin-search" type="text" class="form-input md:w-64" placeholder="Buscar por nome, email, CPF, cidade">
                        <select id="admin-sort" class="form-select md:w-48">
                            <option value="date_desc" selected>Ordenar: Data (recente)</option>
                            <option value="date_asc">Ordenar: Data (antiga)</option>
                            <option value="name_asc">Ordenar: Nome (A→Z)</option>
                            <option value="name_desc">Ordenar: Nome (Z→A)</option>
                        </select>
                    </div>
                </div>
                <div id="pending-registrations-list" class="mt-4 space-y-4">
                    <!-- Inscrições pendentes serão injetadas aqui -->
                    <p id="no-pending-message">Não há inscrições pendentes no momento.</p>
                </div>
            </div>

            <!-- Seção: Gerador de Relatórios -->
            <div class="p-6 bg-white rounded-lg shadow-lg">
                <h2 class="pb-4 text-2xl font-bold border-b border-gray-200">Gerador de Relatórios</h2>
                <div class="mt-4 space-y-4">
                    <p>Selecione os campos e filtros do relatório:</p>

                    <!-- Filtros -->
                    <div class="grid grid-cols-1 gap-4 md:grid-cols-4">
                        <div>
                            <label class="form-label" for="report-status-filter">Status</label>
                            <select id="report-status-filter" class="form-select">
                                <option value="approved" selected>Aprovados</option>
                                <option value="pending">Pendentes</option>
                                <option value="rejected">Rejeitados</option>
                                <option value="all">Todos</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label" for="report-date-start">Data início (criação)</label>
                            <input type="date" id="report-date-start" class="form-input">
                        </div>
                        <div>
                            <label class="form-label" for="report-date-end">Data fim (criação)</label>
                            <input type="date" id="report-date-end" class="form-input">
                        </div>
                        <div>
                            <label class="form-label" for="report-city-filter">Cidade</label>
                            <input type="text" id="report-city-filter" class="form-input" placeholder="Filtrar por cidade">
                        </div>
                    </div>
                    
                    <!-- Checkboxes dos Campos -->
                    <div id="report-fields" class="grid grid-cols-2 gap-2 md:grid-cols-4 lg:grid-cols-6">
                        <!-- Campos para o relatório -->
                        <label class="flex items-center"><input type="checkbox" value="nome" class="mr-2 rounded text-pink-500"> Nome</label>
                        <label class="flex items-center"><input type="checkbox" value="idade" class="mr-2 rounded text-pink-500"> Idade</label>
                        <label class="flex items-center"><input type="checkbox" value="telefone" class="mr-2 rounded text-pink-500"> Telefone</label>
                        <label class="flex items-center"><input type="checkbox" value="tipoSanguineo" class="mr-2 rounded text-pink-500"> Tipo Sanguíneo</label>
                        <label class="flex items-center"><input type="checkbox" value="polo" class="mr-2 rounded text-pink-500"> Polo</label>
                        <label class="flex items-center"><input type="checkbox" value="sexo" class="mr-2 rounded text-pink-500"> Sexo</label>
                        <label class="flex items-center"><input type="checkbox" value="bairro" class="mr-2 rounded text-pink-500"> Bairro</label>
                        <label class="flex items-center"><input type="checkbox" value="cidade" class="mr-2 rounded text-pink-500"> Cidade</label>
                        <label class="flex items-center"><input type="checkbox" value="camisa" class="mr-2 rounded text-pink-500"> Tam. Camisa</label>
                        <label class="flex items-center"><input type="checkbox" value="hipertenso" class="mr-2 rounded text-pink-500"> Hipertenso</label>
                        <label class="flex items-center"><input type="checkbox" value="diabetico" class="mr-2 rounded text-pink-500"> Diabético</label>
                        <label class="flex items-center"><input type="checkbox" value="cardiaco" class="mr-2 rounded text-pink-500"> Cardíaco</label>
                        <label class="flex items-center"><input type="checkbox" value="cpf" class="mr-2 rounded text-pink-500"> CPF</label>
                        <label class="flex items-center"><input type="checkbox" value="rg" class="mr-2 rounded text-pink-500"> RG</label>
                        <label class="flex items-center"><input type="checkbox" value="estadoCivil" class="mr-2 rounded text-pink-500"> Estado Civil</label>
                        <label class="flex items-center"><input type="checkbox" value="profissao" class="mr-2 rounded text-pink-500"> Profissão</label>
                        <label class="flex items-center"><input type="checkbox" value="empregado" class="mr-2 rounded text-pink-500"> Empregado</label>
                        <label class="flex items-center"><input type="checkbox" value="epiletico" class="mr-2 rounded text-pink-500"> Epiléptico</label>
                        <label class="flex items-center"><input type="checkbox" value="cep" class="mr-2 rounded text-pink-500"> CEP</label>
                    </div>

                    <button id="generate-report-btn" class="btn-zumba">Gerar Relatório</button>

                    <!-- Resultados do Relatório -->
                    <div id="report-results-container" class="hidden-section mt-6">
                        <h3 class="text-xl font-semibold">Resultados do Relatório</h3>
                        <div class="mt-2 overflow-x-auto">
                            <table id="report-table" class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50" id="report-table-head">
                                    <!-- Cabeçalho da tabela gerado via JS -->
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200" id="report-table-body">
                                    <!-- Linhas da tabela geradas via JS -->
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-4 flex gap-2 flex-wrap">
                            <button id="export-csv-btn" class="btn-zumba-secondary">Exportar CSV</button>
                            <button id="export-xlsx-btn" class="btn-zumba-secondary">Exportar XLSX</button>
                            <button id="export-pdf-btn" class="btn-zumba-secondary">Exportar PDF</button>
                        </div>
                    </div>
                </div>
            </div>
            
             <!-- Seção: Cadastros Rejeitados -->
            <div class="p-6 bg-white rounded-lg shadow-lg">
                <h2 class="pb-4 text-2xl font-bold border-b border-gray-200 text-red-600">Cadastros Rejeitados</h2>
                <div id="rejected-registrations-list" class="mt-4 space-y-4">
                    <!-- Cadastros rejeitados serão injetados aqui -->
                    <p id="no-rejected-message">Não há cadastros rejeitados.</p>
                </div>
            </div>

        </section>


        <!-- ===== MODAL DE DETALHES/EDIÇÃO ===== -->
        <div id="details-modal" aria-labelledby="modal-title" role="dialog" aria-modal="true">
            <div class="transform w-full max-w-4xl p-6 mx-4 bg-white rounded-2xl shadow-xl transition-all sm:mx-0">
                <div class="flex items-start justify-between">
                    <h2 class="text-2xl font-bold text-gray-900" id="modal-title">Detalhes da Inscrição</h2>
                    <button id="close-modal-btn" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>
                
                <div class="mt-4 max-h-[70vh] overflow-y-auto pr-2">
                    <!-- Conteúdo do modal (formulário de edição) -->
                    <!-- Usaremos o mesmo formulário de cadastro, mas com ID "edit-" -->
                    <form id="edit-form" class="space-y-6">
                        <input type="hidden" id="edit-doc-id">
                        
                        <div class="flex flex-col items-center gap-4 md:flex-row">
                            <img id="edit-foto-preview" src="https://placehold.co/150x150/e0e0e0/7c7c7c?text=Foto" alt="Foto do Perfil" class="object-cover w-32 h-32 rounded-lg shadow-md">
                            <div class="flex-1">
                                <a id="edit-rg-link" href="#" target="_blank" class="block w-full text-center btn-zumba-secondary">Ver Documento RG (Upload desabilitado)</a>
                                <div class="mt-4">
                                     <label for="edit-status" class="form-label">Status da Inscrição</label>
                                     <select id="edit-status" class="form-select">
                                        <option value="pending">Pendente</option>
                                        <option value="approved">Aprovado</option>
                                        <option value="rejected">Rejeitado</option>
                                     </select>
                                </div>
                            </div>
                        </div>

                        <!-- Seção 1: Dados Iniciais -->
                        <fieldset class="p-4 border rounded-lg">
                            <legend class="px-2 text-lg font-bold text-gray-800">Identificação</legend>
                            <div class="grid grid-cols-1 gap-4 md:grid-cols-3">
                                <div><label for="edit-polo" class="form-label">Polo</label><input type="text" id="edit-polo" class="form-input"></div>
                                <div><label for="edit-inscricao" class="form-label">N° Inscrição</label><input type="text" id="edit-inscricao" class="form-input"></div>
                                <div><label for="edit-data" class="form-label">Data</label><input type="date" id="edit-data" class="form-input"></div>
                            </div>
                        </fieldset>

                        <!-- Seção 2: Dados Pessoais -->
                        <fieldset class="p-4 border rounded-lg">
                            <legend class="px-2 text-lg font-bold text-gray-800">Dados Pessoais</legend>
                            <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
                                <div><label for="edit-nome" class="form-label">Nome</label><input type="text" id="edit-nome" class="form-input"></div>
                                <div>
                                    <label class="form-label">Sexo</label>
                                    <div class="flex items-center mt-2 space-x-4">
                                        <label><input type="radio" name="edit-sexo" value="Masculino" class="text-pink-600"> Mas.</label>
                                        <label><input type="radio" name="edit-sexo" value="Feminino" class="text-pink-600"> Fem.</label>
                                    </div>
                                </div>
                                <div><label for="edit-dataNascimento" class="form-label">Data Nasc.</label><input type="date" id="edit-dataNascimento" class="form-input"></div>
                                <div><label for="edit-idade" class="form-label">Idade</label><input type="number" id="edit-idade" class="form-input"></div>
                            </div>
                            <div class="grid grid-cols-1 gap-4 mt-4 md:grid-cols-3">
                                <div><label for="edit-endereco" class="form-label">Endereço</label><input type="text" id="edit-endereco" class="form-input"></div>
                                <div><label for="edit-numero" class="form-label">N°</label><input type="text" id="edit-numero" class="form-input"></div>
                                <div><label for="edit-bairro" class="form-label">Bairro</label><input type="text" id="edit-bairro" class="form-input"></div>
                            </div>
                            <div class="grid grid-cols-1 gap-4 mt-4 md:grid-cols-3">
                                <div><label for="edit-cep" class="form-label">CEP</label><input type="text" id="edit-cep" class="form-input"></div>
                                <div><label for="edit-cidade" class="form-label">Cidade</label><input type="text" id="edit-cidade" class="form-input"></div>
                                <div><label for="edit-telefone" class="form-label">Telefone</label><input type="tel" id="edit-telefone" class="form-input"></div>
                            </div>
                            <div class="grid grid-cols-1 gap-4 mt-4 md:grid-cols-3">
                                <div><label for="edit-profissao" class="form-label">Profissão</label><input type="text" id="edit-profissao" class="form-input"></div>
                                <div><label class="form-label">Empregado?</label><select id="edit-empregado" class="form-select"><option value="Sim">Sim</option><option value="Não">Não</option></select></div>
                                <div><label for="edit-estadoCivil" class="form-label">Estado Civil</label><input type="text" id="edit-estadoCivil" class="form-input"></div>
                            </div>
                            <div class="grid grid-cols-1 gap-4 mt-4 md:grid-cols-4">
                                <div><label for="edit-rg" class="form-label">RG</label><input type="text" id="edit-rg" class="form-input"></div>
                                <div><label for="edit-cpf" class="form-label">CPF</label><input type="text" id="edit-cpf" class="form-input"></div>
                                <div><label for="edit-titulo" class="form-label">Título</label><input type="text" id="edit-titulo" class="form-input"></div>
                                <div><label for="edit-secao" class="form-label">Seção</label><input type="text" id="edit-secao" class="form-input"></div>
                            </div>
                            <div class="grid grid-cols-1 gap-4 mt-4 md:grid-cols-2">
                                <div><label class="form-label">Casa Própria?</label><select id="edit-casaPropria" class="form-select"><option value="Sim">Sim</option><option value="Não">Não</option></select></div>
                                <div><label for="edit-zona" class="form-label">Zona</label><input type="text" id="edit-zona" class="form-input"></div>
                            </div>
                        </fieldset>

                        <!-- Seção 3: Medidas -->
                        <fieldset class="p-4 border rounded-lg">
                            <legend class="px-2 text-lg font-bold text-gray-800">Medidas</legend>
                            <label class="form-label">Medida da Camisa</label>
                            <div class="flex flex-wrap gap-4 mt-2">
                                <label><input type="radio" name="edit-camisa" value="PP" class="text-pink-600"> PP</label>
                                <label><input type="radio" name="edit-camisa" value="P" class="text-pink-600"> P</label>
                                <label><input type="radio" name="edit-camisa" value="M" class="text-pink-600"> M</label>
                                <label><input type="radio" name="edit-camisa" value="G" class="text-pink-600"> G</label>
                                <label><input type="radio" name="edit-camisa" value="GG" class="text-pink-600"> GG</label>
                                <div>
                                    <label><input type="radio" name="edit-camisa" value="Outro" class="text-pink-600"> Outro:</label>
                                    <input type="text" id="edit-camisaOutro" class="form-input inline-block w-auto ml-2">
                                </div>
                            </div>
                        </fieldset>

                        <!-- Seção 4: Histórico Patológico -->
                        <fieldset class="p-4 border rounded-lg">
                            <legend class="px-2 text-lg font-bold text-gray-800">Histórico Patológico</legend>
                            <div class="grid grid-cols-1 gap-y-4 gap-x-6 md:grid-cols-3">
                                <!-- Perguntas Sim/Não -->
                                <div><label class="form-label">Bebida Alcoólica?</label><select id="edit-bebidaAlcoolica" class="form-select"><option value="Não">Não</option><option value="Sim">Sim</option></select></div>
                                <div><label class="form-label">Fumante?</label><select id="edit-fumante" class="form-select"><option value="Não">Não</option><option value="Sim">Sim</option></select></div>
                                <div><label class="form-label">Doador de Sangue?</label><select id="edit-doadorSangue" class="form-select"><option value="Não">Não</option><option value="Sim">Sim</option></select></div>
                                <div><label class="form-label">Cardíaco?</label><select id="edit-cardiaco" class="form-select"><option value="Não">Não</option><option value="Sim">Sim</option></select></div>
                                <div><label class="form-label">Hipertenso?</label><select id="edit-hipertenso" class="form-select"><option value="Não">Não</option><option value="Sim">Sim</option></select></div>
                                <div><label class="form-label">Diabético?</label><select id="edit-diabetico" class="form-select"><option value="Não">Não</option><option value="Sim">Sim</option></select></div>
                                <div><label class="form-label">Epilético(a)?</label><select id="edit-epiletico" class="form-select"><option value="Não">Não</option><option value="Sim">Sim</option></select></div>
                                
                                <div><label for="edit-tipoSanguineo" class="form-label">Tipo Sanguíneo</label><input type="text" id="edit-tipoSanguineo" class="form-input"></div>
                                
                                <div class="md:col-span-2"><label for="edit-alergias" class="form-label">Alergias?</label><div class="flex gap-2"><select id="edit-alergias" class="form-select w-1/3"><option value="Não">Não</option><option value="Sim">Sim</option></select><input type="text" id="edit-alergiasQual" class="form-input w-2/3" placeholder="Qual?"></div></div>
                                <div class="md:col-span-2"><label for="edit-cirurgiaRecente" class="form-label">Cirurgia recente?</label><div class="flex gap-2"><select id="edit-cirurgiaRecente" class="form-select w-1/3"><option value="Não">Não</option><option value="Sim">Sim</option></select><input type="text" id="edit-cirurgiaRecenteQual" class="form-input w-2/3" placeholder="Qual?"></div></div>
                                <div class="md:col-span-2"><label for="edit-tratamentoMedico" class="form-label">Tratamento médico?</label><div class="flex gap-2"><select id="edit-tratamentoMedico" class="form-select w-1/3"><option value="Não">Não</option><option value="Sim">Sim</option></select><input type="text" id="edit-tratamentoMedicoQual" class="form-input w-2/3" placeholder="Qual?"></div></div>
                                <div class="md:col-span-2"><label for="edit-tomaMedicamento" class="form-label">Toma medicamento?</label><div class="flex gap-2"><select id="edit-tomaMedicamento" class="form-select w-1/3"><option value="Não">Não</option><option value="Sim">Sim</option></select><input type="text" id="edit-tomaMedicamentoQual" class="form-input w-2/3" placeholder="Qual?"></div></div>
                                <div class="md:col-span-2"><label for="edit-problemaOrtopedico" class="form-label">Problema Ortopédico?</label><div class="flex gap-2"><select id="edit-problemaOrtopedico" class="form-select w-1/3"><option value="Não">Não</option><option value="Sim">Sim</option></select><input type="text" id="edit-problemaOrtopedicoQual" class="form-input w-2/3" placeholder="Qual?"></div></div>
                            </div>
                        </fieldset>
                    </form>
                </div>
                
                <!-- Botões do Modal -->
                <div class="flex justify-end gap-4 pt-4 mt-6 border-t">
                    <button id="modal-delete-btn" class="px-4 py-2 font-semibold text-white bg-red-600 rounded-lg hover:bg-red-700">Deletar Inscrição</button>
                    <button id="modal-save-btn" class="px-4 py-2 font-semibold text-white bg-green-600 rounded-lg hover:bg-green-700">Salvar Alterações</button>
                </div>
                <p id="modal-message" class="mt-2 text-sm text-center"></p>
            </div>
        </div>

    </div> <!-- Fim do Container Principal -->


    <!-- Firebase SDKs -->
    <script type="module">
        // Importações do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInWithEmailAndPassword, 
            // createUserWithEmailAndPassword, // Removido - Não é mais usado para inscrição
            signOut, 
            onAuthStateChanged,
            setPersistence,
            browserLocalPersistence // Manter usuário logado
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            doc, 
            getDoc, 
            // setDoc, // Não usado no fluxo principal
            updateDoc, 
            deleteDoc, 
            query, 
            // where, // Não usado
            onSnapshot,
            // getDocs, // Não usado
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { 
            getStorage, 
            ref, 
            uploadBytes, 
            getDownloadURL,
            deleteObject
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // ==================================================================
        // CONFIGURAÇÃO DO FIREBASE (ATUALIZADA)
        // ==================================================================
        
        // Configuração do Firebase fornecida pelo usuário
        const firebaseConfig = {
          apiKey: "AIzaSyCrH_LFHenyWx-ITRCTWeNVqf8O-0e3pJY",
          authDomain: "zumba-2a827.firebaseapp.com",
          projectId: "zumba-2a827",
          storageBucket: "zumba-2a827.firebasestorage.app",
          messagingSenderId: "325248310095",
          appId: "1:325248310095:web:2673845967b7bc60f6833a"
        };
        
        // ==================================================================
        // !! AÇÃO OBRIGATÓRIA !!
        // ==================================================================
        //
        // 1. Vá ao painel do seu projeto Firebase 'zumba-2a827'
        // 2. Vá para 'Authentication' -> 'Users'.
        // 3. Crie um usuário (ou use um existente) para ser o Administrador.
        // 4. Copie o 'User UID' desse usuário.
        // 5. COLE O UID AQUI:
        //
        const ADMIN_UID = "mNenvFEpf1SnDCY2kXLUaDlgtP03"; 
        // 
        // ==================================================================
        
        // Nome da coleção de inscrições
        const INSCRICOES_COLLECTION = "inscricoes_zumba";
        
        // ==================================================================
        // FIM DA CONFIGURAÇÃO
        // ==================================================================

        // Inicialização do Firebase
        let app, auth, db, storage;
        try {
            // VERIFICAÇÃO DO ADMIN_UID
            if (ADMIN_UID === "COLE_SEU_ADMIN_UID_AQUI" || ADMIN_UID.trim() === "") {
                throw new Error("O 'ADMIN_UID' não foi definido. Edite o arquivo index.html na linha 938.");
            }
            
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            storage = getStorage(app);
            setLogLevel('Debug'); // Para ver logs no console
            console.log("Firebase inicializado com sucesso.");
        } catch (error) {
            console.error("Erro ao inicializar o Firebase:", error);
            document.body.innerHTML = `<div class="p-8 text-center text-red-600 bg-red-100">
                <h1 class="text-2xl font-bold">Erro de Configuração do Firebase</h1>
                <p class="mt-2">Não foi possível conectar ao Firebase. Verifique se o objeto 'firebaseConfig' está correto e se o 'ADMIN_UID' foi preenchido no arquivo HTML (linha 938).</p>
                <p class="mt-1 text-sm">Abra o console (F12) para mais detalhes. (Erro: ${error.message})</p>
                </div>`;
        }


        // Referências dos Elementos DOM
        const loginView = document.getElementById('login-view');
        const registerView = document.getElementById('register-view');
        const adminPanel = document.getElementById('admin-panel');
        
        const adminLoginForm = document.getElementById('admin-login-form');
        const authError = document.getElementById('auth-error');
        const adminLogoutBtn = document.getElementById('admin-logout-btn');
        
        const goToRegisterBtn = document.getElementById('go-to-register-btn');
        const backToLoginBtn = document.getElementById('back-to-login-btn');
        
        const registerForm = document.getElementById('register-form');
        const registerMessage = document.getElementById('register-message');
        const submitRegisterBtn = document.getElementById('submit-register-btn');
        const dataNascimentoInput = document.getElementById('dataNascimento');
        const idadeInput = document.getElementById('idade');
        const inscricaoInput = document.getElementById('inscricao');
        
        const pendingList = document.getElementById('pending-registrations-list');
        const noPendingMsg = document.getElementById('no-pending-message');
        const rejectedList = document.getElementById('rejected-registrations-list');
        const noRejectedMsg = document.getElementById('no-rejected-message');

        const detailsModal = document.getElementById('details-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const modalSaveBtn = document.getElementById('modal-save-btn');
        const modalDeleteBtn = document.getElementById('modal-delete-btn');
        const modalMessage = document.getElementById('modal-message');
        
        const reportFields = document.getElementById('report-fields');
        const generateReportBtn = document.getElementById('generate-report-btn');
        const reportResultsContainer = document.getElementById('report-results-container');
        const reportTableHead = document.getElementById('report-table-head');
        const reportTableBody = document.getElementById('report-table-body');
        const exportCsvBtn = document.getElementById('export-csv-btn');
        const exportXlsxBtn = document.getElementById('export-xlsx-btn');
        const exportPdfBtn = document.getElementById('export-pdf-btn');
        const statusFilter = document.getElementById('report-status-filter');
        const dateStartInput = document.getElementById('report-date-start');
        const dateEndInput = document.getElementById('report-date-end');
        const cityFilterInput = document.getElementById('report-city-filter');
        let lastReportData = { headers: [], rows: [] };

        // =================================================
        // Lógica de Navegação e Helpers
        // =================================================

        const showView = (viewId) => {
            [loginView, registerView, adminPanel].forEach(view => {
                view.classList.add('hidden-section');
            });
            document.getElementById(viewId).classList.remove('hidden-section');
            
            // Se for para a tela de registro, gera o número de inscrição
            if (viewId === 'register-view') {
                 generateInscricaoNumber();
            }
        };

        // Geração automática do N° Inscrição (Exemplo: Z241112-XXXX)
        function generateInscricaoNumber() {
            const date = new Date();
            const year = String(date.getFullYear()).slice(-2);
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const random = Math.floor(100 + Math.random() * 900); // Número de 3 dígitos
            inscricaoInput.value = `Z${year}${month}${day}-${random}`;
        }

        // Cálculo automático da Idade
        function calculateAge() {
            const birthDateStr = dataNascimentoInput.value;
            if (birthDateStr) {
                const today = new Date();
                const birthDate = new Date(birthDateStr);
                let age = today.getFullYear() - birthDate.getFullYear();
                const m = today.getMonth() - birthDate.getMonth();

                if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
                    age--;
                }
                idadeInput.value = age;
            } else {
                idadeInput.value = '';
            }
        }
        
        // Listener para calcular idade
        dataNascimentoInput.addEventListener('change', calculateAge);


        goToRegisterBtn.addEventListener('click', () => showView('register-view'));
        backToLoginBtn.addEventListener('click', () => showView('login-view'));

        // =================================================
        // Lógica de Autenticação
        // =================================================

        // Observador do estado de autenticação
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // Usuário está logado
                if (user.uid === ADMIN_UID) {
                    // É o Admin
                    console.log("Admin logado:", user.uid);
                    showView('admin-panel');
                    loadAdminPanelData();
                } else {
                    // É um usuário comum (deve ser deslogado)
                    console.log("Usuário comum logado, deslogando:", user.uid);
                    signOut(auth);
                    showView('login-view');
                }
            } else {
                // Usuário está deslogado
                console.log("Nenhum usuário logado.");
                showView('login-view');
            }
        });

        // Login do Admin
        adminLoginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('admin-email').value;
            const password = document.getElementById('admin-password').value;
            authError.textContent = '';

            try {
                // Manter o admin logado
                await setPersistence(auth, browserLocalPersistence);
                await signInWithEmailAndPassword(auth, email, password);
                // O onAuthStateChanged vai cuidar de redirecionar
            } catch (error) {
                console.error("Erro no login:", error.message);
                authError.textContent = 'Email ou senha inválidos.';
            }
        });

        // Logout do Admin
        adminLogoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
                // O onAuthStateChanged vai cuidar de redirecionar
            } catch (error) {
                console.error("Erro no logout:", error.message);
            }
        });

        // =================================================
        // Lógica de Cadastro do Usuário (Simplificada)
        // =================================================

        // Gerar campos de saúde
        const healthContainer = document.getElementById('health-questions-container');
        const healthTemplate = document.getElementById('health-question-template');
        const healthQuestions = [
            { id: 'bebidaAlcoolica', label: 'Faz uso de bebida alcoólica?' },
            { id: 'fumante', label: 'É fumante?' },
            { id: 'doadorSangue', label: 'Doador de sangue?' },
            { id: 'cardiaco', label: 'Cardíaco?' },
            { id: 'hipertenso', label: 'Hipertenso?' },
            { id: 'diabetico', label: 'Diabético?' },
            { id: 'epiletico', label: 'É epilético(a)?' }
        ];
        
        healthQuestions.forEach(q => {
            const clone = healthTemplate.content.cloneNode(true);
            clone.querySelector('label').textContent = q.label;
            clone.querySelector('select').id = q.id;
            healthContainer.appendChild(clone);
        });


        // Envio do Formulário de Cadastro (SEM AUTENTICAÇÃO DE USUÁRIO)
        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            setRegisterLoading(true);
            registerMessage.textContent = '';

            // const fotoFile = document.getElementById('uploadFoto').files[0]; // Desabilitado
            // const rgFile = document.getElementById('uploadRG').files[0]; // Desabilitado
            
            try {
                // O upload de arquivos (Storage) não está sendo feito,
                // pois requer regras de segurança específicas e o código
                // original também não estava completando essa etapa.
                
                /*
                let photoURL = null;
                let rgURL = null;
                if (fotoFile) { ... }
                if (rgFile) { ... }
                */

                // 1. Coletar dados do formulário
                const formData = getAllFormData('register-form');
                formData.photoURL = null; // Upload desabilitado
                formData.rgURL = null;    // Upload desabilitado
                formData.userId = null;   // Inscrição anônima
                formData.status = 'pending';
                formData.email = null;    // Inscrição anônima
                formData.createdAt = new Date().toISOString();

                // 2. Salvar no Firestore
                // (As novas regras de segurança permitirão esta escrita)
                console.log("Tentando salvar no Firestore (anônimo) na coleção:", INSCRICOES_COLLECTION);
                const docRef = await addDoc(collection(db, INSCRICOES_COLLECTION), formData);
                
                console.log("Inscrição enviada com ID:", docRef.id);
                setRegisterLoading(false);
                registerMessage.textContent = 'Inscrição enviada com sucesso! O administrador irá analisar seu cadastro.';
                registerMessage.className = 'text-sm text-center text-green-600';
                registerForm.reset();
                
                // Mostrar mensagem e voltar para o login
                setTimeout(() => {
                    showView('login-view'); 
                }, 3000); // Espera 3 segundos para o usuário ler a msg

            } catch (error) {
                console.error("Erro ao enviar inscrição:", error);
                setRegisterLoading(false);

                // Diagnóstico para o problema de permissão no Firestore
                if (error.code && error.code.includes('permission-denied')) {
                     registerMessage.textContent = `Erro de Permissão (Firestore). Verifique se você aplicou as novas Regras de Segurança do Firebase para a coleção "${INSCRICOES_COLLECTION}" (allow create: if true;).`;
                } else {
                    registerMessage.textContent = `Erro ao enviar inscrição: ${error.message}`;
                }
                registerMessage.className = 'text-sm text-center text-red-500';
            }
        });
        
        function setRegisterLoading(isLoading) {
            const submitText = document.getElementById('submit-text');
            const submitLoading = document.getElementById('submit-loading');
            if (isLoading) {
                submitRegisterBtn.disabled = true;
                submitText.classList.add('hidden-section');
                submitLoading.classList.remove('hidden-section');
            } else {
                submitRegisterBtn.disabled = false;
                submitText.classList.remove('hidden-section');
                submitLoading.classList.add('hidden-section');
            }
        }
        
        // Função helper para pegar todos os dados de um formulário
        function getAllFormData(formId) {
            const form = document.getElementById(formId);
            const formData = new FormData(form);
            const data = {};
            
            // Inputs de texto, número, data, select
            form.querySelectorAll('input, select').forEach(input => {
                if (input.type === 'radio' || input.type === 'checkbox' || input.type === 'file') return; // Handled below or ignored
                if (input.id) {
                     // Remove 'edit-' prefix if present
                    const key = input.id.startsWith('edit-') ? input.id.substring(5) : input.id;
                    if (key) data[key] = input.value;
                }
            });

            // Radio buttons
            form.querySelectorAll('input[type="radio"]:checked').forEach(radio => {
                const key = radio.name.startsWith('edit-') ? radio.name.substring(5) : radio.name;
                if (key === 'camisa' && radio.value === 'Outro') {
                     const outroId = formId === 'edit-form' ? 'edit-camisaOutro' : 'camisaOutro';
                     data[key] = document.getElementById(outroId).value || 'Outro';
                } else {
                    data[key] = radio.value;
                }
            });
            
            // Ajuste para campos com "Qual"
            ['alergias', 'cirurgiaRecente', 'tratamentoMedico', 'tomaMedicamento', 'problemaOrtopedico'].forEach(key => {
                const prefix = formId === 'edit-form' ? 'edit-' : '';
                const selectValue = data[key]; // Já deve ter pego o Sim/Não
                if (selectValue === 'Sim') {
                    const qualValue = document.getElementById(`${prefix}${key}Qual`).value;
                    data[key] = `Sim (${qualValue || 'N/A'})`;
                }
            });
            
            // Limpar campos "Qual" desnecessários
            ['alergiasQual', 'cirurgiaRecenteQual', 'tratamentoMedicoQual', 'tomaMedicamentoQual', 'problemaOrtopedicoQual', 'camisaOutro'].forEach(key => {
                 delete data[key];
                 delete data[`edit-${key}`]; // Limpar a chave com prefixo também
            });

            return data;
        }


        // =================================================
        // Lógica do Painel Admin
        // =================================================
        
        let allRegistrations = []; // Cache para relatórios
        let allRegistrationsUnsubscribe = null; // Listener do Firestore
        const adminSearchInput = document.getElementById('admin-search');
        const adminSortSelect = document.getElementById('admin-sort');

        function loadAdminPanelData() {
            // Limpar listeners antigos se existirem
            if (allRegistrationsUnsubscribe) {
                allRegistrationsUnsubscribe();
            }

            const registrationsCol = collection(db, INSCRICOES_COLLECTION);
            
            // Listener para TODAS as inscrições
            allRegistrationsUnsubscribe = onSnapshot(registrationsCol, (snapshot) => {
                allRegistrations = []; // Limpar cache
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const docId = doc.id;
                    allRegistrations.push({ id: docId, ...data });
                });
                renderAdminLists();
            }, (error) => {
                console.error("Erro ao carregar inscrições: Permissão de Leitura (READ) negada.", error);
                pendingList.innerHTML = `<p class="text-red-500 font-bold">Erro ao carregar dados. Verifique as Regras de Segurança do Firebase para a permissão de leitura (READ) do administrador (request.auth != null) na coleção "${INSCRICOES_COLLECTION}".</p>`;
            });
        }

        function renderAdminLists() {
            const q = (adminSearchInput?.value || '').toLowerCase().trim();
            const sort = adminSortSelect?.value || 'date_desc';

            const pending = [];
            const rejected = [];

            const matchesQuery = (d) => {
                if (!q) return true;
                const pool = [d.nome, d.email, d.cpf, d.cidade].map(v => (v || '').toLowerCase());
                return pool.some(v => v.includes(q));
            };

            const sorted = allRegistrations.slice().sort((a,b) => {
                if (sort === 'name_asc') return (a.nome||'').localeCompare(b.nome||'');
                if (sort === 'name_desc') return (b.nome||'').localeCompare(a.nome||'');
                const ad = a.createdAt ? new Date(a.createdAt).getTime() : 0;
                const bd = b.createdAt ? new Date(b.createdAt).getTime() : 0;
                return sort === 'date_asc' ? ad - bd : bd - ad;
            });

            sorted.forEach(({id, ...data}) => {
                if (!matchesQuery(data)) return;
                const cardHtml = `
                    <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg shadow-sm border">
                        <div>
                            <p class="font-bold text-lg">${data.nome || 'Nome não informado'}</p>
                            <p class="text-sm text-gray-600">${data.cpf || data.rg || 'Sem documento'}</p>
                            <p class="text-xs text-gray-500">Enviado em: ${data.createdAt ? new Date(data.createdAt).toLocaleDateString() : 'N/A'}</p>
                        </div>
                        <div class="flex gap-2">
                            <button data-id="${id}" class="view-btn btn-zumba-secondary text-sm !px-3 !py-1">Ver/Editar</button>
                            ${data.status === 'pending' ? `<button data-id="${id}" class="approve-btn btn-zumba-alt text-sm !px-3 !py-1">Aprovar</button>` : ''}
                            ${data.status !== 'rejected' ? `<button data-id="${id}" class="reject-btn btn-zumba text-sm !px-3 !py-1">Rejeitar</button>` : ''}
                            ${data.status === 'rejected' ? `<button data-id="${id}" class="approve-btn btn-zumba-alt text-sm !px-3 !py-1">Re-Aprovar</button>` : ''}
                        </div>
                    </div>
                `;
                if (data.status === 'pending') pending.push(cardHtml);
                else if (data.status === 'rejected') rejected.push(cardHtml);
            });

            if (pending.length) {
                pendingList.innerHTML = pending.join('');
                noPendingMsg.classList.add('hidden-section');
            } else {
                pendingList.innerHTML = '';
                noPendingMsg.classList.remove('hidden-section');
            }

            if (rejected.length) {
                rejectedList.innerHTML = rejected.join('');
                noRejectedMsg.classList.add('hidden-section');
            } else {
                rejectedList.innerHTML = '';
                noRejectedMsg.classList.remove('hidden-section');
            }
        }

        adminSearchInput?.addEventListener('input', renderAdminLists);
        adminSortSelect?.addEventListener('change', renderAdminLists);
        
        // Ações dos botões (Aprovar, Rejeitar, Ver)
        document.addEventListener('click', async (e) => {
            const target = e.target;
            const docId = target.dataset.id;
            
            if (!docId) return;

             // Usar modal customizado ao invés de alert/confirm
            const showMessage = (msg, isError = false) => {
                const modal = document.getElementById('details-modal');
                const p = document.createElement('p');
                p.textContent = msg;
                p.className = `mt-2 text-sm text-center ${isError ? 'text-red-500' : 'text-green-600'}`;
                modal.querySelector('.transform').appendChild(p);
                setTimeout(() => p.remove(), 3000);
            };
            
            // (Substituindo window.confirm por um modal customizado se necessário)
            // Usando window.confirm por simplicidade, já que o original usava
            const customConfirm = (message) => {
                 // Esta é uma implementação simples. O ideal seria um modal.
                 return window.confirm(message);
            }

            // Aprovar
            if (target.classList.contains('approve-btn')) {
                if (customConfirm('Tem certeza que deseja APROVAR esta inscrição?')) {
                    try {
                        const docRef = doc(db, INSCRICOES_COLLECTION, docId);
                        await updateDoc(docRef, { status: "approved" });
                        console.log("Inscrição aprovada:", docId);
                        // showMessage("Inscrição APROVADA."); // Msg no modal não é útil se o modal não estiver aberto
                    } catch (error) {
                        console.error("Erro ao aprovar:", error);
                        // showMessage("Erro ao aprovar.", true);
                    }
                }
            }

            // Rejeitar
            if (target.classList.contains('reject-btn')) {
                 if (customConfirm('Tem certeza que deseja REJEITAR esta inscrição?')) {
                    try {
                        const docRef = doc(db, INSCRICOES_COLLECTION, docId);
                        // const snap = await getDoc(docRef); // Não é mais necessário para deletar storage
                        // const data = snap.data() || {};
                        await updateDoc(docRef, { status: "rejected" });
                        
                        // Lógica de Storage removida - não há arquivos para deletar
                        
                        console.log("Inscrição rejeitada:", docId);
                        // showMessage("Inscrição REJEITADA.", true);
                    } catch (error) {
                        console.error("Erro ao rejeitar:", error);
                        // showMessage("Erro ao rejeitar.", true);
                    }
                }
            }
            
            // Ver/Editar
            if (target.classList.contains('view-btn')) {
                openDetailsModal(docId);
            }
        });

        // =================================================
        // Lógica do Modal de Edição
        // =================================================
        
        let currentEditingDocId = null;

        async function openDetailsModal(docId) {
            currentEditingDocId = docId;
            modalMessage.textContent = '';
            
            try {
                const docRef = doc(db, INSCRICOES_COLLECTION, docId);
                const docSnap = await getDoc(docRef);

                if (!docSnap.exists()) {
                    console.error("Documento não encontrado");
                    // Substituir alert() por um método não bloqueante
                    modalMessage.textContent = "Erro: Documento não encontrado.";
                    return;
                }

                const data = docSnap.data();
                
                // Preencher o formulário de edição
                document.getElementById('edit-doc-id').value = docId;
                // Fallback para placeholder se não houver URL
                document.getElementById('edit-foto-preview').src = data.photoURL || 'https://placehold.co/150x150/e0e0e0/7c7c7c?text=Foto'; 
                document.getElementById('edit-rg-link').href = data.rgURL || '#';
                document.getElementById('edit-status').value = data.status || 'pending';

                // Preencher todos os inputs
                Object.keys(data).forEach(key => {
                    const el = document.getElementById(`edit-${key}`);
                    if (el) {
                        if (el.type === 'radio') {
                           // Handled by radio group
                        } else {
                            el.value = data[key];
                        }
                    }
                });
                
                // Preencher Radio (Sexo)
                document.querySelectorAll(`input[name="edit-sexo"]`).forEach(radio => {
                    radio.checked = (radio.value === data.sexo);
                });
                
                // Preencher Radio (Camisa)
                const camisaRadio = document.querySelector(`input[name="edit-camisa"][value="${data.camisa}"]`);
                if (camisaRadio) {
                    camisaRadio.checked = true;
                    document.getElementById('edit-camisaOutro').value = '';
                } else if (data.camisa) {
                    // É "Outro"
                    const outroRadio = document.querySelector(`input[name="edit-camisa"][value="Outro"]`);
                    if(outroRadio) outroRadio.checked = true;
                    document.getElementById('edit-camisaOutro').value = data.camisa;
                }
                
                // Preencher campos Sim/Não com "Qual"
                 ['alergias', 'cirurgiaRecente', 'tratamentoMedico', 'tomaMedicamento', 'problemaOrtopedico'].forEach(key => {
                     const elSelect = document.getElementById(`edit-${key}`);
                     const elQual = document.getElementById(`edit-${key}Qual`);
                     const value = data[key] || "Não";
                     
                     if (value.startsWith('Sim')) {
                         elSelect.value = 'Sim';
                         const qualMatch = value.match(/\(([^)]+)\)/); // Pega texto dentro de ( )
                         if (qualMatch && qualMatch[1] !== 'N/A') {
                             elQual.value = qualMatch[1];
                         } else {
                             elQual.value = '';
                         }
                     } else {
                         elSelect.value = 'Não';
                         elQual.value = '';
                     }
                 });


                // Mostrar o modal (Ajustado para display:none/flex)
                detailsModal.style.display = 'flex';
                // Timeout para permitir a transição de opacidade
                setTimeout(() => detailsModal.style.opacity = 1, 10); 

            } catch (error) {
                console.error("Erro ao abrir modal:", error);
                modalMessage.textContent = "Erro ao carregar dados para edição.";
            }
        }

        closeModalBtn.addEventListener('click', () => {
            detailsModal.style.opacity = 0;
            setTimeout(() => detailsModal.style.display = 'none', 300);
            currentEditingDocId = null;
        });
        
        // Salvar alterações do Modal
        modalSaveBtn.addEventListener('click', async () => {
            if (!currentEditingDocId) return;
            
            modalMessage.textContent = 'Salvando...';
            
            try {
                // Coletar todos os dados do formulário de edição
                const formData = getAllFormData('edit-form');
                
                // O status vem do select 'edit-status'
                formData.status = document.getElementById('edit-status').value;
                
                // Remover campos que não devem ser atualizados
                delete formData['doc-id']; 
                
                const docRef = doc(db, INSCRICOES_COLLECTION, currentEditingDocId);
                await updateDoc(docRef, formData);
                
                modalMessage.textContent = 'Salvo com sucesso!';
                modalMessage.className = 'mt-2 text-sm text-center text-green-600';
                
                setTimeout(() => {
                    closeModalBtn.click();
                }, 1000);

            } catch (error) {
                console.error("Erro ao salvar alterações:", error);
                modalMessage.textContent = 'Erro ao salvar.';
                modalMessage.className = 'mt-2 text-sm text-center text-red-500';
            }
        });
        
        // Deletar inscrição (pelo modal)
        modalDeleteBtn.addEventListener('click', async () => {
            if (!currentEditingDocId) return;
            
            if (!window.confirm('TEM CERTEZA? Esta ação é irreversível e irá deletar o cadastro permanentemente.')) {
                return;
            }
            
            modalMessage.textContent = 'Deletando...';
            
            try {
                const docRef = doc(db, INSCRICOES_COLLECTION, currentEditingDocId);
                
                // Lógica de Storage removida
                
                await deleteDoc(docRef);
                
                modalMessage.textContent = 'Deletado com sucesso!';
                setTimeout(() => {
                    closeModalBtn.click();
                }, 1000);

            } catch (error) {
                console.error("Erro ao deletar:", error);
                modalMessage.textContent = 'Erro ao deletar.';
                modalMessage.className = 'mt-2 text-sm text-center text-red-500';
            }
        });


        // =================================================
        // Lógica do Gerador de Relatórios
        // =================================================

        generateReportBtn.addEventListener('click', () => {
            const selectedFields = [];
            reportFields.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => {
                selectedFields.push(cb.value);
            });

            if (selectedFields.length === 0) {
                // Substituir alert()
                // window.alert("Por favor, selecione pelo menos um campo para o relatório.");
                console.warn("Nenhum campo selecionado para o relatório.");
                return;
            }

            // Filtros
            const status = statusFilter.value;
            const startDateStr = dateStartInput.value;
            const endDateStr = dateEndInput.value;
            const cityFilter = (cityFilterInput.value || '').trim().toLowerCase();

            let filteredUsers = allRegistrations.slice();
            if (status !== 'all') {
                filteredUsers = filteredUsers.filter(u => (u.status || 'pending') === status);
            }
            if (startDateStr) {
                const start = new Date(startDateStr);
                filteredUsers = filteredUsers.filter(u => u.createdAt ? new Date(u.createdAt) >= start : false);
            }
            if (endDateStr) {
                const end = new Date(endDateStr);
                // incluir dia inteiro
                end.setHours(23,59,59,999);
                filteredUsers = filteredUsers.filter(u => u.createdAt ? new Date(u.createdAt) <= end : false);
            }
            if (cityFilter) {
                filteredUsers = filteredUsers.filter(u => (u.cidade || '').toLowerCase().includes(cityFilter));
            }

            if (filteredUsers.length === 0) {
                reportResultsContainer.classList.remove('hidden-section');
                reportTableHead.innerHTML = '';
                reportTableBody.innerHTML = '<tr><td class="p-4" colspan="100%">Nenhum registro encontrado para os filtros selecionados.</td></tr>';
                return;
            }

            // Gerar Cabeçalho da Tabela
            let headHtml = '<tr>';
            selectedFields.forEach(field => {
                const label = reportFields.querySelector(`input[value="${field}"]`).parentElement.textContent;
                headHtml += `<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${label.trim()}</th>`;
            });
            headHtml += '</tr>';
            reportTableHead.innerHTML = headHtml;

            // Gerar Corpo da Tabela
            let bodyHtml = '';
            const rows = [];
            filteredUsers.forEach(user => {
                bodyHtml += '<tr>';
                const row = []; // Array para exportação
                selectedFields.forEach(field => {
                    const value = user[field] || 'N/A';
                    bodyHtml += `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${value}</td>`;
                    row.push(value);
                });
                bodyHtml += '</tr>';
                rows.push(row);
            });
            reportTableBody.innerHTML = bodyHtml;

            reportResultsContainer.classList.remove('hidden-section');

            // Guardar dados para exportação
            const headers = [];
            reportTableHead.querySelectorAll('th').forEach(th => headers.push(th.textContent));
            lastReportData = { headers, rows: rows };
        });
        
        // Exportar para CSV
        exportCsvBtn.addEventListener('click', () => {
            if (!lastReportData.headers.length) { console.warn('Gere o relatório antes de exportar.'); return; }
            const table = document.getElementById('report-table');
            let csv = [];
            
            // Cabeçalho
            const headers = [];
            table.querySelectorAll('thead th').forEach(th => headers.push(`"${th.textContent}"`));
            csv.push(headers.join(','));
            
            // Linhas
            lastReportData.rows.forEach(row => {
                 // Certifique-se de que cada valor é envolto em aspas e faz o escape de aspas internas
                const rowData = row.map(v => `"${String(v).replace(/"/g, '""')}"`);
                csv.push(rowData.join(','));
            });


            const csvContent = "data:text/csv;charset=utf-8," + csv.join("\n");
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "relatorio_zumba.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        // Exportar para XLSX
        exportXlsxBtn.addEventListener('click', () => {
            if (!lastReportData.headers.length) { console.warn('Gere o relatório antes de exportar.'); return; }
            const aoa = [ lastReportData.headers, ...lastReportData.rows ];
            const ws = XLSX.utils.aoa_to_sheet(aoa);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Relatorio');
            XLSX.writeFile(wb, 'relatorio_zumba.xlsx');
        });

        // Exportar para PDF
        exportPdfBtn.addEventListener('click', () => {
            if (!lastReportData.headers.length) { console.warn('Gere o relatório antes de exportar.'); return; }
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'landscape' });
            const title = 'Relatório Projeto Zumba';
            const date = new Date().toLocaleString('pt-BR');
            doc.setFontSize(16);
            doc.text(title, 14, 15);
            doc.setFontSize(10);
            doc.text(`Gerado em ${date}`, 14, 22);
            doc.autoTable({
                head: [ lastReportData.headers ],
                body: lastReportData.rows,
                startY: 28,
                styles: { fontSize: 9 },
                headStyles: { fillColor: [236, 72, 153] },
            });
            doc.save('relatorio_zumba.pdf');
        });
        
        
        // Inicializar ícones
        // Lucide precisa ser criado manualmente
        if (window.lucide) {
            lucide.createIcons();
        }

    </script>
</body>
</html>
