<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro Projeto Zumba</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Font (Inter) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">

    <!-- Chart.js para gráficos de relatórios -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <!-- Ícones (Lucide) -->
    <script src="https://unpkg.com/lucide-react@latest/dist/lucide-react.js"></script>
    <script src="https://unpkg.com/lucide-icons@latest/dist/lucide.min.js"></script>

    <style>
        /* Estilo base com a fonte Inter */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0fdf4; /* Verde bem claro */
        }

        /* Tema Zumba: Cores vibrantes */
        .zumba-gradient {
            background: linear-gradient(135deg, #ec4899, #d946ef, #a855f7); /* Pink -> Fuchsia -> Roxo */
        }
        
        .zumba-gradient-alt {
            background: linear-gradient(135deg, #a3e635, #34d399, #22d3ee); /* Verde-limão -> Esmeralda -> Ciano */
        }

        .btn-zumba {
            /* substitui @apply por CSS para funcionar com CDN */
            display: inline-flex; align-items: center; justify-content: center;
            padding: 0.75rem 1.25rem; border-radius: 0.75rem; font-weight: 700;
            color: #ffffff; background: linear-gradient(135deg, #ec4899, #e11d48);
            box-shadow: 0 10px 24px rgba(236, 72, 153, 0.35);
            transition: transform 200ms ease, box-shadow 200ms ease, filter 200ms ease;
        }
        .btn-zumba:hover { transform: translateY(-1px) scale(1.03); filter: brightness(1.02); }
        .btn-zumba:active { transform: scale(0.98); }

        .btn-zumba-alt {
            display: inline-flex; align-items: center; justify-content: center;
            padding: 0.75rem 1.25rem; border-radius: 0.75rem; font-weight: 700;
            color: #ffffff; background: linear-gradient(135deg, #22d3ee, #10b981);
            box-shadow: 0 10px 24px rgba(16, 185, 129, 0.35);
            transition: transform 200ms ease, box-shadow 200ms ease, filter 200ms ease;
        }
        .btn-zumba-alt:hover { transform: translateY(-1px) scale(1.03); filter: brightness(1.02); }
        .btn-zumba-alt:active { transform: scale(0.98); }

        .btn-zumba-secondary {
            display:inline-flex; align-items:center; justify-content:center;
            padding: 0.5rem 0.9rem; border-radius: 0.6rem; font-weight: 600;
            background:#e5e7eb; color:#374151; box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transition: transform 200ms ease, background 200ms ease;
        }
        .btn-zumba-secondary:hover { background:#d1d5db; transform: translateY(-1px); }

        /* Estilo para inputs */
        .form-input {
            width: 100%; padding: 0.5rem 0.9rem; margin-top: 0.25rem;
            border-radius: 0.75rem; border: 1px solid #d1d5db; background:#ffffff; color:#111827;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        .form-input::placeholder { color:#9ca3af; }
        .form-input:focus { outline: none; border-color:#ec4899; box-shadow: 0 0 0 3px rgba(236, 72, 153, 0.25); }

        .form-select {
            width: 100%; padding: 0.5rem 0.9rem; margin-top: 0.25rem;
            border-radius: 0.75rem; border: 1px solid #d1d5db; background:#ffffff; color:#111827;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        .form-select:focus { outline:none; border-color:#ec4899; box-shadow: 0 0 0 3px rgba(236, 72, 153, 0.25); }

        .form-label { display:block; font-size:0.9rem; font-weight:600; color:#374151; }

        /* Ocultar/Mostrar seções */
        .hidden-section {
            display: none;
        }

        /* Estilo do Modal */
        #details-modal {
            position: fixed; inset: 0; z-index: 50; display:flex; align-items:center; justify-content:center;
            background: rgba(0,0,0,0.75); transition: opacity 300ms ease;
        }

        /* Responsividade e ajustes por dispositivo */
        .is-mobile .container { padding-left: 1rem; padding-right: 1rem; }
        .is-mobile .btn-zumba, .is-mobile .btn-zumba-alt { width: 100%; }
        .is-mobile .form-input, .is-mobile .form-select { font-size: 16px; } /* evita zoom no iOS */
        .device-badge { display:inline-flex; align-items:center; gap:0.4rem; padding:0.25rem 0.5rem; border-radius:999px; background:#f3f4f6; color:#374151; font-weight:600; font-size:0.8rem; }
    </style>
</head>
<body class="antialiased text-gray-900">

    <!-- Container Principal -->
    <div class="container mx-auto p-4 md:p-8 max-w-7xl">

        <!-- ===== SEÇÃO DE LOGIN ===== -->
        <section id="login-view">
            <div class="flex flex-col items-center justify-center min-h-screen py-12">
                <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-2xl shadow-2xl">
                    <div class="text-center">
                        <h1 class="text-4xl font-black zumba-gradient bg-clip-text text-transparent">Projeto Zumba</h1>
                        <p class="mt-2 text-lg text-gray-600">Bem-vindo(a)!</p>
                        <p class="mt-3 text-sm text-gray-700">Como podemos definir a Zumba? É uma aula de fitness que utiliza vários géneros de dança, mas é, sobretudo, uma aula de sensações: a sensação de felicidade, de alegria, de carinho.</p>
                        <div id="deviceBadge" class="device-badge mt-3">Modo: Detectando...</div>
                    </div>
                    
                    <!-- Formulário de Login (Admin) -->
                    <form id="admin-login-form" class="space-y-4">
                        <h2 class="text-xl font-bold text-center text-gray-700">Login do Administrador</h2>
                        <div>
                            <label for="admin-email" class="form-label">Email</label>
                            <input type="email" id="admin-email" class="form-input" required>
                        </div>
                        <div>
                            <label for="admin-password" class="form-label">Senha</label>
                            <input type="password" id="admin-password" class="form-input" required>
                        </div>
                        <button type="submit" class="w-full btn-zumba">Entrar</button>
                    </form>
                    
                    <div class="relative flex items-center justify-center">
                        <div class="absolute inset-0 flex items-center">
                            <div class="w-full border-t border-gray-300"></div>
                        </div>
                        <div class="relative px-2 text-sm text-gray-500 bg-white">
                            ou
                        </div>
                    </div>

                    <!-- Botão para ir ao Cadastro -->
                    <button id="go-to-register-btn" class="w-full btn-zumba-alt">
                        Fazer Inscrição
                    </button>
                    
                    <p id="auth-error" class="text-sm text-center text-red-500"></p>
                </div>
            </div>
        </section>

        <!-- ===== SEÇÃO DE CADASTRO ===== -->
        <section id="register-view" class="hidden-section">
            <div class="max-w-4xl p-8 mx-auto space-y-8 bg-white rounded-2xl shadow-2xl">
                <div class="text-center">
                    <h1 class="text-4xl font-black zumba-gradient-alt bg-clip-text text-transparent">Ficha de Cadastro</h1>
                    <p class="mt-2 text-lg text-gray-600">Preencha seus dados para participar</p>
                </div>

                <form id="register-form" class="space-y-6">
                    
                    <!-- Seção 1: Dados Iniciais -->
                    <fieldset class="p-4 border rounded-lg">
                        <legend class="px-2 text-lg font-bold text-gray-800">Identificação</legend>
                        <div class="grid grid-cols-1 gap-4 md:grid-cols-3">
                            <div>
                                <label for="polo" class="form-label">Polo</label>
                                <input type="text" id="polo" class="form-input">
                            </div>
                            <div>
                                <label for="inscricao" class="form-label">N° Inscrição</label>
                                <input type="text" id="inscricao" class="form-input">
                            </div>
                            <div>
                                <label for="data" class="form-label">Data</label>
                                <input type="date" id="data" class="form-input" required>
                            </div>
                        </div>
                    </fieldset>

                    <!-- Seção 2: Dados Pessoais -->
                    <fieldset class="p-4 border rounded-lg">
                        <legend class="px-2 text-lg font-bold text-gray-800">Dados Pessoais</legend>
                        <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
                             <div>
                                <label for="nome" class="form-label">Nome Completo</label>
                                <input type="text" id="nome" class="form-input" required>
                            </div>
                            <div>
                                <label class="form-label">Sexo</label>
                                <div class="flex items-center mt-2 space-x-4">
                                    <label class="flex items-center">
                                        <input type="radio" name="sexo" value="Masculino" class="text-pink-600 focus:ring-pink-500">
                                        <span class="ml-2">Masculino</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="radio" name="sexo" value="Feminino" class="text-pink-600 focus:ring-pink-500">
                                        <span class="ml-2">Feminino</span>
                                    </label>
                                </div>
                            </div>
                            <div>
                                <label for="dataNascimento" class="form-label">Data de Nascimento</label>
                                <input type="date" id="dataNascimento" class="form-input" required>
                            </div>
                            <div>
                                <label for="idade" class="form-label">Idade</label>
                                <input type="number" id="idade" class="form-input" required>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 gap-4 mt-4 md:grid-cols-3">
                            <div>
                                <label for="endereco" class="form-label">Endereço (Rua, Av.)</label>
                                <input type="text" id="endereco" class="form-input">
                            </div>
                            <div>
                                <label for="numero" class="form-label">N°</label>
                                <input type="text" id="numero" class="form-input">
                            </div>
                             <div>
                                <label for="bairro" class="form-label">Bairro</label>
                                <input type="text" id="bairro" class="form-input">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 gap-4 mt-4 md:grid-cols-3">
                            <div>
                                <label for="cep" class="form-label">CEP</label>
                                <input type="text" id="cep" class="form-input">
                            </div>
                            <div>
                                <label for="cidade" class="form-label">Cidade</label>
                                <input type="text" id="cidade" class="form-input">
                            </div>
                            <div>
                                <label for="telefone" class="form-label">Telefone</label>
                                <input type="tel" id="telefone" class="form-input">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 gap-4 mt-4 md:grid-cols-3">
                            <div>
                                <label for="profissao" class="form-label">Profissão</label>
                                <input type="text" id="profissao" class="form-input">
                            </div>
                            <div>
                                <label class="form-label">Empregado?</label>
                                <select id="empregado" class="form-select">
                                    <option value="Sim">Sim</option>
                                    <option value="Não">Não</option>
                                </select>
                            </div>
                            <div>
                                <label for="estadoCivil" class="form-label">Estado Civil</label>
                                <input type="text" id="estadoCivil" class="form-input">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 gap-4 mt-4 md:grid-cols-4">
                            <div>
                                <label for="rg" class="form-label">RG</label>
                                <input type="text" id="rg" class="form-input" required>
                            </div>
                            <div>
                                <label for="cpf" class="form-label">CPF</label>
                                <input type="text" id="cpf" class="form-input" required>
                            </div>
                            <div>
                                <label for="titulo" class="form-label">Título</label>
                                <input type="text" id="titulo" class="form-input">
                            </div>
                            <div>
                                <label for="secao" class="form-label">Seção</label>
                                <input type="text" id="secao" class="form-input">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 gap-4 mt-4 md:grid-cols-2">
                             <div>
                                <label class="form-label">Mora em casa própria?</label>
                                <select id="casaPropria" class="form-select">
                                    <option value="Sim">Sim</option>
                                    <option value="Não">Não</option>
                                </select>
                            </div>
                            <div>
                                <label for="zona" class="form-label">Zona (Eleitoral)</label>
                                <input type="text" id="zona" class="form-input">
                            </div>
                        </div>
                    </fieldset>
                    
                    <!-- Seção 3: Medidas e Uploads -->
                    <fieldset class="p-4 border rounded-lg">
                        <legend class="px-2 text-lg font-bold text-gray-800">Medidas e Arquivos</legend>
                        <div>
                            <label class="form-label">Medida da Camisa</label>
                            <div class="flex flex-wrap gap-4 mt-2">
                                <label><input type="radio" name="camisa" value="PP" class="text-pink-600 focus:ring-pink-500"> PP</label>
                                <label><input type="radio" name="camisa" value="P" class="text-pink-600 focus:ring-pink-500"> P</label>
                                <label><input type="radio" name="camisa" value="M" class="text-pink-600 focus:ring-pink-500"> M</label>
                                <label><input type="radio" name="camisa" value="G" class="text-pink-600 focus:ring-pink-500"> G</label>
                                <label><input type="radio" name="camisa" value="GG" class="text-pink-600 focus:ring-pink-500"> GG</label>
                                <div>
                                    <label><input type="radio" name="camisa" value="Outro" class="text-pink-600 focus:ring-pink-500"> Outro:</label>
                                    <input type="text" id="camisaOutro" class="form-input inline-block w-auto ml-2" placeholder="Especifique">
                                </div>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 gap-4 mt-4 md:grid-cols-2">
                            <div>
                                <label for="uploadFoto" class="form-label">Sua Foto (3x4)</label>
                                <input type="file" id="uploadFoto" class="form-input" accept="image/*" required>
                                <span class="text-xs text-gray-500">Para identificação.</span>
                            </div>
                            <div>
                                <label for="uploadRG" class="form-label">Documento RG (Frente e Verso)</label>
                                <input type="file" id="uploadRG" class="form-input" accept="image/*,application/pdf" required>
                                <span class="text-xs text-gray-500">Pode ser foto ou PDF.</span>
                            </div>
                        </div>
                    </fieldset>

                    <!-- Seção 4: Histórico Patológico -->
                    <fieldset class="p-4 border rounded-lg">
                        <legend class="px-2 text-lg font-bold text-gray-800">Histórico Patológico (Saúde)</legend>
                        <div class="grid grid-cols-1 gap-y-4 gap-x-6 md:grid-cols-3">
                            <!-- Helper para criar Sim/Não -->
                            <script>
                                const healthQuestions = [
                                    { id: 'bebidaAlcoolica', label: 'Faz uso de bebida alcoólica?' },
                                    { id: 'fumante', label: 'É fumante?' },
                                    { id: 'doadorSangue', label: 'Doador de sangue?' },
                                    { id: 'cardiaco', label: 'Cardíaco?' },
                                    { id: 'hipertenso', label: 'Hipertenso?' },
                                    { id: 'diabetico', label: 'Diabético?' },
                                    { id: 'epiletico', label: 'É epilético(a)?' }
                                ];
                            </script>
                            
                            <!-- Perguntas Sim/Não -->
                            <template id="health-question-template">
                                <div>
                                    <label class="form-label"></label>
                                    <select class="form-select">
                                        <option value="Não" selected>Não</option>
                                        <option value="Sim">Sim</option>
                                    </select>
                                </div>
                            </template>

                            <div id="health-questions-container" class="contents"></div>

                            <!-- Perguntas com "QUAL" -->
                            <div>
                                <label for="tipoSanguineo" class="form-label">Tipo Sanguíneo</label>
                                <input type="text" id="tipoSanguineo" class="form-input">
                            </div>
                            
                            <div class="md:col-span-2">
                                <label for="alergias" class="form-label">Alergias?</label>
                                <div class="flex gap-2">
                                    <select id="alergias" class="form-select w-1/3">
                                        <option value="Não" selected>Não</option>
                                        <option value="Sim">Sim</option>
                                    </select>
                                    <input type="text" id="alergiasQual" class="form-input w-2/3" placeholder="Qual?">
                                </div>
                            </div>
                            <div class="md:col-span-2">
                                <label for="cirurgiaRecente" class="form-label">Cirurgia recente?</label>
                                <div class="flex gap-2">
                                    <select id="cirurgiaRecente" class="form-select w-1/3">
                                        <option value="Não" selected>Não</option>
                                        <option value="Sim">Sim</option>
                                    </select>
                                    <input type="text" id="cirurgiaRecenteQual" class="form-input w-2/3" placeholder="Qual?">
                                </div>
                            </div>
                            <div class="md:col-span-2">
                                <label for="tratamentoMedico" class="form-label">Está em tratamento médico?</label>
                                <div class="flex gap-2">
                                    <select id="tratamentoMedico" class="form-select w-1/3">
                                        <option value="Não" selected>Não</option>
                                        <option value="Sim">Sim</option>
                                    </select>
                                    <input type="text" id="tratamentoMedicoQual" class="form-input w-2/3" placeholder="Qual?">
                                </div>
                            </div>
                            <div class="md:col-span-2">
                                <label for="tomaMedicamento" class="form-label">Toma algum medicamento?</label>
                                <div class="flex gap-2">
                                    <select id="tomaMedicamento" class="form-select w-1/3">
                                        <option value="Não" selected>Não</option>
                                        <option value="Sim">Sim</option>
                                    </select>
                                    <input type="text" id="tomaMedicamentoQual" class="form-input w-2/3" placeholder="Qual?">
                                </div>
                            </div>
                            <div class="md:col-span-2">
                                <label for="problemaOrtopedico" class="form-label">Problema Ortopédico?</label>
                                <div class="flex gap-2">
                                    <select id="problemaOrtopedico" class="form-select w-1/3">
                                        <option value="Não" selected>Não</option>
                                        <option value="Sim">Sim</option>
                                    </select>
                                    <input type="text" id="problemaOrtopedicoQual" class="form-input w-2/3" placeholder="Qual?">
                                </div>
                            </div>
                        </div>
                    </fieldset>

                    <!-- Botões de Ação -->
                    <div class="flex flex-col gap-4 md:flex-row md:justify-between">
                        <button type="button" id="back-to-login-btn" class="btn-zumba-secondary">
                            Voltar para o Login
                        </button>
                        <button type="submit" id="submit-register-btn" class="btn-zumba-alt">
                            <span id="submit-text">Enviar Inscrição</span>
                            <span id="submit-loading" class="hidden-section">Enviando...</span>
                        </button>
                    </div>
                    <p id="register-message" class="text-sm text-center"></p>

                </form>
            </div>
        </section>

        <!-- ===== PAINEL DO ADMIN ===== -->
        <section id="admin-panel" class="hidden-section space-y-8">
            <!-- Header do Admin -->
            <header class="flex flex-col items-center justify-between p-6 bg-white rounded-lg shadow-lg md:flex-row zumba-gradient">
                <h1 class="text-3xl font-black text-white">Painel de Administração</h1>
                <button id="admin-logout-btn" class="px-4 py-2 mt-4 font-semibold text-pink-600 bg-white rounded-lg shadow-md md:mt-0 hover:bg-gray-100">
                    Sair
                </button>
            </header>

            <!-- Seção: Inscrições Pendentes -->
            <div class="p-6 bg-white rounded-lg shadow-lg">
                <h2 class="pb-4 text-2xl font-bold border-b border-gray-200">Inscrições Pendentes</h2>
                <div id="pending-registrations-list" class="mt-4 space-y-4">
                    <!-- Inscrições pendentes serão injetadas aqui -->
                    <p id="no-pending-message">Não há inscrições pendentes no momento.</p>
                </div>
            </div>

            <!-- Seção: Gerador de Relatórios -->
            <div class="p-6 bg-white rounded-lg shadow-lg">
                <h2 class="pb-4 text-2xl font-bold border-b border-gray-200">Gerador de Relatórios</h2>
                
                <!-- Indicadores rápidos -->
                <div class="grid grid-cols-1 gap-4 mt-4 md:grid-cols-4">
                  <div class="p-4 border rounded-lg">
                    <div class="text-sm text-gray-500">Aprovados</div>
                    <div id="kpiAprovados" class="text-2xl font-black">0</div>
                  </div>
                  <div class="p-4 border rounded-lg">
                    <div class="text-sm text-gray-500">Pendentes</div>
                    <div id="kpiPendentes" class="text-2xl font-black">0</div>
                  </div>
                  <div class="p-4 border rounded-lg">
                    <div class="text-sm text-gray-500">Rejeitados</div>
                    <div id="kpiRejeitados" class="text-2xl font-black">0</div>
                  </div>
                  <div class="p-4 border rounded-lg">
                    <div class="text-sm text-gray-500">Média de idade</div>
                    <div id="kpiIdade" class="text-2xl font-black">0</div>
                  </div>
                </div>

                <!-- Gráficos -->
                <div class="grid grid-cols-1 gap-4 mt-4 md:grid-cols-2">
                  <div class="p-4 border rounded-lg">
                    <div class="flex items-center justify-between">
                      <h3 class="text-lg font-semibold">Distribuição por sexo</h3>
                    </div>
                    <canvas id="chartSexo" height="160"></canvas>
                  </div>
                  <div class="p-4 border rounded-lg">
                    <div class="flex items-center justify-between">
                      <h3 class="text-lg font-semibold">Top bairros</h3>
                    </div>
                    <canvas id="chartBairro" height="160"></canvas>
                  </div>
                  <div class="p-4 border rounded-lg md:col-span-2">
                    <div class="flex items-center justify-between">
                      <h3 class="text-lg font-semibold">Inscrições por mês</h3>
                    </div>
                    <canvas id="chartMes" height="140"></canvas>
                  </div>
                </div>

                <div class="mt-6 space-y-4">
                    <p>Selecione os campos que deseja incluir no relatório (de todos os cadastros <span class="font-bold text-green-600">aprovados</span>):</p>
                    
                    <!-- Checkboxes dos Campos -->
                    <div id="report-fields" class="grid grid-cols-2 gap-2 md:grid-cols-4 lg:grid-cols-6">
                        <!-- Campos para o relatório -->
                        <label class="flex items-center"><input type="checkbox" value="nome" class="mr-2 rounded text-pink-500"> Nome</label>
                        <label class="flex items-center"><input type="checkbox" value="idade" class="mr-2 rounded text-pink-500"> Idade</label>
                        <label class="flex items-center"><input type="checkbox" value="telefone" class="mr-2 rounded text-pink-500"> Telefone</label>
                        <label class="flex items-center"><input type="checkbox" value="tipoSanguineo" class="mr-2 rounded text-pink-500"> Tipo Sanguíneo</label>
                        <label class="flex items-center"><input type="checkbox" value="polo" class="mr-2 rounded text-pink-500"> Polo</label>
                        <label class="flex items-center"><input type="checkbox" value="sexo" class="mr-2 rounded text-pink-500"> Sexo</label>
                        <label class="flex items-center"><input type="checkbox" value="bairro" class="mr-2 rounded text-pink-500"> Bairro</label>
                        <label class="flex items-center"><input type="checkbox" value="cidade" class="mr-2 rounded text-pink-500"> Cidade</label>
                        <label class="flex items-center"><input type="checkbox" value="camisa" class="mr-2 rounded text-pink-500"> Tam. Camisa</label>
                        <label class="flex items-center"><input type="checkbox" value="hipertenso" class="mr-2 rounded text-pink-500"> Hipertenso</label>
                        <label class="flex items-center"><input type="checkbox" value="diabetico" class="mr-2 rounded text-pink-500"> Diabético</label>
                        <label class="flex items-center"><input type="checkbox" value="cardiaco" class="mr-2 rounded text-pink-500"> Cardíaco</label>
                         <!-- Os campos dinâmicos serão inseridos aqui via JS -->
                    </div>

                    <button id="generate-report-btn" class="btn-zumba">Gerar Relatório</button>

                    <!-- Resultados do Relatório -->
                    <div id="report-results-container" class="hidden-section mt-6">
                        <h3 class="text-xl font-semibold">Resultados do Relatório</h3>
                        <div class="mt-2 overflow-x-auto">
                            <table id="report-table" class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50" id="report-table-head">
                                    <!-- Cabeçalho da tabela gerado via JS -->
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200" id="report-table-body">
                                    <!-- Linhas da tabela geradas via JS -->
                                </tbody>
                            </table>
                        </div>
                        <button id="export-csv-btn" class="mt-4 btn-zumba-secondary">Exportar para CSV</button>
                    </div>
                </div>
            </div>
            
             <!-- Seção: Cadastros Rejeitados -->
            <div class="p-6 bg-white rounded-lg shadow-lg">
                <h2 class="pb-4 text-2xl font-bold border-b border-gray-200 text-red-600">Cadastros Rejeitados</h2>
                <div id="rejected-registrations-list" class="mt-4 space-y-4">
                    <!-- Cadastros rejeitados serão injetados aqui -->
                    <p id="no-rejected-message">Não há cadastros rejeitados.</p>
                </div>
            </div>

        </section>


        <!-- ===== MODAL DE DETALHES/EDIÇÃO ===== -->
        <div id="details-modal" class="hidden-section opacity-0" aria-labelledby="modal-title" role="dialog" aria-modal="true">
            <div class="transform w-full max-w-4xl p-6 mx-4 bg-white rounded-2xl shadow-xl transition-all sm:mx-0">
                <div class="flex items-start justify-between">
                    <h2 class="text-2xl font-bold text-gray-900" id="modal-title">Detalhes da Inscrição</h2>
                    <button id="close-modal-btn" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>
                
                <div class="mt-4 max-h-[70vh] overflow-y-auto pr-2">
                    <!-- Conteúdo do modal (formulário de edição) -->
                    <!-- Usaremos o mesmo formulário de cadastro, mas com ID "edit-" -->
                    <form id="edit-form" class="space-y-6">
                        <input type="hidden" id="edit-doc-id">
                        
                        <div class="flex flex-col items-center gap-4 md:flex-row">
                            <img id="edit-foto-preview" src="https://placehold.co/150x150/e0e0e0/7c7c7c?text=Foto" alt="Foto do Perfil" class="object-cover w-32 h-32 rounded-lg shadow-md">
                            <div class="flex-1">
                                <a id="edit-rg-link" href="#" target="_blank" class="block w-full text-center btn-zumba-secondary">Ver Documento RG</a>
                                <div class="mt-4">
                                     <label for="edit-status" class="form-label">Status da Inscrição</label>
                                     <select id="edit-status" class="form-select">
                                        <option value="pending">Pendente</option>
                                        <option value="approved">Aprovado</option>
                                        <option value="rejected">Rejeitado</option>
                                     </select>
                                </div>
                            </div>
                        </div>

                        <!-- Seção 1: Dados Iniciais -->
                        <fieldset class="p-4 border rounded-lg">
                            <legend class="px-2 text-lg font-bold text-gray-800">Identificação</legend>
                            <div class="grid grid-cols-1 gap-4 md:grid-cols-3">
                                <div><label for="edit-polo" class="form-label">Polo</label><input type="text" id="edit-polo" class="form-input"></div>
                                <div><label for="edit-inscricao" class="form-label">N° Inscrição</label><input type="text" id="edit-inscricao" class="form-input"></div>
                                <div><label for="edit-data" class="form-label">Data</label><input type="date" id="edit-data" class="form-input"></div>
                            </div>
                        </fieldset>

                        <!-- Seção 2: Dados Pessoais -->
                        <fieldset class="p-4 border rounded-lg">
                            <legend class="px-2 text-lg font-bold text-gray-800">Dados Pessoais</legend>
                            <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
                                <div><label for="edit-nome" class="form-label">Nome</label><input type="text" id="edit-nome" class="form-input"></div>
                                <div>
                                    <label class="form-label">Sexo</label>
                                    <div class="flex items-center mt-2 space-x-4">
                                        <label><input type="radio" name="edit-sexo" value="Masculino" class="text-pink-600"> Mas.</label>
                                        <label><input type="radio" name="edit-sexo" value="Feminino" class="text-pink-600"> Fem.</label>
                                    </div>
                                </div>
                                <div><label for="edit-dataNascimento" class="form-label">Data Nasc.</label><input type="date" id="edit-dataNascimento" class="form-input"></div>
                                <div><label for="edit-idade" class="form-label">Idade</label><input type="number" id="edit-idade" class="form-input"></div>
                            </div>
                            <div class="grid grid-cols-1 gap-4 mt-4 md:grid-cols-3">
                                <div><label for="edit-endereco" class="form-label">Endereço</label><input type="text" id="edit-endereco" class="form-input"></div>
                                <div><label for="edit-numero" class="form-label">N°</label><input type="text" id="edit-numero" class="form-input"></div>
                                <div><label for="edit-bairro" class="form-label">Bairro</label><input type="text" id="edit-bairro" class="form-input"></div>
                            </div>
                            <div class="grid grid-cols-1 gap-4 mt-4 md:grid-cols-3">
                                <div><label for="edit-cep" class="form-label">CEP</label><input type="text" id="edit-cep" class="form-input"></div>
                                <div><label for="edit-cidade" class="form-label">Cidade</label><input type="text" id="edit-cidade" class="form-input"></div>
                                <div><label for="edit-telefone" class="form-label">Telefone</label><input type="tel" id="edit-telefone" class="form-input"></div>
                            </div>
                            <div class="grid grid-cols-1 gap-4 mt-4 md:grid-cols-3">
                                <div><label for="edit-profissao" class="form-label">Profissão</label><input type="text" id="edit-profissao" class="form-input"></div>
                                <div><label class="form-label">Empregado?</label><select id="edit-empregado" class="form-select"><option value="Sim">Sim</option><option value="Não">Não</option></select></div>
                                <div><label for="edit-estadoCivil" class="form-label">Estado Civil</label><input type="text" id="edit-estadoCivil" class="form-input"></div>
                            </div>
                            <div class="grid grid-cols-1 gap-4 mt-4 md:grid-cols-4">
                                <div><label for="edit-rg" class="form-label">RG</label><input type="text" id="edit-rg" class="form-input"></div>
                                <div><label for="edit-cpf" class="form-label">CPF</label><input type="text" id="edit-cpf" class="form-input"></div>
                                <div><label for="edit-titulo" class="form-label">Título</label><input type="text" id="edit-titulo" class="form-input"></div>
                                <div><label for="edit-secao" class="form-label">Seção</label><input type="text" id="edit-secao" class="form-input"></div>
                            </div>
                            <div class="grid grid-cols-1 gap-4 mt-4 md:grid-cols-2">
                                <div><label class="form-label">Casa Própria?</label><select id="edit-casaPropria" class="form-select"><option value="Sim">Sim</option><option value="Não">Não</option></select></div>
                                <div><label for="edit-zona" class="form-label">Zona</label><input type="text" id="edit-zona" class="form-input"></div>
                            </div>
                        </fieldset>

                        <!-- Seção 3: Medidas -->
                        <fieldset class="p-4 border rounded-lg">
                            <legend class="px-2 text-lg font-bold text-gray-800">Medidas</legend>
                            <label class="form-label">Medida da Camisa</label>
                            <div class="flex flex-wrap gap-4 mt-2">
                                <label><input type="radio" name="edit-camisa" value="PP" class="text-pink-600"> PP</label>
                                <label><input type="radio" name="edit-camisa" value="P" class="text-pink-600"> P</label>
                                <label><input type="radio" name="edit-camisa" value="M" class="text-pink-600"> M</label>
                                <label><input type="radio" name="edit-camisa" value="G" class="text-pink-600"> G</label>
                                <label><input type="radio" name="edit-camisa" value="GG" class="text-pink-600"> GG</label>
                                <div>
                                    <label><input type="radio" name="edit-camisa" value="Outro" class="text-pink-600"> Outro:</label>
                                    <input type="text" id="edit-camisaOutro" class="form-input inline-block w-auto ml-2">
                                </div>
                            </div>
                        </fieldset>

                        <!-- Seção 4: Histórico Patológico -->
                        <fieldset class="p-4 border rounded-lg">
                            <legend class="px-2 text-lg font-bold text-gray-800">Histórico Patológico</legend>
                            <div class="grid grid-cols-1 gap-y-4 gap-x-6 md:grid-cols-3">
                                <!-- Perguntas Sim/Não -->
                                <div><label class="form-label">Bebida Alcoólica?</label><select id="edit-bebidaAlcoolica" class="form-select"><option value="Não">Não</option><option value="Sim">Sim</option></select></div>
                                <div><label class="form-label">Fumante?</label><select id="edit-fumante" class="form-select"><option value="Não">Não</option><option value="Sim">Sim</option></select></div>
                                <div><label class="form-label">Doador de Sangue?</label><select id="edit-doadorSangue" class="form-select"><option value="Não">Não</option><option value="Sim">Sim</option></select></div>
                                <div><label class="form-label">Cardíaco?</label><select id="edit-cardiaco" class="form-select"><option value="Não">Não</option><option value="Sim">Sim</option></select></div>
                                <div><label class="form-label">Hipertenso?</label><select id="edit-hipertenso" class="form-select"><option value="Não">Não</option><option value="Sim">Sim</option></select></div>
                                <div><label class="form-label">Diabético?</label><select id="edit-diabetico" class="form-select"><option value="Não">Não</option><option value="Sim">Sim</option></select></div>
                                <div><label class="form-label">Epilético(a)?</label><select id="edit-epiletico" class="form-select"><option value="Não">Não</option><option value="Sim">Sim</option></select></div>
                                
                                <div><label for="edit-tipoSanguineo" class="form-label">Tipo Sanguíneo</label><input type="text" id="edit-tipoSanguineo" class="form-input"></div>
                                
                                <div class="md:col-span-2"><label for="edit-alergias" class="form-label">Alergias?</label><div class="flex gap-2"><select id="edit-alergias" class="form-select w-1/3"><option value="Não">Não</option><option value="Sim">Sim</option></select><input type="text" id="edit-alergiasQual" class="form-input w-2/3" placeholder="Qual?"></div></div>
                                <div class="md:col-span-2"><label for="edit-cirurgiaRecente" class="form-label">Cirurgia recente?</label><div class="flex gap-2"><select id="edit-cirurgiaRecente" class="form-select w-1/3"><option value="Não">Não</option><option value="Sim">Sim</option></select><input type="text" id="edit-cirurgiaRecenteQual" class="form-input w-2/3" placeholder="Qual?"></div></div>
                                <div class="md:col-span-2"><label for="edit-tratamentoMedico" class="form-label">Tratamento médico?</label><div class="flex gap-2"><select id="edit-tratamentoMedico" class="form-select w-1/3"><option value="Não">Não</option><option value="Sim">Sim</option></select><input type="text" id="edit-tratamentoMedicoQual" class="form-input w-2/3" placeholder="Qual?"></div></div>
                                <div class="md:col-span-2"><label for="edit-tomaMedicamento" class="form-label">Toma medicamento?</label><div class="flex gap-2"><select id="edit-tomaMedicamento" class="form-select w-1/3"><option value="Não">Não</option><option value="Sim">Sim</option></select><input type="text" id="edit-tomaMedicamentoQual" class="form-input w-2/3" placeholder="Qual?"></div></div>
                                <div class="md:col-span-2"><label for="edit-problemaOrtopedico" class="form-label">Problema Ortopédico?</label><div class="flex gap-2"><select id="edit-problemaOrtopedico" class="form-select w-1/3"><option value="Não">Não</option><option value="Sim">Sim</option></select><input type="text" id="edit-problemaOrtopedicoQual" class="form-input w-2/3" placeholder="Qual?"></div></div>
                            </div>
                        </fieldset>
                    </form>
                </div>
                
                <!-- Botões do Modal -->
                <div class="flex justify-end gap-4 pt-4 mt-6 border-t">
                    <button id="modal-delete-btn" class="px-4 py-2 font-semibold text-white bg-red-600 rounded-lg hover:bg-red-700">Deletar Inscrição</button>
                    <button id="modal-save-btn" class="px-4 py-2 font-semibold text-white bg-green-600 rounded-lg hover:bg-green-700">Salvar Alterações</button>
                </div>
                <p id="modal-message" class="mt-2 text-sm text-center"></p>
            </div>
        </div>

    </div> <!-- Fim do Container Principal -->


    <!-- Firebase SDKs -->
    <script type="module">
        // Importações do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged,
            setPersistence,
            browserLocalPersistence // Manter usuário logado
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            doc, 
            getDoc, 
            setDoc, 
            updateDoc, 
            deleteDoc, 
            query, 
            where, 
            onSnapshot,
            getDocs,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { 
            getStorage, 
            ref, 
            uploadBytes, 
            getDownloadURL 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // ==================================================================
        // PASSO DE CONFIGURAÇÃO OBRIGATÓRIO (Veja o arquivo configuracao.md)
        // ==================================================================
        
        // COLE A CONFIGURAÇÃO DO SEU FIREBASE AQUI
        const firebaseConfig = {
            apiKey: "AIzaSyDBrzQrHMkoBuAPa1l7r7AgSzscCkPfsw8",
            authDomain: "projeto-zumba-cadastro.firebaseapp.com",
            projectId: "projeto-zumba-cadastro",
            storageBucket: "projeto-zumba-cadastro.firebasestorage.app",
            messagingSenderId: "206177270048",
            appId: "1:206177270048:web:bcbf5d1957c0ee9b78ff45"
        };
        
        // COLE O UID DO SEU USUÁRIO ADMIN AQUI
        // (Encontre em Firebase Console > Authentication > Users > User UID)
        const ADMIN_UID = "5a3Wp2mG3rPPSgfr2rOtpCZURrl2"; 
        
        // ==================================================================
        // FIM DA CONFIGURAÇÃO
        // ==================================================================

        // Inicialização do Firebase
        let app, auth, db, storage;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            storage = getStorage(app);
            setLogLevel('Debug'); // Para ver logs no console
            console.log("Firebase inicializado com sucesso.");
        } catch (error) {
            console.error("Erro ao inicializar o Firebase:", error);
            document.body.innerHTML = `<div class="p-8 text-center text-red-600 bg-red-100">
                <h1 class="text-2xl font-bold">Erro de Configuração do Firebase</h1>
                <p class="mt-2">Não foi possível conectar ao Firebase. Verifique se o objeto 'firebaseConfig' e o 'ADMIN_UID' estão corretos no arquivo HTML.</p>
                <p class="mt-1 text-sm">Abra o console (F12) para mais detalhes.</p>
                </div>`;
        }


        // Referências dos Elementos DOM
        const loginView = document.getElementById('login-view');
        const registerView = document.getElementById('register-view');
        const adminPanel = document.getElementById('admin-panel');
        
        const adminLoginForm = document.getElementById('admin-login-form');
        const authError = document.getElementById('auth-error');
        const adminLogoutBtn = document.getElementById('admin-logout-btn');
        
        const goToRegisterBtn = document.getElementById('go-to-register-btn');
        const backToLoginBtn = document.getElementById('back-to-login-btn');
        
        const registerForm = document.getElementById('register-form');
        const registerMessage = document.getElementById('register-message');
        const submitRegisterBtn = document.getElementById('submit-register-btn');
        
        const pendingList = document.getElementById('pending-registrations-list');
        const noPendingMsg = document.getElementById('no-pending-message');
        const rejectedList = document.getElementById('rejected-registrations-list');
        const noRejectedMsg = document.getElementById('no-rejected-message');

        const detailsModal = document.getElementById('details-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const modalSaveBtn = document.getElementById('modal-save-btn');
        const modalDeleteBtn = document.getElementById('modal-delete-btn');
        const modalMessage = document.getElementById('modal-message');
        
        const reportFields = document.getElementById('report-fields');
        const generateReportBtn = document.getElementById('generate-report-btn');
        const reportResultsContainer = document.getElementById('report-results-container');
        const reportTableHead = document.getElementById('report-table-head');
        const reportTableBody = document.getElementById('report-table-body');
        const exportCsvBtn = document.getElementById('export-csv-btn');

        // =================================================
        // Lógica de Navegação
        // =================================================

        const showView = (viewId) => {
            [loginView, registerView, adminPanel].forEach(view => {
                view.classList.add('hidden-section');
            });
            document.getElementById(viewId).classList.remove('hidden-section');
        };

        goToRegisterBtn.addEventListener('click', () => showView('register-view'));
        backToLoginBtn.addEventListener('click', () => showView('login-view'));

        // =================================================
        // Lógica de Autenticação
        // =================================================

        // Observador do estado de autenticação
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // Usuário está logado
                if (user.uid === ADMIN_UID) {
                    // É o Admin
                    console.log("Admin logado:", user.uid);
                    showView('admin-panel');
                    loadAdminPanelData();
                } else {
                    // É um usuário comum (que acabou de se cadastrar)
                    console.log("Usuário comum logado:", user.uid);
                    // Não temos painel para usuário comum, então mostramos msg de sucesso pós-cadastro
                    // ou deslogamos. Por segurança, vamos deslogar.
                    signOut(auth);
                    showView('login-view');
                }
            } else {
                // Usuário está deslogado
                console.log("Nenhum usuário logado.");
                showView('login-view');
            }
        });

        // Login do Admin
        adminLoginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('admin-email').value;
            const password = document.getElementById('admin-password').value;
            authError.textContent = '';

            try {
                // Manter o admin logado
                await setPersistence(auth, browserLocalPersistence);
                await signInWithEmailAndPassword(auth, email, password);
                // O onAuthStateChanged vai cuidar de redirecionar
            } catch (error) {
                console.error("Erro no login:", error.message);
                authError.textContent = 'Email ou senha inválidos.';
            }
        });

        // Logout do Admin
        adminLogoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
                // O onAuthStateChanged vai cuidar de redirecionar
            } catch (error) {
                console.error("Erro no logout:", error.message);
            }
        });

        // =================================================
        // Lógica de Cadastro do Usuário
        // =================================================

        // Gerar campos de saúde
        const healthContainer = document.getElementById('health-questions-container');
        const healthTemplate = document.getElementById('health-question-template');
        const healthQuestions = [
            { id: 'bebidaAlcoolica', label: 'Faz uso de bebida alcoólica?' },
            { id: 'fumante', label: 'É fumante?' },
            { id: 'doadorSangue', label: 'Doador de sangue?' },
            { id: 'cardiaco', label: 'Cardíaco?' },
            { id: 'hipertenso', label: 'Hipertenso?' },
            { id: 'diabetico', label: 'Diabético?' },
            { id: 'epiletico', label: 'É epilético(a)?' }
        ];
        
        healthQuestions.forEach(q => {
            const clone = healthTemplate.content.cloneNode(true);
            clone.querySelector('label').textContent = q.label;
            clone.querySelector('select').id = q.id;
            healthContainer.appendChild(clone);
        });


        // Envio do Formulário de Cadastro
        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            setRegisterLoading(true);
            registerMessage.textContent = '';

            const fotoFile = document.getElementById('uploadFoto').files[0];
            const rgFile = document.getElementById('uploadRG').files[0];

            if (!fotoFile || !rgFile) {
                setRegisterLoading(false);
                registerMessage.textContent = 'Erro: Você precisa enviar a Foto e o documento RG.';
                registerMessage.className = 'text-sm text-center text-red-500';
                return;
            }

            // Usamos um email e senha aleatórios para criar o usuário
            // Isso é necessário para termos um UID para as regras de storage
            const tempEmail = `user_${Date.now()}@zumba.com`;
            const tempPassword = Math.random().toString(36).slice(-8);
            
            let userCredential;
            try {
                userCredential = await createUserWithEmailAndPassword(auth, tempEmail, tempPassword);
            } catch (error) {
                 console.error("Erro ao criar usuário temporário:", error);
                setRegisterLoading(false);
                registerMessage.textContent = 'Erro ao iniciar inscrição. Tente novamente.';
                registerMessage.className = 'text-sm text-center text-red-500';
                return;
            }
            
            const userId = userCredential.user.uid;

            try {
                // 1. Fazer Upload dos arquivos
                const fotoRef = ref(storage, `user_photos/${userId}/${fotoFile.name}`);
                const rgRef = ref(storage, `user_docs/${userId}/${rgFile.name}`);
                
                await uploadBytes(fotoRef, fotoFile);
                await uploadBytes(rgRef, rgFile);
                
                const photoURL = await getDownloadURL(fotoRef);
                const rgURL = await getDownloadURL(rgRef);

                // 2. Coletar dados do formulário
                const formData = getAllFormData('register-form');
                formData.photoURL = photoURL;
                formData.rgURL = rgURL;
                formData.userId = userId; // Guardar o UID do usuário
                formData.status = 'pending'; // Status inicial
                formData.email = tempEmail; // Guardar o email temporário
                formData.createdAt = new Date().toISOString(); // Data de criação

                // 3. Salvar no Firestore
                const docRef = await addDoc(collection(db, "registrations"), formData);
                
                console.log("Inscrição enviada com ID:", docRef.id);
                setRegisterLoading(false);
                registerMessage.textContent = 'Inscrição enviada com sucesso! O administrador irá analisar seu cadastro.';
                registerMessage.className = 'text-sm text-center text-green-600';
                registerForm.reset();
                
                // Deslogar o usuário temporário
                await signOut(auth);
                showView('login-view'); // Voltar para o login

            } catch (error) {
                console.error("Erro ao enviar inscrição:", error);
                setRegisterLoading(false);
                registerMessage.textContent = `Erro ao enviar inscrição: ${error.message}`;
                registerMessage.className = 'text-sm text-center text-red-500';
                
                // Se deu erro, podemos tentar deletar o usuário temporário
                // (Opcional, mas boa prática)
                try {
                    await userCredential.user.delete();
                } catch (deleteError) {
                    console.error("Erro ao deletar usuário temporário após falha:", deleteError);
                }
            }
        });
        
        function setRegisterLoading(isLoading) {
            const submitText = document.getElementById('submit-text');
            const submitLoading = document.getElementById('submit-loading');
            if (isLoading) {
                submitRegisterBtn.disabled = true;
                submitText.classList.add('hidden-section');
                submitLoading.classList.remove('hidden-section');
            } else {
                submitRegisterBtn.disabled = false;
                submitText.classList.remove('hidden-section');
                submitLoading.classList.add('hidden-section');
            }
        }
        
        // Função helper para pegar todos os dados de um formulário
        function getAllFormData(formId) {
            const form = document.getElementById(formId);
            const formData = new FormData(form);
            const data = {};
            
            // Inputs de texto, número, data, select
            form.querySelectorAll('input, select').forEach(input => {
                if (input.type === 'radio' || input.type === 'checkbox') return; // Handled below
                if (input.id) {
                     // Remove 'edit-' prefix if present
                    const key = input.id.startsWith('edit-') ? input.id.substring(5) : input.id;
                    if (key) data[key] = input.value;
                }
            });

            // Radio buttons
            form.querySelectorAll('input[type="radio"]:checked').forEach(radio => {
                const key = radio.name.startsWith('edit-') ? radio.name.substring(5) : radio.name;
                if (key === 'camisa' && radio.value === 'Outro') {
                     const outroId = formId === 'edit-form' ? 'edit-camisaOutro' : 'camisaOutro';
                     data[key] = document.getElementById(outroId).value || 'Outro';
                } else {
                    data[key] = radio.value;
                }
            });
            
            // Ajuste para campos com "Qual"
            ['alergias', 'cirurgiaRecente', 'tratamentoMedico', 'tomaMedicamento', 'problemaOrtopedico'].forEach(key => {
                const prefix = formId === 'edit-form' ? 'edit-' : '';
                const selectValue = data[key]; // Já deve ter pego o Sim/Não
                if (selectValue === 'Sim') {
                    const qualValue = document.getElementById(`${prefix}${key}Qual`).value;
                    data[key] = `Sim (${qualValue || 'N/A'})`;
                }
            });
            
            // Limpar campos "Qual" desnecessários
            ['alergiasQual', 'cirurgiaRecenteQual', 'tratamentoMedicoQual', 'tomaMedicamentoQual', 'problemaOrtopedicoQual', 'camisaOutro'].forEach(key => {
                 delete data[key];
                 delete data[`edit-${key}`]; // Limpar a chave com prefixo também
            });

            return data;
        }


        // =================================================
        // Lógica do Painel Admin
        // =================================================
        
        let allRegistrations = []; // Cache para relatórios
        let allRegistrationsUnsubscribe = null; // Listener do Firestore

        function loadAdminPanelData() {
            // Limpar listeners antigos se existirem
            if (allRegistrationsUnsubscribe) {
                allRegistrationsUnsubscribe();
            }

            const registrationsCol = collection(db, "registrations");
            
            // Listener para TODAS as inscrições
            allRegistrationsUnsubscribe = onSnapshot(registrationsCol, (snapshot) => {
                allRegistrations = []; // Limpar cache
                const pendingHtml = [];
                const rejectedHtml = [];
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const docId = doc.id;
                    allRegistrations.push({ id: docId, ...data });
                    
                    const cardHtml = `
                        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg shadow-sm border">
                            <div>
                                <p class="font-bold text-lg">${data.nome || 'Nome não informado'}</p>
                                <p class="text-sm text-gray-600">${data.email || data.cpf || 'Sem identificador'}</p>
                                <p class="text-xs text-gray-500">Enviado em: ${data.createdAt ? new Date(data.createdAt).toLocaleDateString() : 'N/A'}</p>
                            </div>
                            <div class="flex gap-2">
                                <button data-id="${docId}" class="view-btn btn-zumba-secondary text-sm">Ver/Editar</button>
                                ${data.status === 'pending' ? `<button data-id="${docId}" class="approve-btn btn-zumba-alt text-sm !px-3 !py-1">Aprovar</button>` : ''}
                                ${data.status !== 'rejected' ? `<button data-id="${docId}" class="reject-btn btn-zumba text-sm !px-3 !py-1">Rejeitar</button>` : ''}
                                ${data.status === 'rejected' ? `<button data-id="${docId}" class="approve-btn btn-zumba-alt text-sm !px-3 !py-1">Re-Aprovar</button>` : ''}
                            </div>
                        </div>
                    `;
                    
                    if(data.status === 'pending') {
                        pendingHtml.push(cardHtml);
                    } else if (data.status === 'rejected') {
                        rejectedHtml.push(cardHtml);
                    }
                    // Aprovados não são listados aqui, aparecem no relatório
                });

                // Atualizar lista de pendentes
                if (pendingHtml.length > 0) {
                    pendingList.innerHTML = pendingHtml.join('');
                    noPendingMsg.classList.add('hidden-section');
                } else {
                    pendingList.innerHTML = '';
                    noPendingMsg.classList.remove('hidden-section');
                }
                
                // Atualizar lista de rejeitados
                if (rejectedHtml.length > 0) {
                    rejectedList.innerHTML = rejectedHtml.join('');
                    noRejectedMsg.classList.add('hidden-section');
                } else {
                    rejectedList.innerHTML = '';
                    noRejectedMsg.classList.remove('hidden-section');
                }

            }, (error) => {
                console.error("Erro ao carregar inscrições:", error);
                pendingList.innerHTML = '<p class="text-red-500">Erro ao carregar dados.</p>';
            });
        }
        
        // Ações dos botões (Aprovar, Rejeitar, Ver)
        document.addEventListener('click', async (e) => {
            const target = e.target;
            const docId = target.dataset.id;
            
            if (!docId) return;

            // Aprovar
            if (target.classList.contains('approve-btn')) {
                if (confirm('Tem certeza que deseja APROVAR esta inscrição?')) {
                    try {
                        const docRef = doc(db, "registrations", docId);
                        await updateDoc(docRef, { status: "approved" });
                        console.log("Inscrição aprovada:", docId);
                    } catch (error) {
                        console.error("Erro ao aprovar:", error);
                        alert("Erro ao aprovar.");
                    }
                }
            }

            // Rejeitar
            if (target.classList.contains('reject-btn')) {
                 if (confirm('Tem certeza que deseja REJEITAR esta inscrição?')) {
                    try {
                        const docRef = doc(db, "registrations", docId);
                        await updateDoc(docRef, { status: "rejected" });
                        console.log("Inscrição rejeitada:", docId);
                    } catch (error) {
                        console.error("Erro ao rejeitar:", error);
                        alert("Erro ao rejeitar.");
                    }
                }
            }
            
            // Ver/Editar
            if (target.classList.contains('view-btn')) {
                openDetailsModal(docId);
            }
        });

        // =================================================
        // Lógica do Modal de Edição
        // =================================================
        
        let currentEditingDocId = null;

        async function openDetailsModal(docId) {
            currentEditingDocId = docId;
            modalMessage.textContent = '';
            
            try {
                const docRef = doc(db, "registrations", docId);
                const docSnap = await getDoc(docRef);

                if (!docSnap.exists()) {
                    console.error("Documento não encontrado");
                    alert("Documento não encontrado.");
                    return;
                }

                const data = docSnap.data();
                
                // Preencher o formulário de edição
                document.getElementById('edit-doc-id').value = docId;
                document.getElementById('edit-foto-preview').src = data.photoURL || 'https://placehold.co/150x150/e0e0e0/7c7c7c?text=Foto';
                document.getElementById('edit-rg-link').href = data.rgURL || '#';
                document.getElementById('edit-status').value = data.status || 'pending';

                // Preencher todos os inputs
                Object.keys(data).forEach(key => {
                    const el = document.getElementById(`edit-${key}`);
                    if (el) {
                        if (el.type === 'radio') {
                           // Handled by radio group
                        } else {
                            el.value = data[key];
                        }
                    }
                });
                
                // Preencher Radio (Sexo)
                document.querySelectorAll(`input[name="edit-sexo"]`).forEach(radio => {
                    radio.checked = (radio.value === data.sexo);
                });
                
                // Preencher Radio (Camisa)
                const camisaRadio = document.querySelector(`input[name="edit-camisa"][value="${data.camisa}"]`);
                if (camisaRadio) {
                    camisaRadio.checked = true;
                } else {
                    // É "Outro"
                    document.querySelector(`input[name="edit-camisa"][value="Outro"]`).checked = true;
                    document.getElementById('edit-camisaOutro').value = data.camisa;
                }
                
                // Preencher campos Sim/Não com "Qual"
                 ['alergias', 'cirurgiaRecente', 'tratamentoMedico', 'tomaMedicamento', 'problemaOrtopedico'].forEach(key => {
                     const elSelect = document.getElementById(`edit-${key}`);
                     const elQual = document.getElementById(`edit-${key}Qual`);
                     const value = data[key] || "Não";
                     
                     if (value.startsWith('Sim')) {
                         elSelect.value = 'Sim';
                         const qualMatch = value.match(/\(([^)]+)\)/); // Pega texto dentro de ( )
                         if (qualMatch && qualMatch[1] !== 'N/A') {
                             elQual.value = qualMatch[1];
                         } else {
                             elQual.value = '';
                         }
                     } else {
                         elSelect.value = 'Não';
                         elQual.value = '';
                     }
                 });


                // Mostrar o modal
                detailsModal.classList.remove('hidden-section');
                setTimeout(() => detailsModal.classList.remove('opacity-0'), 10);

            } catch (error) {
                console.error("Erro ao abrir modal:", error);
                alert("Erro ao carregar dados para edição.");
            }
        }

        closeModalBtn.addEventListener('click', () => {
            detailsModal.classList.add('opacity-0');
            setTimeout(() => detailsModal.classList.add('hidden-section'), 300);
            currentEditingDocId = null;
        });
        
        // Salvar alterações do Modal
        modalSaveBtn.addEventListener('click', async () => {
            if (!currentEditingDocId) return;
            
            modalMessage.textContent = 'Salvando...';
            
            try {
                // Coletar todos os dados do formulário de edição
                const formData = getAllFormData('edit-form');
                
                // O status vem do select 'edit-status'
                formData.status = document.getElementById('edit-status').value;
                
                // Remover campos que não devem ser atualizados
                delete formData['doc-id']; 
                
                const docRef = doc(db, "registrations", currentEditingDocId);
                await updateDoc(docRef, formData);
                
                modalMessage.textContent = 'Salvo com sucesso!';
                modalMessage.className = 'mt-2 text-sm text-center text-green-600';
                
                setTimeout(() => {
                    closeModalBtn.click();
                }, 1000);

            } catch (error) {
                console.error("Erro ao salvar alterações:", error);
                modalMessage.textContent = 'Erro ao salvar.';
                modalMessage.className = 'mt-2 text-sm text-center text-red-500';
            }
        });
        
        // Deletar inscrição (pelo modal)
        modalDeleteBtn.addEventListener('click', async () => {
            if (!currentEditingDocId) return;
            
            if (!confirm('TEM CERTEZA? Esta ação é irreversível e irá deletar o cadastro permanentemente.')) {
                return;
            }
            
            modalMessage.textContent = 'Deletando...';
            
            try {
                // TODO: Deletar arquivos do Storage antes de deletar o doc
                // (Por simplicidade, vamos pular isso, mas é importante para produção)
                
                const docRef = doc(db, "registrations", currentEditingDocId);
                await deleteDoc(docRef);
                
                modalMessage.textContent = 'Deletado com sucesso!';
                setTimeout(() => {
                    closeModalBtn.click();
                }, 1000);

            } catch (error) {
                console.error("Erro ao deletar:", error);
                modalMessage.textContent = 'Erro ao deletar.';
                modalMessage.className = 'mt-2 text-sm text-center text-red-500';
            }
        });


        // =================================================
        // Lógica do Gerador de Relatórios
        // =================================================

        generateReportBtn.addEventListener('click', () => {
            const selectedFields = [];
            reportFields.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => {
                selectedFields.push(cb.value);
            });

            if (selectedFields.length === 0) {
                alert("Por favor, selecione pelo menos um campo para o relatório.");
                return;
            }

            // Filtrar apenas os aprovados
            const approvedUsers = allRegistrations.filter(user => user.status === 'approved');

            if (approvedUsers.length === 0) {
                reportResultsContainer.classList.remove('hidden-section');
                reportTableHead.innerHTML = '';
                reportTableBody.innerHTML = '<tr><td class="p-4" colspan="100%">Nenhum usuário aprovado encontrado.</td></tr>';
                return;
            }

            // Gerar Cabeçalho da Tabela
            let headHtml = '<tr>';
            selectedFields.forEach(field => {
                const label = reportFields.querySelector(`input[value="${field}"]`).parentElement.textContent;
                headHtml += `<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${label.trim()}</th>`;
            });
            headHtml += '</tr>';
            reportTableHead.innerHTML = headHtml;

            // Gerar Corpo da Tabela
            let bodyHtml = '';
            approvedUsers.forEach(user => {
                bodyHtml += '<tr>';
                selectedFields.forEach(field => {
                    const value = user[field] || 'N/A';
                    bodyHtml += `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${value}</td>`;
                });
                bodyHtml += '</tr>';
            });
            reportTableBody.innerHTML = bodyHtml;

            reportResultsContainer.classList.remove('hidden-section');
        });
        
        // Exportar para CSV
        exportCsvBtn.addEventListener('click', () => {
            const table = document.getElementById('report-table');
            let csv = [];
            
            // Cabeçalho
            const headers = [];
            table.querySelectorAll('thead th').forEach(th => headers.push(`"${th.textContent}"`));
            csv.push(headers.join(','));
            
            // Linhas
            table.querySelectorAll('tbody tr').forEach(row => {
                const rowData = [];
                row.querySelectorAll('td').forEach(td => rowData.push(`"${td.textContent}"`));
                csv.push(rowData.join(','));
            });

            const csvContent = "data:text/csv;charset=utf-8," + csv.join("\n");
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "relatorio_zumba.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        // =================================================
        // KPIs e Gráficos (Dashboard de Relatórios)
        // =================================================
        let chartSexo, chartBairro, chartMes;

        function idadeFrom(dobStr) {
            if (!dobStr) return null; const d = new Date(dobStr); if (isNaN(d)) return null;
            const diff = Date.now() - d.getTime(); const age = new Date(diff).getUTCFullYear() - 1970; return age;
        }

        function groupCount(arr, key) {
            const m = new Map();
            arr.forEach(r => { const k = r[key] || '—'; m.set(k, (m.get(k)||0)+1); });
            const labels = Array.from(m.keys()); const values = Array.from(m.values());
            return { labels, values };
        }

        function groupByMonth(arr) {
            const m = new Map();
            arr.forEach(r => { const created = r.createdAt || r.data || ''; const ym = String(created).slice(0,7); if (!ym) return; m.set(ym, (m.get(ym)||0)+1); });
            const labels = Array.from(m.keys()).sort(); const values = labels.map(l => m.get(l));
            return { labels, values };
        }

        function upsertChart(inst, canvasId, type, labels, values, label) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) return null;
            if (inst) inst.destroy();
            return new Chart(ctx, {
                type,
                data: { labels, datasets: [{ label, data: values, backgroundColor: ['#ec4899','#22d3ee','#a3e635','#f59e0b','#10b981','#8b5cf6'] }] },
                options: { responsive: true, plugins: { legend: { labels: { color: '#374151' } } }, scales: { x: { ticks: { color: '#6b7280' } }, y: { ticks: { color: '#6b7280' } } } }
            });
        }

        function renderDashboard() {
            const aprovados = allRegistrations.filter(u => u.status === 'approved');
            const pendentes = allRegistrations.filter(u => u.status === 'pending');
            const rejeitados = allRegistrations.filter(u => u.status === 'rejected');
            const idades = aprovados.map(u => idadeFrom(u.dataNascimento)).filter(x => typeof x === 'number');
            const mediaIdade = idades.length ? Math.round(idades.reduce((a,b)=>a+b,0)/idades.length) : 0;

            const kA = document.getElementById('kpiAprovados');
            const kP = document.getElementById('kpiPendentes');
            const kR = document.getElementById('kpiRejeitados');
            const kI = document.getElementById('kpiIdade');
            if (kA) kA.textContent = String(aprovados.length);
            if (kP) kP.textContent = String(pendentes.length);
            if (kR) kR.textContent = String(rejeitados.length);
            if (kI) kI.textContent = String(mediaIdade);

            const sexo = groupCount(aprovados, 'sexo');
            const bairros = groupCount(aprovados, 'bairro');
            const meses = groupByMonth(aprovados);
            chartSexo = upsertChart(chartSexo, 'chartSexo', 'pie', sexo.labels, sexo.values, 'Sexo');
            chartBairro = upsertChart(chartBairro, 'chartBairro', 'bar', bairros.labels.slice(0,10), bairros.values.slice(0,10), 'Top 10 Bairros');
            chartMes = upsertChart(chartMes, 'chartMes', 'line', meses.labels, meses.values, 'Inscrições por mês');
        }

        // Geração dinâmica de campos de relatório a partir dos dados aprovados
        function ensureDynamicReportFields() {
            const container = document.getElementById('report-fields');
            if (!container) return;
            const aprovados = allRegistrations.filter(u => u.status === 'approved');
            if (aprovados.length === 0) return;
            const sample = aprovados[0];
            const existing = new Set(Array.from(container.querySelectorAll('input[type="checkbox"]')).map(i => i.value));
            const keys = Object.keys(sample).filter(k => typeof sample[k] !== 'object' && !existing.has(k));
            keys.forEach(k => {
                const label = (k === 'dataNascimento') ? 'Data Nasc.' : (k === 'createdAt' ? 'Criado em' : k);
                const el = document.createElement('label');
                el.className = 'flex items-center';
                el.innerHTML = `<input type="checkbox" value="${k}" class="mr-2 rounded text-pink-500"> ${label}`;
                container.appendChild(el);
            });
        }

        // Atualizar dashboards e campos dinâmicos sempre que chegarem dados
        function onDataUpdated() {
            renderDashboard();
            ensureDynamicReportFields();
        }

        // Hook no snapshot: após atualizar listas, também renderizar dashboard
        const _origOnSnapshotHandler = loadAdminPanelData;
        // Mantemos a função original e chamamos onDataUpdated quando os dados mudarem (dentro de loadAdminPanelData já atualiza allRegistrations)
        // Para garantir, chamamos após 200ms em cada atualização
        const _oldLoadAdminPanelData = loadAdminPanelData;
        loadAdminPanelData = function() { _oldLoadAdminPanelData(); setTimeout(onDataUpdated, 200); };

        // Render inicial (se já houver dados)
        setTimeout(onDataUpdated, 500);

        
        // Inicializar ícones
        if (window.lucide) {
            lucide.createIcons();
        }

        // =================================================
        // Detecção de dispositivo (Mobile vs Desktop)
        // =================================================
        function detectDevice() {
            const ua = navigator.userAgent.toLowerCase();
            const isMobileUA = /mobi|android|iphone|ipad|tablet/.test(ua);
            const isSmall = matchMedia('(max-width: 768px)').matches;
            const isMobile = isMobileUA || isSmall;
            document.body.classList.toggle('is-mobile', isMobile);
            document.body.classList.toggle('is-desktop', !isMobile);
            const badge = document.getElementById('deviceBadge');
            if (badge) badge.textContent = `Modo: ${isMobile ? 'Mobile' : 'Desktop'}`;
        }
        window.addEventListener('resize', detectDevice);
        detectDevice();

    </script>
</body>
</html>
