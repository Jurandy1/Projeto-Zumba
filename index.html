<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Zumba Admin Pro</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Font (Inter) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Ícones (Lucide) -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <!-- Bibliotecas de Exportação (Excel e PDF) -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.28/dist/jspdf.plugin.autotable.min.js"></script>

    <style>
        /* Estilo base */
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        
        .zumba-gradient-text { 
            background: linear-gradient(135deg, #be185d 0%, #ec4899 100%); 
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent; 
        }

        /* Botões */
        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 0.5rem 1rem; font-weight: 500; border-radius: 0.375rem; transition: all 0.2s; cursor: pointer; }
        .btn-primary { background-color: #ec4899; color: white; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); } 
        .btn-primary:hover { background-color: #db2777; }
        .btn-secondary { background-color: white; color: #374151; border: 1px solid #d1d5db; } 
        .btn-secondary:hover { background-color: #f9fafb; border-color: #9ca3af; }
        .btn-danger { background-color: #ef4444; color: white; } 
        .btn-danger:hover { background-color: #dc2626; }
        .btn-success { background-color: #10b981; color: white; } 
        .btn-success:hover { background-color: #059669; }
        
        /* Botão WhatsApp */
        .btn-whatsapp { background-color: #25D366; color: white; }
        .btn-whatsapp:hover { background-color: #128C7E; }

        /* Inputs */
        .form-input, .form-select { width: 100%; padding: 0.5rem 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; background-color: white; transition: border-color 0.15s ease-in-out; }
        .form-input:focus, .form-select:focus { outline: none; border-color: #ec4899; box-shadow: 0 0 0 3px rgba(236, 72, 153, 0.1); }
        .form-input:read-only { background-color: #f3f4f6; cursor: not-allowed; }
        .form-label { display: block; margin-bottom: 0.25rem; font-size: 0.875rem; font-weight: 500; color: #374151; }

        /* Utils */
        .hidden-section { display: none !important; }
        
        /* Modal */
        #details-modal { position: fixed; inset: 0; z-index: 50; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,0.5); backdrop-filter: blur(2px); opacity: 0; transition: opacity 0.2s ease-in-out; }
        
        /* Nav Tabs */
        .nav-tab { padding: 0.75rem 1rem; font-weight: 500; color: #6b7280; border-bottom: 2px solid transparent; cursor: pointer; transition: all 0.2s; }
        .nav-tab:hover { color: #ec4899; } 
        .nav-tab.active { color: #ec4899; border-bottom-color: #ec4899; }
    </style>
</head>
<body class="text-gray-900">

    <div class="min-h-screen flex flex-col">

        <!-- ===== SEÇÃO DE LOGIN ===== -->
        <section id="login-view" class="flex-grow flex items-center justify-center p-4 bg-white">
            <div class="w-full max-w-md space-y-8">
                <div class="text-center">
                    <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-pink-100 mb-4">
                        <i data-lucide="music-2" class="w-8 h-8 text-pink-600"></i>
                    </div>
                    <h1 class="text-3xl font-bold zumba-gradient-text">Projeto Zumba</h1>
                    <p class="mt-2 text-gray-500">Área Administrativa e Inscrições</p>
                </div>
                
                <div class="bg-white p-8 border border-gray-200 rounded-xl shadow-lg">
                    <form id="admin-login-form" class="space-y-6">
                        <h2 class="text-lg font-semibold text-gray-700 border-b pb-2">Acesso Admin</h2>
                        <div><label for="admin-email" class="form-label">Email</label><input type="email" id="admin-email" class="form-input" required></div>
                        <div><label for="admin-password" class="form-label">Senha</label><input type="password" id="admin-password" class="form-input" required></div>
                        <button type="submit" class="w-full btn btn-primary">Entrar no Painel</button>
                    </form>
                    
                    <div class="mt-6">
                        <div class="relative"><div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-300"></div></div><div class="relative flex justify-center text-sm"><span class="px-2 bg-white text-gray-500">Participantes</span></div></div>
                        <button type="button" id="go-to-register-btn" class="mt-4 w-full btn btn-secondary font-bold text-pink-600 border-pink-200 hover:bg-pink-50">Preencher Nova Ficha de Inscrição</button>
                    </div>
                    <p id="auth-error" class="mt-2 text-sm text-center text-red-500"></p>
                </div>
            </div>
        </section>

        <!-- ===== SEÇÃO DE CADASTRO (PÚBLICO) ===== -->
        <section id="register-view" class="hidden-section flex-grow bg-gray-50 py-8 px-4">
            <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-xl overflow-hidden border border-gray-100">
                <div class="p-6 bg-white border-b border-gray-100 flex justify-between items-center">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800" id="form-title">Ficha de Inscrição</h1>
                        <p class="text-gray-500 text-sm" id="form-subtitle">Preencha todos os campos obrigatórios</p>
                    </div>
                    <button id="back-to-login-btn" class="text-gray-500 hover:text-gray-700 flex items-center gap-1 text-sm font-medium"><i data-lucide="arrow-left" class="w-4 h-4"></i> Voltar</button>
                </div>

                <form id="register-form" class="p-6 space-y-8">
                    <!-- Campo oculto para ID de edição -->
                    <input type="hidden" id="editing-id" value="">

                    <!-- Identificação -->
                    <div class="space-y-4">
                        <h3 class="text-lg font-semibold text-pink-600 flex items-center gap-2"><i data-lucide="clipboard-list" class="w-5 h-5"></i> Identificação</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div id="polo-container">
                                <label for="polo" class="form-label">Polo</label>
                                <input type="text" id="polo" class="form-input" placeholder="Digite seu Polo">
                            </div>
                            <div>
                                <label for="inscricao" class="form-label">N° Inscrição (Sequencial)</label>
                                <input type="text" id="inscricao" class="form-input bg-gray-100 font-bold text-pink-600" readonly value="Automático">
                            </div>
                            <div><label for="data" class="form-label">Data</label><input type="date" id="data" class="form-input bg-gray-100 cursor-not-allowed" required readonly></div>
                        </div>
                    </div>

                    <div class="border-t border-gray-100 my-4"></div>

                    <!-- Dados Pessoais -->
                    <div class="space-y-4">
                        <h3 class="text-lg font-semibold text-pink-600 flex items-center gap-2"><i data-lucide="user" class="w-5 h-5"></i> Dados Pessoais</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                             <div><label for="nome" class="form-label">Nome Completo</label><input type="text" id="nome" class="form-input" required></div>
                             <div>
                                <label class="form-label">Sexo</label>
                                <div class="flex gap-4 mt-2">
                                    <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="sexo" value="Feminino" class="text-pink-600 focus:ring-pink-500" required> Feminino</label>
                                    <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="sexo" value="Masculino" class="text-pink-600 focus:ring-pink-500" required> Masculino</label>
                                </div>
                            </div>
                            <div><label for="dataNascimento" class="form-label">Data de Nascimento</label><input type="date" id="dataNascimento" class="form-input" required></div>
                            <div><label for="idade" class="form-label">Idade</label><input type="number" id="idade" class="form-input bg-gray-100" readonly required></div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                             <div><label for="cep" class="form-label">CEP (Auto)</label><input type="text" id="cep" class="form-input" placeholder="00000-000" maxlength="9"></div>
                             <div><label for="telefone" class="form-label">Telefone (WhatsApp)</label><input type="tel" id="telefone" class="form-input" placeholder="(00) 00000-0000" maxlength="15"></div>
                             <div><label for="profissao" class="form-label">Profissão</label><input type="text" id="profissao" class="form-input"></div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="md:col-span-2"><label for="endereco" class="form-label">Endereço</label><input type="text" id="endereco" class="form-input"></div>
                            <div><label for="numero" class="form-label">N°</label><input type="text" id="numero" class="form-input"></div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                             <div><label for="bairro" class="form-label">Bairro</label><input type="text" id="bairro" class="form-input"></div>
                             <div><label for="cidade" class="form-label">Cidade</label><input type="text" id="cidade" class="form-input"></div>
                             <div><label for="uf" class="form-label">UF</label><input type="text" id="uf" class="form-input" maxlength="2"></div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div><label for="cpf" class="form-label">CPF</label><input type="text" id="cpf" class="form-input" placeholder="000.000.000-00" required maxlength="14"></div>
                            <div><label for="rg" class="form-label">RG (Só números)</label><input type="text" id="rg" class="form-input" required placeholder="Apenas números"></div>
                            <div>
                                <label class="form-label">Estado Civil</label>
                                <select id="estadoCivil" class="form-select">
                                    <option value="">Selecione...</option>
                                    <option value="Solteiro(a)">Solteiro(a)</option>
                                    <option value="Casado(a)">Casado(a)</option>
                                    <option value="Divorciado(a)">Divorciado(a)</option>
                                    <option value="Viúvo(a)">Viúvo(a)</option>
                                    <option value="União Estável">União Estável</option>
                                </select>
                            </div>
                            <div><label class="form-label">Empregado?</label><select id="empregado" class="form-select"><option value="Sim">Sim</option><option value="Não">Não</option></select></div>
                        </div>
                         <div class="grid grid-cols-1 gap-4 mt-4 md:grid-cols-2">
                             <div><label class="form-label">Mora em casa própria?</label><select id="casaPropria" class="form-select"><option value="Sim">Sim</option><option value="Não">Não</option></select></div>
                             <div><label for="zona" class="form-label">Zona (Eleitoral)</label><input type="text" id="zona" class="form-input"></div>
                        </div>
                    </div>

                    <div class="border-t border-gray-100 my-4"></div>

                    <!-- Medidas -->
                    <div class="space-y-4">
                         <h3 class="text-lg font-semibold text-pink-600 flex items-center gap-2"><i data-lucide="shirt" class="w-5 h-5"></i> Medidas</h3>
                        <div>
                            <label class="form-label mb-2">Tamanho da Camisa</label>
                            <div class="flex flex-wrap gap-3">
                                <label class="cursor-pointer border px-3 py-2 rounded hover:bg-pink-50 has-[:checked]:bg-pink-100 has-[:checked]:border-pink-500 has-[:checked]:text-pink-700 font-medium text-sm transition-colors"><input type="radio" name="camisa" value="PP" class="hidden"> PP</label>
                                <label class="cursor-pointer border px-3 py-2 rounded hover:bg-pink-50 has-[:checked]:bg-pink-100 has-[:checked]:border-pink-500 has-[:checked]:text-pink-700 font-medium text-sm transition-colors"><input type="radio" name="camisa" value="P" class="hidden"> P</label>
                                <label class="cursor-pointer border px-3 py-2 rounded hover:bg-pink-50 has-[:checked]:bg-pink-100 has-[:checked]:border-pink-500 has-[:checked]:text-pink-700 font-medium text-sm transition-colors"><input type="radio" name="camisa" value="M" class="hidden"> M</label>
                                <label class="cursor-pointer border px-3 py-2 rounded hover:bg-pink-50 has-[:checked]:bg-pink-100 has-[:checked]:border-pink-500 has-[:checked]:text-pink-700 font-medium text-sm transition-colors"><input type="radio" name="camisa" value="G" class="hidden"> G</label>
                                <label class="cursor-pointer border px-3 py-2 rounded hover:bg-pink-50 has-[:checked]:bg-pink-100 has-[:checked]:border-pink-500 has-[:checked]:text-pink-700 font-medium text-sm transition-colors"><input type="radio" name="camisa" value="GG" class="hidden"> GG</label>
                                <div class="flex items-center gap-2">
                                    <label class="cursor-pointer border px-3 py-2 rounded hover:bg-pink-50 has-[:checked]:bg-pink-100 has-[:checked]:border-pink-500 has-[:checked]:text-pink-700 font-medium text-sm transition-colors"><input type="radio" name="camisa" value="Outro" class="hidden"> Outro</label>
                                    <input type="text" id="camisaOutro" class="form-input py-1 text-sm w-32" placeholder="Qual?">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="border-t border-gray-100 my-4"></div>

                    <!-- Saúde -->
                    <div class="space-y-4">
                        <h3 class="text-lg font-semibold text-pink-600 flex items-center gap-2"><i data-lucide="activity" class="w-5 h-5"></i> Saúde e Bem-estar</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-6 gap-y-4 bg-gray-50 p-4 rounded-lg">
                            <template id="health-question-template">
                                <div class="flex items-center justify-between gap-4 p-2 bg-white rounded border border-gray-200">
                                    <label class="text-sm font-medium text-gray-700"></label>
                                    <select class="form-select w-24 text-sm py-1"><option value="Não">Não</option><option value="Sim">Sim</option></select>
                                </div>
                            </template>
                            <div id="health-questions-container" class="contents"></div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                             <div><label for="tipoSanguineo" class="form-label">Tipo Sanguíneo</label><input type="text" id="tipoSanguineo" class="form-input"></div>
                             <div class="col-span-1 md:col-span-2 space-y-3">
                                <div class="flex gap-2 items-center"><label class="w-1/3 text-sm font-medium">Alergias?</label><select id="alergias" class="form-select w-24 py-1 text-sm"><option value="Não">Não</option><option value="Sim">Sim</option></select><input type="text" id="alergiasQual" class="form-input py-1 text-sm" placeholder="Se sim, quais?"></div>
                                <div class="flex gap-2 items-center"><label class="w-1/3 text-sm font-medium">Cirurgia Recente?</label><select id="cirurgiaRecente" class="form-select w-24 py-1 text-sm"><option value="Não">Não</option><option value="Sim">Sim</option></select><input type="text" id="cirurgiaRecenteQual" class="form-input py-1 text-sm" placeholder="Qual?"></div>
                                <div class="flex gap-2 items-center"><label class="w-1/3 text-sm font-medium">Tratamento Médico?</label><select id="tratamentoMedico" class="form-select w-24 py-1 text-sm"><option value="Não">Não</option><option value="Sim">Sim</option></select><input type="text" id="tratamentoMedicoQual" class="form-input py-1 text-sm" placeholder="Qual?"></div>
                                <div class="flex gap-2 items-center"><label class="w-1/3 text-sm font-medium">Uso de medicamentos?</label><select id="tomaMedicamento" class="form-select w-24 py-1 text-sm"><option value="Não">Não</option><option value="Sim">Sim</option></select><input type="text" id="tomaMedicamentoQual" class="form-input py-1 text-sm" placeholder="Quais?"></div>
                                <div class="flex gap-2 items-center"><label class="w-1/3 text-sm font-medium">Problema Ortopédico?</label><select id="problemaOrtopedico" class="form-select w-24 py-1 text-sm"><option value="Não">Não</option><option value="Sim">Sim</option></select><input type="text" id="problemaOrtopedicoQual" class="form-input py-1 text-sm" placeholder="Qual?"></div>
                             </div>
                        </div>
                    </div>

                    <div class="pt-6">
                        <button type="submit" id="submit-register-btn" class="w-full btn btn-primary py-3 text-lg shadow-lg transform transition-transform hover:scale-[1.01]">
                            <span id="submit-text">Confirmar Inscrição</span>
                            <span id="submit-loading" class="hidden-section flex items-center gap-2"><i data-lucide="loader-2" class="animate-spin w-5 h-5"></i> Processando...</span>
                        </button>
                        <p id="register-message" class="mt-4 text-center text-sm font-medium"></p>
                    </div>
                </form>
            </div>
        </section>

        <!-- ===== PAINEL DO ADMIN ===== -->
        <section id="admin-panel" class="hidden-section flex-grow flex flex-col bg-gray-100">
            <header class="bg-white shadow-sm z-30 sticky top-0">
                <div class="container mx-auto px-4 h-16 flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 bg-gradient-to-br from-pink-500 to-purple-600 rounded-lg flex items-center justify-center text-white">
                            <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                        </div>
                        <span class="font-bold text-xl text-gray-800 tracking-tight">Painel Admin</span>
                    </div>
                    <div class="flex items-center gap-4">
                        <span class="text-sm text-gray-500 hidden md:inline">Administrador</span>
                        <button id="admin-logout-btn" class="btn btn-secondary text-sm py-1.5 px-3 flex items-center gap-2 text-red-600 hover:bg-red-50 border-red-100">
                            <i data-lucide="log-out" class="w-4 h-4"></i> Sair
                        </button>
                    </div>
                </div>
                
                <div class="container mx-auto px-4 border-t border-gray-100">
                    <nav class="flex gap-6 overflow-x-auto" id="admin-tabs">
                        <button class="nav-tab active" data-tab="dashboard"><i data-lucide="bar-chart-2" class="w-4 h-4 inline mr-1"></i> Visão Geral</button>
                        <button class="nav-tab" data-tab="participants"><i data-lucide="users" class="w-4 h-4 inline mr-1"></i> Participantes</button>
                        <button class="nav-tab" data-tab="reports"><i data-lucide="file-text" class="w-4 h-4 inline mr-1"></i> Relatórios</button>
                        <button class="nav-tab" data-tab="settings"><i data-lucide="settings" class="w-4 h-4 inline mr-1"></i> Configurações</button>
                        <button class="nav-tab" data-tab="rejected"><i data-lucide="trash-2" class="w-4 h-4 inline mr-1"></i> Lixeira</button>
                    </nav>
                </div>
            </header>

            <main class="container mx-auto px-4 py-8 flex-grow">
                <!-- TABS CONTENT -->
                <div id="tab-dashboard" class="admin-tab-content space-y-6">
                    <div id="admin-stats" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"></div>
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                        <div class="p-4 border-b border-gray-100 bg-yellow-50 flex justify-between items-center"><h2 class="text-lg font-bold text-yellow-800 flex items-center gap-2"><i data-lucide="alert-circle" class="w-5 h-5"></i> Inscrições Pendentes</h2><span class="text-xs font-semibold bg-yellow-200 text-yellow-800 px-2 py-1 rounded-full" id="pending-count-badge">0</span></div>
                        <div class="p-4"><div id="pending-registrations-list" class="space-y-3"></div><div id="no-pending-message" class="text-center py-8 text-gray-400 hidden-section"><i data-lucide="check-circle-2" class="w-12 h-12 mx-auto mb-2 text-green-400"></i><p>Tudo limpo! Nenhuma inscrição pendente.</p></div></div>
                    </div>
                </div>

                <div id="tab-participants" class="admin-tab-content hidden-section bg-white rounded-lg shadow-sm border border-gray-200 flex flex-col h-[calc(100vh-12rem)]">
                    <div class="p-4 border-b border-gray-200 flex flex-col md:flex-row gap-4 justify-between items-center bg-gray-50">
                        <h2 class="text-lg font-bold text-gray-700">Base de Dados</h2>
                        <div class="flex gap-2 w-full md:w-auto"><div class="relative w-full md:w-64"><i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"></i><input id="admin-search" type="text" class="form-input pl-10 text-sm" placeholder="Buscar nome, CPF..."></div><select id="admin-sort" class="form-select w-auto text-sm"><option value="date_desc">Recentes</option><option value="name_asc">Nome A-Z</option></select></div>
                    </div>
                    <div class="flex-grow overflow-auto">
                        <table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-100 sticky top-0 z-10"><tr><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome / N° Insc.</th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">CPF / RG</th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cidade / Bairro</th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Camisa</th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th><th scope="col" class="relative px-6 py-3"><span class="sr-only">Ações</span></th></tr></thead><tbody id="all-participants-table-body" class="bg-white divide-y divide-gray-200"></tbody></table>
                        <div id="no-participants-message" class="text-center py-12 text-gray-400 hidden-section">Nenhum registro encontrado.</div>
                    </div>
                    <div class="p-2 border-t border-gray-200 bg-gray-50 text-xs text-gray-500 text-right" id="table-footer-count">Carregando...</div>
                </div>

                <div id="tab-reports" class="admin-tab-content hidden-section space-y-6">
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                        <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2"><div class="p-2 bg-blue-100 text-blue-600 rounded-lg"><i data-lucide="filter"></i></div> Filtros de Relatório</h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4 mb-6">
                            <div><label class="form-label">Status</label><select id="report-status-filter" class="form-select text-sm"><option value="approved">Aprovados</option><option value="all">Todos</option><option value="pending">Pendentes</option></select></div>
                            <div><label class="form-label">Tamanho Camisa</label><select id="report-camisa-filter" class="form-select text-sm"><option value="all">Todos</option><option value="P">P</option><option value="M">M</option><option value="G">G</option><option value="GG">GG</option></select></div>
                            <div><label class="form-label">Sexo</label><select id="report-sexo-filter" class="form-select text-sm"><option value="all">Todos</option><option value="Feminino">Feminino</option><option value="Masculino">Masculino</option></select></div>
                            <div><label class="form-label">Cidade</label><input type="text" id="report-city-filter" class="form-input text-sm" placeholder="Ex: São Paulo"></div>
                            <div><label class="form-label">Idade Mín.</label><input type="number" id="report-age-min" class="form-input text-sm"></div>
                            <div><label class="form-label">Idade Máx.</label><input type="number" id="report-age-max" class="form-input text-sm"></div>
                            <div><label class="form-label">Data Início</label><input type="date" id="report-date-start" class="form-input text-sm"></div>
                            <div><label class="form-label">Data Fim</label><input type="date" id="report-date-end" class="form-input text-sm"></div>
                        </div>
                        <div class="bg-gray-50 p-4 rounded border border-gray-100 mb-6">
                            <h3 class="text-sm font-semibold text-gray-700 mb-3">Colunas Visíveis</h3>
                            <div id="report-fields" class="flex flex-wrap gap-4 text-sm">
                                <label class="flex items-center gap-2"><input type="checkbox" value="nome" checked class="text-pink-600 rounded"> Nome</label>
                                <label class="flex items-center gap-2"><input type="checkbox" value="camisa" checked class="text-pink-600 rounded"> Camisa</label>
                                <label class="flex items-center gap-2"><input type="checkbox" value="telefone" checked class="text-pink-600 rounded"> Telefone</label>
                                <label class="flex items-center gap-2"><input type="checkbox" value="idade" checked class="text-pink-600 rounded"> Idade</label>
                                <label class="flex items-center gap-2"><input type="checkbox" value="bairro" checked class="text-pink-600 rounded"> Bairro</label>
                                <label class="flex items-center gap-2"><input type="checkbox" value="status" class="text-pink-600 rounded"> Status</label>
                                <label class="flex items-center gap-2"><input type="checkbox" value="cpf" class="text-pink-600 rounded"> CPF</label>
                                <label class="flex items-center gap-2"><input type="checkbox" value="inscricao" class="text-pink-600 rounded"> N° Insc.</label>
                                
                                <!-- NOVOS CAMPOS PARA RELATÓRIO -->
                                <label class="flex items-center gap-2"><input type="checkbox" value="zona" class="text-pink-600 rounded"> Zona Eleitoral</label>
                                <label class="flex items-center gap-2"><input type="checkbox" value="tipoSanguineo" class="text-pink-600 rounded"> Tipo Sang.</label>
                                <label class="flex items-center gap-2"><input type="checkbox" value="alergias" class="text-pink-600 rounded"> Alergias</label>
                                <label class="flex items-center gap-2"><input type="checkbox" value="cirurgiaRecente" class="text-pink-600 rounded"> Cirurgia</label>
                                <label class="flex items-center gap-2"><input type="checkbox" value="tratamentoMedico" class="text-pink-600 rounded"> Tratamento</label>
                                <label class="flex items-center gap-2"><input type="checkbox" value="tomaMedicamento" class="text-pink-600 rounded"> Medicamento</label>
                                <label class="flex items-center gap-2"><input type="checkbox" value="problemaOrtopedico" class="text-pink-600 rounded"> Prob. Ortop.</label>
                                <label class="flex items-center gap-2"><input type="checkbox" value="bebidaAlcoolica" class="text-pink-600 rounded"> Bebida</label>
                                <label class="flex items-center gap-2"><input type="checkbox" value="fumante" class="text-pink-600 rounded"> Fumante</label>
                                <label class="flex items-center gap-2"><input type="checkbox" value="doadorSangue" class="text-pink-600 rounded"> Doador</label>
                                <label class="flex items-center gap-2"><input type="checkbox" value="cardiaco" class="text-pink-600 rounded"> Cardíaco</label>
                                <label class="flex items-center gap-2"><input type="checkbox" value="hipertenso" class="text-pink-600 rounded"> Hipertenso</label>
                                <label class="flex items-center gap-2"><input type="checkbox" value="diabetico" class="text-pink-600 rounded"> Diabético</label>
                            </div>
                        </div>
                        <div class="flex gap-3"><button id="generate-report-btn" class="btn btn-primary"><i data-lucide="search" class="w-4 h-4 mr-2"></i> Gerar Resultado</button><button id="clear-filters-btn" class="btn btn-secondary">Limpar</button></div>
                    </div>
                    <div id="report-results-container" class="hidden-section bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 bg-blue-50 p-4 rounded-lg border border-blue-100">
                            <div class="text-center border-r border-blue-200 last:border-0"><span class="block text-sm text-blue-600 font-semibold">Total</span><span class="text-3xl font-bold text-gray-800" id="summary-total">0</span></div>
                            <div class="col-span-2 text-sm pl-4"><p class="font-semibold text-blue-800 mb-1">Resumo de Camisas:</p><div id="summary-camisas" class="flex flex-wrap gap-2"></div></div>
                        </div>
                        <div class="overflow-x-auto border rounded mb-4"><table class="min-w-full divide-y divide-gray-200" id="report-table"><thead class="bg-gray-50" id="report-table-head"></thead><tbody class="bg-white divide-y divide-gray-200 text-sm" id="report-table-body"></tbody></table></div>
                        <div class="flex justify-end gap-2"><button id="export-csv-btn" class="btn btn-secondary text-sm gap-2"><i data-lucide="file-spreadsheet" class="w-4 h-4"></i> CSV</button><button id="export-xlsx-btn" class="btn btn-secondary text-sm gap-2"><i data-lucide="sheet" class="w-4 h-4"></i> Excel</button><button id="export-pdf-btn" class="btn btn-secondary text-sm gap-2"><i data-lucide="file-text" class="w-4 h-4"></i> PDF</button></div>
                    </div>
                </div>
                
                <div id="tab-settings" class="admin-tab-content hidden-section">
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                        <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2"><i data-lucide="settings" class="w-5 h-5 text-gray-500"></i> Configurações do Sistema</h2>
                        <div class="space-y-6">
                            <div class="bg-gray-50 p-4 rounded-lg border border-gray-100">
                                <label class="block text-sm font-bold text-gray-700 mb-2">Lista de Polos (Separados por vírgula)</label>
                                <p class="text-xs text-gray-500 mb-2">Ex: Centro, Zona Norte, Zona Sul. Se deixar vazio, o campo será de texto livre na ficha.</p>
                                <textarea id="settings-polos" class="form-input w-full h-24" placeholder="Ex: Polo Centro, Polo Norte..."></textarea>
                                <button id="save-settings-btn" class="mt-2 btn btn-primary text-sm">Salvar Configurações</button>
                            </div>
                            <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-100">
                                <label class="block text-sm font-bold text-yellow-800 mb-2"><i data-lucide="alert-triangle" class="w-4 h-4 inline mr-1"></i> Zona de Perigo: Renumeração</label>
                                <p class="text-xs text-yellow-700 mb-2">Isso irá percorrer <b>TODOS</b> os cadastros e atualizar o "Nº de Inscrição" para uma sequência perfeita (001, 002, 003...) baseada na data de criação. Use se a numeração estiver bagunçada.</p>
                                <button id="renumber-all-btn" class="btn btn-danger text-sm"><span id="renumber-text">Renumerar Todas as Inscrições</span><span id="renumber-loading" class="hidden-section">Processando...</span></button>
                                <p id="renumber-status" class="mt-2 text-xs font-bold"></p>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="tab-rejected" class="admin-tab-content hidden-section">
                    <div class="bg-white rounded-lg shadow-sm border border-red-200 overflow-hidden">
                        <div class="p-4 bg-red-50 border-b border-red-100"><h2 class="text-lg font-bold text-red-700 flex items-center gap-2"><i data-lucide="trash" class="w-5 h-5"></i> Inscrições Rejeitadas</h2></div>
                        <div class="p-4" id="rejected-registrations-list"></div>
                        <div id="no-rejected-message" class="p-8 text-center text-gray-400 hidden-section">Lixeira vazia.</div>
                    </div>
                </div>
            </main>
        </section>

        <!-- ===== MODAL ===== -->
        <div id="details-modal">
            <div class="bg-white rounded-lg shadow-2xl w-full max-w-2xl mx-4 max-h-[90vh] flex flex-col">
                <div class="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-lg">
                    <h3 class="font-bold text-lg text-gray-800">Editar Inscrição</h3>
                    <button id="close-modal-btn" class="text-gray-400 hover:text-gray-600"><i data-lucide="x" class="w-6 h-6"></i></button>
                </div>
                <div class="p-6 overflow-y-auto flex-grow">
                    <form id="edit-form" class="space-y-4">
                        <input type="hidden" id="edit-doc-id">
                        <div class="flex gap-4 p-3 bg-gray-50 rounded border border-gray-200">
                            <div class="flex-grow"><label class="text-xs font-bold text-gray-500 uppercase">Status</label><select id="edit-status" class="form-select mt-1"><option value="pending">Pendente</option><option value="approved">Aprovado</option><option value="rejected">Rejeitado</option></select></div>
                            <div class="flex-grow"><label class="text-xs font-bold text-gray-500 uppercase">Nome</label><input type="text" id="edit-nome" class="form-input mt-1"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="form-label text-sm">Camisa</label><input type="text" id="edit-camisa" class="form-input"></div>
                            <div><label class="form-label text-sm">Sexo</label><input type="text" id="edit-sexo" class="form-input"></div>
                            <div><label class="form-label text-sm">CPF</label><input type="text" id="edit-cpf" class="form-input"></div>
                            <div><label class="form-label text-sm">Telefone</label><input type="text" id="edit-telefone" class="form-input"></div>
                            <div><label class="form-label text-sm">Cidade</label><input type="text" id="edit-cidade" class="form-input"></div>
                            <div><label class="form-label text-sm">Bairro</label><input type="text" id="edit-bairro" class="form-input"></div>
                        </div>
                         <div class="border-t pt-4 mt-4">
                            <h4 class="text-sm font-bold text-gray-500 mb-2">Outros Dados</h4>
                            <div class="grid grid-cols-3 gap-2"><input type="text" id="edit-idade" class="form-input text-sm" placeholder="Idade"><input type="text" id="edit-rg" class="form-input text-sm" placeholder="RG"><input type="date" id="edit-dataNascimento" class="form-input text-sm"></div>
                            <div class="mt-4 grid grid-cols-2 gap-2"><input type="text" id="edit-profissao" class="form-input text-sm" placeholder="Profissão"><input type="text" id="edit-estadoCivil" class="form-input text-sm" placeholder="Estado Civil"></div>
                         </div>
                    </form>
                </div>
                <div class="p-4 border-t bg-gray-50 rounded-b-lg flex justify-between"><button id="modal-delete-btn" class="btn btn-danger text-sm">Excluir Registro</button><button id="modal-save-btn" class="btn btn-success text-sm">Salvar Alterações</button></div>
                 <p id="modal-message" class="text-center text-xs pb-2"></p>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signInAnonymously, signOut, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, getDoc, updateDoc, deleteDoc, onSnapshot, setDoc, getCountFromServer, getDocs, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ===========================================
        // CONFIGURAÇÃO DO FIREBASE
        // ===========================================
        const firebaseConfig = {
          apiKey: "AIzaSyCrH_LFHenyWx-ITRCTWeNVqf8O-0e3pJY",
          authDomain: "zumba-2a827.firebaseapp.com",
          projectId: "zumba-2a827",
          storageBucket: "zumba-2a827.firebasestorage.app",
          messagingSenderId: "325248310095",
          appId: "1:325248310095:web:2673845967b7bc60f6833a"
        };
        const ADMIN_UID = "mNenvFEpf1SnDCY2kXLUaDlgtP03"; 
        const INSCRICOES_COLLECTION = "inscricoes_zumba";
        const SETTINGS_COLLECTION = "config_zumba";

        // Inicialização
        var app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (error) { console.error("Firebase Error:", error); }

        // Elementos DOM principais
        const views = {
            login: document.getElementById('login-view'),
            register: document.getElementById('register-view'),
            admin: document.getElementById('admin-panel')
        };
        
        // ===========================================
        // NAVEGAÇÃO E AUTENTICAÇÃO
        // ===========================================
        
        // Lógica das Abas do Admin
        const adminTabs = document.querySelectorAll('.nav-tab');
        const adminTabContents = document.querySelectorAll('.admin-tab-content');
        
        adminTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                adminTabs.forEach(t => t.classList.remove('active'));
                adminTabContents.forEach(c => c.classList.add('hidden-section'));
                
                tab.classList.add('active');
                const targetId = `tab-${tab.dataset.tab}`;
                document.getElementById(targetId).classList.remove('hidden-section');
            });
        });

        // Alternar Telas e Lógica de Link de Edição
        const showView = async (viewName) => {
            Object.values(views).forEach(el => el.classList.add('hidden-section'));
            views[viewName].classList.remove('hidden-section');
            
            // Lógica de Registro (Create or Edit)
            if(viewName === 'register') {
                // Checar se é edição via URL
                const urlParams = new URLSearchParams(window.location.search);
                const editId = urlParams.get('edit_id');
                
                if (!auth.currentUser) {
                    signInAnonymously(auth).catch(e => console.warn("Modo offline/sem auth", e));
                }
                
                if (editId) {
                    await loadDataForEdit(editId);
                } else {
                    initRegisterForm(); // Modo Criar
                }
            }
            if(window.lucide) lucide.createIcons();
        };

        // Monitorar Estado de Login
        onAuthStateChanged(auth, (user) => {
            const urlParams = new URLSearchParams(window.location.search);
            const isEditing = urlParams.has('edit_id');

            if (user) {
                if (user.uid === ADMIN_UID && !isEditing) {
                    showView('admin');
                    initAdminPanel();
                } else if (!user.isAnonymous && !isEditing) {
                    // Usuário logado mas não é admin e não é anônimo
                    signOut(auth);
                    showView('login');
                } else if (isEditing) {
                    showView('register');
                }
            } else {
                // Se não estiver na tela de registro (ou editando), manda pro login
                if (document.getElementById('register-view').classList.contains('hidden-section') && !isEditing) {
                     showView('login');
                } else {
                     showView('register');
                }
            }
        });

        // Login Admin
        document.getElementById('admin-login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('admin-email').value;
            const pass = document.getElementById('admin-password').value;
            try {
                await setPersistence(auth, browserLocalPersistence);
                await signInWithEmailAndPassword(auth, email, pass);
            } catch (e) {
                document.getElementById('auth-error').textContent = 'Credenciais inválidas.';
            }
        });

        // Logout
        document.getElementById('admin-logout-btn').addEventListener('click', () => {
            signOut(auth).then(() => {
                window.history.replaceState({}, document.title, window.location.pathname); // Limpa URL
                window.location.reload();
            });
        });

        // Botões de Navegação
        document.getElementById('go-to-register-btn').addEventListener('click', () => showView('register'));
        document.getElementById('back-to-login-btn').addEventListener('click', () => {
             if(auth.currentUser?.isAnonymous) signOut(auth);
             window.history.replaceState({}, document.title, window.location.pathname); // Limpa URL de edit_id
             showView('login');
        });

        // ===========================================
        // MÁSCARAS E FORMATAÇÃO
        // ===========================================
        const maskCPF = (v) => {
            v = v.replace(/\D/g, "").slice(0, 11);
            return v.replace(/(\d{3})(\d)/, "$1.$2")
                    .replace(/(\d{3})(\d)/, "$1.$2")
                    .replace(/(\d{3})(\d{1,2})$/, "$1-$2");
        };
        const maskPhone = (v) => {
             v = v.replace(/\D/g, "").slice(0, 11);
             if (v.length > 10) return v.replace(/^(\d\d)(\d{5})(\d{4}).*/, "($1) $2-$3");
             return v.replace(/^(\d\d)(\d{4})(\d{0,4}).*/, "($1) $2-$3");
        };
        const maskCEP = (v) => {
            v = v.replace(/\D/g, "").slice(0, 8);
            return v.replace(/^(\d{5})(\d)/, "$1-$2");
        };
        
        async function fetchAddress(cep) {
            try {
                const res = await fetch(`https://viacep.com.br/ws/${cep.replace(/\D/g, '')}/json/`);
                const data = await res.json();
                if (!data.erro) {
                    if(document.getElementById('endereco')) document.getElementById('endereco').value = data.logradouro;
                    if(document.getElementById('bairro')) document.getElementById('bairro').value = data.bairro;
                    if(document.getElementById('cidade')) document.getElementById('cidade').value = data.localidade;
                    if(document.getElementById('uf')) document.getElementById('uf').value = data.uf;
                }
            } catch(e) {}
        }

        // ===========================================
        // LÓGICA DE CADASTRO (Register & Edit)
        // ===========================================
        
        // Carregar dados para edição
        async function loadDataForEdit(id) {
            document.getElementById('submit-loading').classList.remove('hidden-section');
            document.getElementById('form-title').textContent = "Editando Inscrição";
            document.getElementById('form-subtitle').textContent = "Atualize seus dados e salve novamente.";
            document.getElementById('editing-id').value = id;
            document.getElementById('submit-text').textContent = "Salvar Alterações";
            
            initRegisterForm(true); // Carrega listeners mas não reseta data

            try {
                const docSnap = await getDoc(doc(db, INSCRICOES_COLLECTION, id));
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    // Preencher campos simples
                    const form = document.getElementById('register-form');
                    form.querySelectorAll('input:not([type=radio]), select').forEach(el => {
                        if (data[el.id]) el.value = data[el.id];
                    });
                    
                    // Preencher Radios
                    if(data.sexo) {
                        const r = form.querySelector(`input[name="sexo"][value="${data.sexo}"]`);
                        if(r) r.checked = true;
                    }
                    if(data.camisa) {
                        const r = form.querySelector(`input[name="camisa"][value="${data.camisa}"]`);
                        if(r) r.checked = true;
                        else {
                            const out = form.querySelector(`input[name="camisa"][value="Outro"]`);
                            if(out) out.checked = true;
                            document.getElementById('camisaOutro').value = data.camisa;
                        }
                    }
                    
                    // Preencher Saúde "Qual?"
                    ['alergias', 'cirurgiaRecente', 'tratamentoMedico', 'tomaMedicamento', 'problemaOrtopedico'].forEach(k => {
                        const val = data[k] || "Não";
                        if (val.startsWith('Sim')) {
                            document.getElementById(k).value = 'Sim';
                            const match = val.match(/\((.*?)\)/);
                            if(match) document.getElementById(k+'Qual').value = match[1];
                        } else {
                            document.getElementById(k).value = 'Não';
                        }
                    });
                    
                    // Preencher Polo (se não foi pego no loop simples)
                    if(data.polo) document.getElementById('polo').value = data.polo;

                } else {
                    alert("Inscrição não encontrada.");
                    window.location.href = window.location.pathname; // Volta pro início
                }
            } catch(e) {
                console.error("Erro ao carregar dados", e);
                alert("Erro ao carregar dados. Tente recarregar.");
            } finally {
                document.getElementById('submit-loading').classList.add('hidden-section');
            }
        }

        async function initRegisterForm(isEditing = false) {
            if(!isEditing) {
                document.getElementById('data').value = new Date().toISOString().split('T')[0];
                document.getElementById('editing-id').value = "";
                document.getElementById('form-title').textContent = "Ficha de Inscrição";
                document.getElementById('submit-text').textContent = "Confirmar Inscrição";
                
                try {
                    const snapshot = await getCountFromServer(collection(db, INSCRICOES_COLLECTION));
                    const nextId = String(snapshot.data().count + 1).padStart(3, '0');
                    document.getElementById('inscricao').value = nextId;
                } catch (e) { document.getElementById('inscricao').value = "Automático"; }
            }
            
            // Tenta buscar Polos
            try {
                const settingsDoc = await getDoc(doc(db, SETTINGS_COLLECTION, "geral"));
                const polosStr = settingsDoc.exists() ? (settingsDoc.data().polos || "") : "";
                
                if (polosStr.trim().length > 0) {
                    const polos = polosStr.split(',').map(p => p.trim()).filter(p => p);
                    const currentVal = document.getElementById('polo').value;
                    const options = polos.map(p => `<option value="${p}" ${p===currentVal?'selected':''}>${p}</option>`).join('');
                    document.getElementById('polo-container').innerHTML = `
                        <label for="polo" class="form-label">Polo</label>
                        <select id="polo" class="form-select">
                            <option value="">Selecione um Polo...</option>
                            ${options}
                        </select>
                    `;
                }
            } catch (e) { }

            // Listeners
            document.getElementById('cpf').oninput = (e) => e.target.value = maskCPF(e.target.value);
            document.getElementById('telefone').oninput = (e) => e.target.value = maskPhone(e.target.value);
            document.getElementById('cep').oninput = (e) => { e.target.value = maskCEP(e.target.value); if(e.target.value.length === 9) fetchAddress(e.target.value); };
            document.getElementById('rg').onkeydown = (e) => { if (!/[0-9]/.test(e.key) && e.key.length === 1 && !e.ctrlKey) e.preventDefault(); };
            document.getElementById('dataNascimento').onchange = function() { if(this.value) document.getElementById('idade').value = Math.abs(new Date(Date.now() - new Date(this.value).getTime()).getUTCFullYear() - 1970); };
            
            // Health Qs
            const hc = document.getElementById('health-questions-container');
            if(hc.children.length === 0) {
                const qs = [
                    {id:'bebidaAlcoolica',l:'Bebida Alcoólica?'},
                    {id:'fumante',l:'Fumante?'},
                    {id:'doadorSangue',l:'Doador de Sangue?'},
                    {id:'cardiaco',l:'Cardíaco?'},
                    {id:'hipertenso',l:'Hipertenso?'},
                    {id:'diabetico',l:'Diabético?'}
                ];
                const t = document.getElementById('health-question-template');
                qs.forEach(q => {
                    const c = t.content.cloneNode(true);
                    c.querySelector('label').textContent = q.l;
                    c.querySelector('select').id = q.id;
                    hc.appendChild(c);
                });
            }
        }

        // Submit do Formulário
        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submit-register-btn');
            const msg = document.getElementById('register-message');
            const editId = document.getElementById('editing-id').value;
            
            btn.disabled = true;
            document.getElementById('submit-loading').classList.remove('hidden-section');
            document.getElementById('submit-text').classList.add('hidden-section');
            
            try {
                const form = document.getElementById('register-form');
                const data = {};
                
                form.querySelectorAll('input:not([type=radio]), select').forEach(el => { if(el.id) data[el.id] = el.value; });
                const sex = form.querySelector('input[name="sexo"]:checked'); if(sex) data.sexo = sex.value;
                const shirt = form.querySelector('input[name="camisa"]:checked'); if(shirt) data.camisa = shirt.value === 'Outro' ? (document.getElementById('camisaOutro').value || 'Outro') : shirt.value;
                
                ['alergias', 'cirurgiaRecente', 'tratamentoMedico', 'tomaMedicamento', 'problemaOrtopedico'].forEach(k => {
                    const sel = document.getElementById(k);
                    if (sel && sel.value === 'Sim') data[k] = `Sim (${document.getElementById(k+'Qual').value || ''})`;
                });
                
                if(data.idade) data.idade = parseInt(data.idade);
                const poloEl = document.getElementById('polo'); if(poloEl) data.polo = poloEl.value;

                if (editId) {
                    // MODO EDIÇÃO
                    await updateDoc(doc(db, INSCRICOES_COLLECTION, editId), data);
                    msg.textContent = '✅ Dados atualizados com sucesso!';
                } else {
                    // MODO CRIAÇÃO
                    data.status = 'pending'; 
                    data.createdAt = new Date().toISOString();
                    try {
                        const snap = await getCountFromServer(collection(db, INSCRICOES_COLLECTION));
                        data.inscricao = String(snap.data().count + 1).padStart(3, '0');
                    } catch(e) { data.inscricao = "Pendente"; }
                    await addDoc(collection(db, INSCRICOES_COLLECTION), data);
                    msg.textContent = '✅ Inscrição realizada com sucesso!';
                }
                
                msg.className = 'mt-4 text-center text-sm font-medium text-green-600';
                
                setTimeout(() => {
                    if(auth.currentUser?.isAnonymous) signOut(auth);
                    // Remove parametros da URL e recarrega
                    window.history.replaceState({}, document.title, window.location.pathname);
                    window.location.reload();
                }, 2000);

            } catch (err) {
                console.error(err);
                msg.className = 'mt-4 text-center text-sm font-medium text-red-600';
                msg.textContent = err.code === 'permission-denied' ? 'Erro de Permissão. Ative o Auth Anônimo no Firebase.' : 'Erro ao enviar.';
                btn.disabled = false;
                document.getElementById('submit-loading').classList.add('hidden-section');
                document.getElementById('submit-text').classList.remove('hidden-section');
            }
        });

        // ===========================================
        // LÓGICA DO ADMIN
        // ===========================================
        var allData = [];
        var unsubscribe = null;

        function initAdminPanel() {
            if(unsubscribe) unsubscribe();
            
            getDoc(doc(db, SETTINGS_COLLECTION, "geral")).then(s => {
                if(s.exists()) document.getElementById('settings-polos').value = s.data().polos || "";
            });

            const q = collection(db, INSCRICOES_COLLECTION);
            unsubscribe = onSnapshot(q, (snap) => {
                allData = [];
                snap.forEach(d => {
                    let item = d.data();
                    item.id = d.id;
                    if(typeof item.idade === 'string') item.idade = parseInt(item.idade);
                    allData.push(item);
                });
                renderDashboard();
                renderTable();
                renderRejected();
            });
        }
        
        document.getElementById('save-settings-btn').addEventListener('click', async () => {
            try { await setDoc(doc(db, SETTINGS_COLLECTION, "geral"), { polos: document.getElementById('settings-polos').value }); alert('Salvo!'); } catch(e) { alert('Erro.'); }
        });

        document.getElementById('renumber-all-btn').addEventListener('click', async () => {
            if (!confirm("Renumerar TODOS os cadastros?")) return;
            const btn = document.getElementById('renumber-all-btn'); const status = document.getElementById('renumber-status');
            btn.disabled = true; status.textContent = "Processando...";
            try {
                const snap = await getDocs(query(collection(db, INSCRICOES_COLLECTION)));
                let docs = []; snap.forEach(d => docs.push({ id: d.id, ...d.data() }));
                docs.sort((a, b) => new Date(a.createdAt || 0) - new Date(b.createdAt || 0));
                for (let i = 0; i < docs.length; i++) {
                    const newId = String(i + 1).padStart(3, '0');
                    if (docs[i].inscricao !== newId) await updateDoc(doc(db, INSCRICOES_COLLECTION, docs[i].id), { inscricao: newId });
                    status.textContent = `Atualizando ${i+1}/${docs.length}...`;
                }
                status.textContent = "Concluído!"; status.className = "mt-2 text-xs font-bold text-green-600";
            } catch (e) { status.textContent = "Erro."; status.className = "mt-2 text-xs font-bold text-red-600"; }
            btn.disabled = false;
        });

        // Helpers Visuais e Links
        const getWhatsappLink = (phone) => {
            if(!phone) return '#';
            let num = phone.replace(/\D/g, '');
            if(num.length < 10) return '#'; 
            if(!num.startsWith('55')) num = '55' + num;
            return `https://wa.me/${num}`;
        };

        const copyEditLink = (id) => {
            // Pega a URL atual limpa (sem parametros antigos)
            const baseUrl = window.location.href.split('?')[0];
            const link = `${baseUrl}?edit_id=${id}`;
            
            navigator.clipboard.writeText(link).then(() => {
                alert('Link copiado!\n\nIMPORTANTE: Esse link só funcionará para outra pessoa se este site estiver publicado na internet (ex: Vercel, Firebase Hosting). Se você estiver usando um visualizador de teste, o link pode não abrir para outras pessoas.');
            }).catch(err => {
                console.error('Erro ao copiar: ', err);
                prompt("Copie o link manualmente:", link);
            });
        };

        function renderDashboard() {
            const total = allData.length;
            const approved = allData.filter(i => i.status === 'approved').length;
            const pending = allData.filter(i => !i.status || i.status === 'pending');
            const rejected = allData.filter(i => i.status === 'rejected').length;
            
            document.getElementById('admin-stats').innerHTML = `
                <div class="bg-white p-4 rounded-lg border-l-4 border-blue-500 shadow-sm flex justify-between"><div><p class="text-xs font-bold text-gray-400">TOTAL</p><p class="text-2xl font-bold">${total}</p></div><i data-lucide="users" class="text-gray-400"></i></div>
                <div class="bg-white p-4 rounded-lg border-l-4 border-green-500 shadow-sm flex justify-between"><div><p class="text-xs font-bold text-gray-400">APROVADOS</p><p class="text-2xl font-bold text-green-600">${approved}</p></div><i data-lucide="check-circle" class="text-green-400"></i></div>
                <div class="bg-white p-4 rounded-lg border-l-4 border-yellow-500 shadow-sm flex justify-between"><div><p class="text-xs font-bold text-gray-400">PENDENTES</p><p class="text-2xl font-bold text-yellow-600">${pending.length}</p></div><i data-lucide="clock" class="text-yellow-400"></i></div>
                <div class="bg-white p-4 rounded-lg border-l-4 border-red-500 shadow-sm flex justify-between"><div><p class="text-xs font-bold text-gray-400">REJEITADOS</p><p class="text-2xl font-bold text-red-600">${rejected}</p></div><i data-lucide="x-circle" class="text-red-400"></i></div>`;
            
            const list = document.getElementById('pending-registrations-list');
            const empty = document.getElementById('no-pending-message');
            document.getElementById('pending-count-badge').textContent = pending.length;
            
            if(pending.length === 0) {
                list.innerHTML = '';
                empty.classList.remove('hidden-section');
            } else {
                empty.classList.add('hidden-section');
                list.innerHTML = pending.map(i => `
                    <div class="bg-white p-3 rounded border shadow-sm flex justify-between items-center">
                        <div class="font-bold text-gray-700">${i.nome}<span class="text-xs font-normal text-gray-400 ml-2">#${i.inscricao||'?'}</span></div>
                        <div class="flex gap-2">
                            <a href="${getWhatsappLink(i.telefone)}" target="_blank" class="btn btn-whatsapp text-xs py-1 px-2" title="Chamar no Zap"><i data-lucide="message-circle" class="w-4 h-4"></i></a>
                            <button onclick="window.hA('${i.id}','approve')" class="btn btn-success text-xs py-1 px-2">OK</button>
                            <button onclick="window.oM('${i.id}')" class="btn btn-secondary text-xs py-1 px-2">Ver</button>
                        </div>
                    </div>
                `).join('');
            }
            if(window.lucide) lucide.createIcons();
        }

        function renderTable() {
            const q = document.getElementById('admin-search').value.toLowerCase();
            const s = document.getElementById('admin-sort').value;
            let d = allData.filter(i => (i.nome + i.cpf + i.email + i.inscricao).toLowerCase().includes(q) && i.status !== 'rejected');
            d.sort((a,b) => s === 'name_asc' ? (a.nome||'').localeCompare(b.nome||'') : new Date(b.createdAt || 0) - new Date(a.createdAt || 0));
            const tb = document.getElementById('all-participants-table-body');
            
            if(d.length === 0) {
                tb.innerHTML = '';
                document.getElementById('no-participants-message').classList.remove('hidden-section');
            } else {
                document.getElementById('no-participants-message').classList.add('hidden-section');
                tb.innerHTML = d.map(i => `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4"><span class="font-bold text-pink-600 bg-pink-50 px-2 rounded mr-2">#${i.inscricao||'--'}</span>${i.nome}</td>
                        <td class="px-6 py-4 text-sm text-gray-500">${i.cpf||'-'}</td>
                        <td class="px-6 py-4 text-sm text-gray-500">${i.cidade||'-'}</td>
                        <td class="px-6 py-4"><span class="px-2 text-xs font-semibold bg-gray-100 rounded">${i.camisa||'-'}</span></td>
                        <td class="px-6 py-4"><span class="px-2 text-xs font-semibold rounded-full ${i.status==='approved'?'bg-green-100 text-green-800':'bg-yellow-100 text-yellow-800'}">${i.status==='approved'?'Aprovado':'Pendente'}</span></td>
                        <td class="px-6 py-4 text-right flex gap-2 justify-end">
                            <button onclick="window.copyLink('${i.id}')" class="text-blue-600 hover:text-blue-800" title="Copiar Link de Edição"><i data-lucide="link" class="w-4 h-4"></i></button>
                            <a href="${getWhatsappLink(i.telefone)}" target="_blank" class="text-green-600 hover:text-green-800" title="WhatsApp"><i data-lucide="message-circle" class="w-4 h-4"></i></a>
                            <button onclick="window.oM('${i.id}')" class="text-pink-600 font-bold hover:underline">Editar</button>
                        </td>
                    </tr>
                `).join('');
            }
            document.getElementById('table-footer-count').textContent = `${d.length} registros`;
            if(window.lucide) lucide.createIcons();
        }
        
        document.getElementById('admin-search').addEventListener('input', renderTable);
        document.getElementById('admin-sort').addEventListener('change', renderTable);

        function renderRejected() {
            const r = allData.filter(i => i.status === 'rejected');
            const l = document.getElementById('rejected-registrations-list');
            if(r.length === 0) { l.innerHTML = ''; document.getElementById('no-rejected-message').classList.remove('hidden-section'); } else {
                document.getElementById('no-rejected-message').classList.add('hidden-section');
                l.innerHTML = r.map(i => `<div class="flex justify-between items-center p-3 bg-white border-b"><span class="font-bold text-gray-700">${i.nome}</span><button onclick="window.hA('${i.id}','approve')" class="text-xs text-green-600 hover:underline">Restaurar</button></div>`).join('');
            }
        }

        window.hA = async (id, act) => { if(!confirm('Confirma?')) return; try { await updateDoc(doc(db, INSCRICOES_COLLECTION, id), {status: act==='approve'?'approved':'rejected'}); } catch(e) { alert('Erro'); } };
        window.oM = (id) => { const i = allData.find(x => x.id === id); if(!i) return; const f = document.getElementById('edit-form'); f.querySelectorAll('input, select').forEach(el => { const k = el.id.replace('edit-', ''); if(i[k] !== undefined) el.value = i[k]; }); document.getElementById('details-modal').style.display='flex'; setTimeout(() => document.getElementById('details-modal').style.opacity=1, 10); document.getElementById('edit-doc-id').value=id; };
        window.copyLink = copyEditLink;
        
        document.getElementById('close-modal-btn').onclick = () => { document.getElementById('details-modal').style.opacity=0; setTimeout(() => document.getElementById('details-modal').style.display='none', 200); };
        document.getElementById('modal-save-btn').onclick = async () => {
            const id = document.getElementById('edit-doc-id').value; if(!id) return;
            const d = {}; document.getElementById('edit-form').querySelectorAll('input, select').forEach(el => { d[el.id.replace('edit-', '')] = el.value; });
            try { await updateDoc(doc(db, INSCRICOES_COLLECTION, id), d); alert('Salvo!'); document.getElementById('close-modal-btn').click(); } catch(e) { alert('Erro'); }
        };
        document.getElementById('modal-delete-btn').onclick = async () => { if(confirm('EXCLUIR?')) { try { await deleteDoc(doc(db, INSCRICOES_COLLECTION, document.getElementById('edit-doc-id').value)); document.getElementById('close-modal-btn').click(); } catch(e) { alert('Erro'); } }};

        // Relatórios (Expanded)
        document.getElementById('generate-report-btn').addEventListener('click', () => {
            const st = document.getElementById('report-status-filter').value;
            const sh = document.getElementById('report-camisa-filter').value;
            const sx = document.getElementById('report-sexo-filter').value;
            const ci = document.getElementById('report-city-filter').value.toLowerCase();
            
            const res = allData.filter(i => {
                if(st !== 'all' && (i.status||'pending') !== st) return false;
                if(sh !== 'all' && i.camisa !== sh) return false;
                if(sx !== 'all' && i.sexo !== sx) return false;
                if(ci && !(i.cidade||'').toLowerCase().includes(ci)) return false;
                return true;
            });
            
            document.getElementById('report-results-container').classList.remove('hidden-section');
            document.getElementById('summary-total').textContent = res.length;
            const cam = {}; res.forEach(r => cam[r.camisa] = (cam[r.camisa]||0)+1);
            document.getElementById('summary-camisas').innerHTML = Object.entries(cam).map(([k,v]) => `<span class="px-2 py-1 bg-white border rounded text-xs"><b>${k}:</b> ${v}</span>`).join('');
            
            const cols = Array.from(document.querySelectorAll('#report-fields input:checked')).map(c => c.value);
            document.getElementById('report-table-head').innerHTML = `<tr>${cols.map(c => `<th class="px-4 py-2 text-left font-bold uppercase">${c}</th>`).join('')}</tr>`;
            document.getElementById('report-table-body').innerHTML = res.map(r => `<tr class="border-b">${cols.map(c => `<td class="px-4 py-2">${r[c]||'-'}</td>`).join('')}</tr>`).join('');
            
            window.lastReport = { headers: cols, data: res.map(r => cols.map(c => r[c]||'')) };
        });
        
        document.getElementById('export-xlsx-btn').onclick = () => { if(window.lastReport) { const ws = XLSX.utils.aoa_to_sheet([window.lastReport.headers, ...window.lastReport.data]); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Relatorio"); XLSX.writeFile(wb, "relatorio.xlsx"); }};
        document.getElementById('export-pdf-btn').onclick = () => { if(window.lastReport) { const doc = new window.jspdf.jsPDF({orientation:'landscape'}); doc.autoTable({head:[window.lastReport.headers], body:window.lastReport.data}); doc.save("relatorio.pdf"); }};

        if(window.lucide) lucide.createIcons();
    </script>
</body>
</html>
