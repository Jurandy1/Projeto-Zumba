<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro Projeto Zumba - Admin Pro</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Font (Inter) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">

    <!-- Ícones (Lucide) -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <!-- Export libs -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.28/dist/jspdf.plugin.autotable.min.js"></script>

    <style>
        /* Estilo base com a fonte Inter */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0fdf4; /* Verde bem claro */
        }

        /* Tema Zumba: Cores vibrantes */
        .zumba-gradient {
            background: linear-gradient(135deg, #ec4899, #d946ef, #a855f7); /* Pink -> Fuchsia -> Roxo */
        }
        
        .zumba-gradient-alt {
            background: linear-gradient(135deg, #a3e635, #34d399, #22d3ee); /* Verde-limão -> Esmeralda -> Ciano */
        }

        .btn-zumba {
            padding: 0.75rem 1.5rem;
            font-weight: 700;
            color: #ffffff;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            transition: transform 300ms ease-in-out, background-color 300ms ease-in-out, box-shadow 300ms ease-in-out;
            background: linear-gradient(135deg, #ec4899, #e11d48);
            cursor: pointer;
        }
        .btn-zumba:hover { transform: scale(1.05); }
        
        .btn-zumba-alt {
            padding: 0.75rem 1.5rem;
            font-weight: 700;
            color: #ffffff;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            transition: transform 300ms ease-in-out, background-color 300ms ease-in-out, box-shadow 300ms ease-in-out;
            background: linear-gradient(135deg, #a3e635, #4d7c0f);
            cursor: pointer;
        }
        .btn-zumba-alt:hover { transform: scale(1.05); }
        
        .btn-zumba-secondary {
            padding: 0.5rem 1rem;
            font-weight: 600;
            color: #374151;
            background-color: #e5e7eb;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            transition: background-color 300ms ease-in-out, transform 300ms ease-in-out;
            cursor: pointer;
        }
        .btn-zumba-secondary:hover { background-color: #d1d5db; transform: scale(1.05); }

        /* Estilo para inputs */
        .form-input {
            width: 100%;
            padding: 0.5rem 1rem;
            margin-top: 0.25rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            box-shadow: 0 1px 2px 0 rgba(0,0,0,0.05);
            outline: none;
        }
        .form-input:focus { box-shadow: 0 0 0 2px #ec4899; border-color: transparent; }
        
        .form-select {
            width: 100%;
            padding: 0.5rem 1rem;
            margin-top: 0.25rem;
            background-color: #ffffff;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            box-shadow: 0 1px 2px 0 rgba(0,0,0,0.05);
            outline: none;
        }
        .form-select:focus { box-shadow: 0 0 0 2px #ec4899; border-color: transparent; }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
        }

        /* Ocultar/Mostrar seções */
        .hidden-section {
            display: none;
        }

        /* Estilo do Modal */
        #details-modal {
            position: fixed;
            inset: 0;
            z-index: 50;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.75);
            opacity: 0;
            transition: opacity 300ms ease-in-out;
        }
    </style>
</head>
<body class="antialiased text-gray-900">

    <!-- Container Principal -->
    <div class="container mx-auto p-4 md:p-8 max-w-7xl">

        <!-- ===== SEÇÃO DE LOGIN ===== -->
        <section id="login-view">
            <div class="flex flex-col items-center justify-center min-h-screen py-12">
                <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-2xl shadow-2xl">
                    <div class="text-center">
                        <h1 class="text-4xl font-black zumba-gradient bg-clip-text text-transparent">Projeto Zumba</h1>
                        <p class="mt-2 text-lg text-gray-600">Bem-vindo(a)!</p>
                    </div>
                    
                    <!-- Formulário de Login (Admin) -->
                    <form id="admin-login-form" class="space-y-4">
                        <h2 class="text-xl font-bold text-center text-gray-700">Login do Administrador</h2>
                        <div>
                            <label for="admin-email" class="form-label">Email</label>
                            <input type="email" id="admin-email" class="form-input" required>
                        </div>
                        <div>
                            <label for="admin-password" class="form-label">Senha</label>
                            <input type="password" id="admin-password" class="form-input" required>
                        </div>
                        <button type="submit" class="w-full btn-zumba">Entrar</button>
                    </form>
                    
                    <div class="relative flex items-center justify-center">
                        <div class="absolute inset-0 flex items-center">
                            <div class="w-full border-t border-gray-300"></div>
                        </div>
                        <div class="relative px-2 text-sm text-gray-500 bg-white">
                            ou
                        </div>
                    </div>

                    <!-- Botão para ir ao Cadastro -->
                    <button type="button" id="go-to-register-btn" class="w-full btn-zumba-alt">
                        Fazer Inscrição
                    </button>
                    
                    <p id="auth-error" class="text-sm text-center text-red-500"></p>
                </div>
            </div>
        </section>

        <!-- ===== SEÇÃO DE CADASTRO ===== -->
        <section id="register-view" class="hidden-section">
            <div class="max-w-4xl p-8 mx-auto space-y-8 bg-white rounded-2xl shadow-2xl">
                <div class="text-center">
                    <h1 class="text-4xl font-black zumba-gradient-alt bg-clip-text text-transparent">Ficha de Cadastro</h1>
                    <p class="mt-2 text-lg text-gray-600">Preencha seus dados para participar</p>
                </div>

                <form id="register-form" class="space-y-6">
                    
                    <!-- Seção 1: Dados Iniciais -->
                    <fieldset class="p-4 border rounded-lg">
                        <legend class="px-2 text-lg font-bold text-gray-800">Identificação</legend>
                        <div class="grid grid-cols-1 gap-4 md:grid-cols-3">
                            <div>
                                <label for="polo" class="form-label">Polo</label>
                                <input type="text" id="polo" class="form-input">
                            </div>
                            <div>
                                <label for="inscricao" class="form-label">N° Inscrição</label>
                                <input type="text" id="inscricao" class="form-input bg-gray-100" readonly>
                            </div>
                            <div>
                                <label for="data" class="form-label">Data</label>
                                <input type="date" id="data" class="form-input bg-gray-100" required readonly>
                            </div>
                        </div>
                    </fieldset>

                    <!-- Seção 2: Dados Pessoais -->
                    <fieldset class="p-4 border rounded-lg">
                        <legend class="px-2 text-lg font-bold text-gray-800">Dados Pessoais</legend>
                        <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
                             <div>
                                <label for="nome" class="form-label">Nome Completo</label>
                                <input type="text" id="nome" class="form-input" required>
                            </div>
                            <div>
                                <label class="form-label">Sexo</label>
                                <div class="flex items-center mt-2 space-x-4">
                                    <label class="flex items-center">
                                        <input type="radio" name="sexo" value="Masculino" class="text-pink-600 focus:ring-pink-500" required>
                                        <span class="ml-2">Masculino</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="radio" name="sexo" value="Feminino" class="text-pink-600 focus:ring-pink-500" required>
                                        <span class="ml-2">Feminino</span>
                                    </label>
                                </div>
                            </div>
                            <div>
                                <label for="dataNascimento" class="form-label">Data de Nascimento</label>
                                <input type="date" id="dataNascimento" class="form-input" required>
                            </div>
                            <div>
                                <label for="idade" class="form-label">Idade</label>
                                <input type="number" id="idade" class="form-input bg-gray-100" readonly required>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 gap-4 mt-4 md:grid-cols-3">
                            <div>
                                <label for="endereco" class="form-label">Endereço (Rua, Av.)</label>
                                <input type="text" id="endereco" class="form-input">
                            </div>
                            <div>
                                <label for="numero" class="form-label">N°</label>
                                <input type="text" id="numero" class="form-input">
                            </div>
                             <div>
                                <label for="bairro" class="form-label">Bairro</label>
                                <input type="text" id="bairro" class="form-input">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 gap-4 mt-4 md:grid-cols-4">
                            <div>
                                <label for="cep" class="form-label">CEP</label>
                                <input type="text" id="cep" class="form-input" placeholder="00000-000">
                            </div>
                            <div>
                                <label for="cidade" class="form-label">Cidade</label>
                                <input type="text" id="cidade" class="form-input">
                            </div>
                            <div>
                                <label for="uf" class="form-label">UF</label>
                                <input type="text" id="uf" class="form-input" maxlength="2" placeholder="EX">
                            </div>
                            <div>
                                <label for="telefone" class="form-label">Telefone</label>
                                <input type="tel" id="telefone" class="form-input" placeholder="(00) 00000-0000">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 gap-4 mt-4 md:grid-cols-3">
                            <div>
                                <label for="profissao" class="form-label">Profissão</label>
                                <input type="text" id="profissao" class="form-input">
                            </div>
                            <div>
                                <label class="form-label">Empregado?</label>
                                <select id="empregado" class="form-select">
                                    <option value="Sim">Sim</option>
                                    <option value="Não">Não</option>
                                </select>
                            </div>
                            <div>
                                <label for="estadoCivil" class="form-label">Estado Civil</label>
                                <input type="text" id="estadoCivil" class="form-input">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 gap-4 mt-4 md:grid-cols-4">
                            <div>
                                <label for="rg" class="form-label">RG</label>
                                <input type="text" id="rg" class="form-input" required>
                            </div>
                            <div>
                                <label for="cpf" class="form-label">CPF</label>
                                <input type="text" id="cpf" class="form-input" required placeholder="000.000.000-00">
                            </div>
                            <div>
                                <label for="titulo" class="form-label">Título</label>
                                <input type="text" id="titulo" class="form-input">
                            </div>
                            <div>
                                <label for="secao" class="form-label">Seção</label>
                                <input type="text" id="secao" class="form-input">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 gap-4 mt-4 md:grid-cols-2">
                             <div>
                                <label class="form-label">Mora em casa própria?</label>
                                <select id="casaPropria" class="form-select">
                                    <option value="Sim">Sim</option>
                                    <option value="Não">Não</option>
                                </select>
                            </div>
                            <div>
                                <label for="zona" class="form-label">Zona (Eleitoral)</label>
                                <input type="text" id="zona" class="form-input">
                            </div>
                        </div>
                    </fieldset>
                    
                    <!-- Seção 3: Medidas e Uploads -->
                    <fieldset class="p-4 border rounded-lg">
                        <legend class="px-2 text-lg font-bold text-gray-800">Medidas</legend>
                        <div>
                            <label class="form-label">Medida da Camisa</label>
                            <div class="flex flex-wrap gap-4 mt-2">
                                <label><input type="radio" name="camisa" value="PP" class="text-pink-600 focus:ring-pink-500"> PP</label>
                                <label><input type="radio" name="camisa" value="P" class="text-pink-600 focus:ring-pink-500"> P</label>
                                <label><input type="radio" name="camisa" value="M" class="text-pink-600 focus:ring-pink-500"> M</label>
                                <label><input type="radio" name="camisa" value="G" class="text-pink-600 focus:ring-pink-500"> G</label>
                                <label><input type="radio" name="camisa" value="GG" class="text-pink-600 focus:ring-pink-500"> GG</label>
                                <div>
                                    <label><input type="radio" name="camisa" value="Outro" class="text-pink-600 focus:ring-pink-500"> Outro:</label>
                                    <input type="text" id="camisaOutro" class="form-input inline-block w-auto ml-2" placeholder="Especifique">
                                </div>
                            </div>
                        </div>
                    </fieldset>

                    <!-- Seção 4: Histórico Patológico -->
                    <fieldset class="p-4 border rounded-lg">
                        <legend class="px-2 text-lg font-bold text-gray-800">Histórico Patológico (Saúde)</legend>
                        <div class="grid grid-cols-1 gap-y-4 gap-x-6 md:grid-cols-3">
                            <!-- Perguntas Sim/Não -->
                            <template id="health-question-template">
                                <div>
                                    <label class="form-label"></label>
                                    <select class="form-select">
                                        <option value="Não" selected>Não</option>
                                        <option value="Sim">Sim</option>
                                    </select>
                                </div>
                            </template>

                            <div id="health-questions-container" class="contents"></div>

                            <!-- Perguntas com "QUAL" -->
                            <div>
                                <label for="tipoSanguineo" class="form-label">Tipo Sanguíneo</label>
                                <input type="text" id="tipoSanguineo" class="form-input">
                            </div>
                            
                            <div class="md:col-span-2">
                                <label for="alergias" class="form-label">Alergias?</label>
                                <div class="flex gap-2">
                                    <select id="alergias" class="form-select w-1/3">
                                        <option value="Não" selected>Não</option>
                                        <option value="Sim">Sim</option>
                                    </select>
                                    <input type="text" id="alergiasQual" class="form-input w-2/3" placeholder="Qual?">
                                </div>
                            </div>
                            <div class="md:col-span-2">
                                <label for="cirurgiaRecente" class="form-label">Cirurgia recente?</label>
                                <div class="flex gap-2">
                                    <select id="cirurgiaRecente" class="form-select w-1/3">
                                        <option value="Não" selected>Não</option>
                                        <option value="Sim">Sim</option>
                                    </select>
                                    <input type="text" id="cirurgiaRecenteQual" class="form-input w-2/3" placeholder="Qual?">
                                </div>
                            </div>
                            <div class="md:col-span-2">
                                <label for="tratamentoMedico" class="form-label">Está em tratamento médico?</label>
                                <div class="flex gap-2">
                                    <select id="tratamentoMedico" class="form-select w-1/3">
                                        <option value="Não" selected>Não</option>
                                        <option value="Sim">Sim</option>
                                    </select>
                                    <input type="text" id="tratamentoMedicoQual" class="form-input w-2/3" placeholder="Qual?">
                                </div>
                            </div>
                            <div class="md:col-span-2">
                                <label for="tomaMedicamento" class="form-label">Toma algum medicamento?</label>
                                <div class="flex gap-2">
                                    <select id="tomaMedicamento" class="form-select w-1/3">
                                        <option value="Não" selected>Não</option>
                                        <option value="Sim">Sim</option>
                                    </select>
                                    <input type="text" id="tomaMedicamentoQual" class="form-input w-2/3" placeholder="Qual?">
                                </div>
                            </div>
                            <div class="md:col-span-2">
                                <label for="problemaOrtopedico" class="form-label">Problema Ortopédico?</label>
                                <div class="flex gap-2">
                                    <select id="problemaOrtopedico" class="form-select w-1/3">
                                        <option value="Não" selected>Não</option>
                                        <option value="Sim">Sim</option>
                                    </select>
                                    <input type="text" id="problemaOrtopedicoQual" class="form-input w-2/3" placeholder="Qual?">
                                </div>
                            </div>
                        </div>
                    </fieldset>

                    <!-- Botões de Ação -->
                    <div class="flex flex-col gap-4 md:flex-row md:justify-between">
                        <button type="button" id="back-to-login-btn" class="btn-zumba-secondary">
                            Voltar para o Login
                        </button>
                        <button type="submit" id="submit-register-btn" class="btn-zumba-alt">
                            <span id="submit-text">Enviar Inscrição</span>
                            <span id="submit-loading" class="hidden-section">Enviando...</span>
                        </button>
                    </div>
                    <p id="register-message" class="text-sm text-center"></p>

                </form>
            </div>
        </section>

        <!-- ===== PAINEL DO ADMIN ===== -->
        <section id="admin-panel" class="hidden-section space-y-8">
            <!-- Header do Admin -->
            <header class="flex flex-col items-center justify-between p-6 bg-white rounded-lg shadow-lg md:flex-row zumba-gradient">
                <h1 class="text-3xl font-black text-white">Painel de Administração</h1>
                <button id="admin-logout-btn" class="px-4 py-2 mt-4 font-semibold text-pink-600 bg-white rounded-lg shadow-md md:mt-0 hover:bg-gray-100">
                    Sair
                </button>
            </header>

            <div id="admin-stats" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>

            <!-- Seção: Inscrições Pendentes -->
            <div class="p-6 bg-white rounded-lg shadow-lg">
                <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between pb-4 border-b border-gray-200">
                    <h2 class="text-2xl font-bold">Inscrições Pendentes</h2>
                    <div class="flex gap-2 flex-col md:flex-row">
                        <input id="admin-search" type="text" class="form-input md:w-64" placeholder="Buscar por nome, email, CPF, cidade">
                        <select id="admin-sort" class="form-select md:w-48">
                            <option value="date_desc" selected>Ordenar: Data (recente)</option>
                            <option value="date_asc">Ordenar: Data (antiga)</option>
                            <option value="name_asc">Ordenar: Nome (A→Z)</option>
                            <option value="name_desc">Ordenar: Nome (Z→A)</option>
                        </select>
                    </div>
                </div>
                <div id="pending-registrations-list" class="mt-4 space-y-4">
                    <!-- Inscrições pendentes serão injetadas aqui -->
                    <p id="no-pending-message">Não há inscrições pendentes no momento.</p>
                </div>
            </div>

            <!-- Seção: Gestão de Todos os Participantes -->
            <div class="p-6 bg-white rounded-lg shadow-lg">
                <div class="pb-4 border-b border-gray-200">
                    <h2 class="text-2xl font-bold">Gestão Geral</h2>
                    <p class="text-sm text-gray-500">Visualize todos os cadastros com busca rápida.</p>
                </div>
                <div id="all-participants-list" class="mt-4 space-y-4 max-h-96 overflow-y-auto pr-2">
                    <!-- Todos os participantes (filtrados) serão injetados aqui -->
                    <p id="no-participants-message">Nenhum participante encontrado.</p>
                </div>
            </div>

            <!-- Seção: Gerador de Relatórios -->
            <div class="p-6 bg-white rounded-lg shadow-lg border-2 border-pink-100">
                <h2 class="pb-4 text-2xl font-bold border-b border-gray-200 text-pink-600 flex items-center gap-2">
                    <i data-lucide="file-bar-chart-2"></i> Gerador de Relatórios Avançado
                </h2>
                <div class="mt-4 space-y-6">
                    <p id="report-data-status" class="text-sm text-gray-600 italic text-right">Carregando dados...</p>

                    <!-- GRUPO 1: FILTROS DE CADASTRO -->
                    <div class="bg-pink-50 p-4 rounded-lg">
                        <h3 class="font-bold text-gray-700 mb-3 border-b border-pink-200 pb-1">1. Filtros de Cadastro (Status e Data)</h3>
                        <div class="grid grid-cols-1 gap-4 md:grid-cols-4">
                            <div>
                                <label class="form-label" for="report-status-filter">Status da Inscrição</label>
                                <select id="report-status-filter" class="form-select">
                                    <option value="approved" selected>Aprovados</option>
                                    <option value="pending">Pendentes</option>
                                    <option value="rejected">Rejeitados</option>
                                    <option value="all">Todos</option>
                                </select>
                            </div>
                            <div>
                                <label class="form-label" for="report-date-start">Data Cadastro (De)</label>
                                <input type="date" id="report-date-start" class="form-input">
                            </div>
                            <div>
                                <label class="form-label" for="report-date-end">Data Cadastro (Até)</label>
                                <input type="date" id="report-date-end" class="form-input">
                            </div>
                        </div>
                    </div>

                    <!-- GRUPO 2: FILTROS DE PERFIL E LOCALIZAÇÃO (NOVO!) -->
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h3 class="font-bold text-gray-700 mb-3 border-b border-blue-200 pb-1">2. Filtros de Perfil e Localização</h3>
                        <div class="grid grid-cols-1 gap-4 md:grid-cols-3 lg:grid-cols-6">
                            <!-- Filtro de Camisa -->
                            <div class="lg:col-span-1">
                                <label class="form-label text-blue-800" for="report-camisa-filter">Tam. Camisa</label>
                                <select id="report-camisa-filter" class="form-select border-blue-200">
                                    <option value="all" selected>Todos</option>
                                    <option value="PP">PP</option>
                                    <option value="P">P</option>
                                    <option value="M">M</option>
                                    <option value="G">G</option>
                                    <option value="GG">GG</option>
                                    <option value="Outro">Outro</option>
                                </select>
                            </div>
                             <!-- Filtro de Sexo -->
                             <div class="lg:col-span-1">
                                <label class="form-label text-blue-800" for="report-sexo-filter">Sexo</label>
                                <select id="report-sexo-filter" class="form-select border-blue-200">
                                    <option value="all" selected>Todos</option>
                                    <option value="Masculino">Masculino</option>
                                    <option value="Feminino">Feminino</option>
                                </select>
                            </div>
                            <!-- Filtro de Bairro -->
                            <div class="lg:col-span-2">
                                <label class="form-label text-blue-800" for="report-bairro-filter">Bairro</label>
                                <input type="text" id="report-bairro-filter" class="form-input border-blue-200" placeholder="Digite o bairro...">
                            </div>
                            <!-- Filtro de Cidade -->
                            <div class="lg:col-span-2">
                                <label class="form-label text-blue-800" for="report-city-filter">Cidade</label>
                                <input type="text" id="report-city-filter" class="form-input border-blue-200" placeholder="Digite a cidade...">
                            </div>
                            <!-- Filtro de Idade -->
                            <div class="lg:col-span-1">
                                <label class="form-label text-blue-800" for="report-age-min">Idade Mín.</label>
                                <input type="number" id="report-age-min" class="form-input border-blue-200" placeholder="0">
                            </div>
                            <div class="lg:col-span-1">
                                <label class="form-label text-blue-800" for="report-age-max">Idade Máx.</label>
                                <input type="number" id="report-age-max" class="form-input border-blue-200" placeholder="100">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Checkboxes dos Campos -->
                    <div>
                        <h3 class="font-bold text-gray-700 mb-2">3. Selecione as Colunas para Exibir:</h3>
                        <div id="report-fields" class="grid grid-cols-2 gap-2 md:grid-cols-4 lg:grid-cols-6 p-4 border rounded bg-gray-50">
                            <label class="flex items-center"><input type="checkbox" value="nome" checked class="mr-2 rounded text-pink-500 w-4 h-4"> Nome</label>
                            <label class="flex items-center"><input type="checkbox" value="camisa" checked class="mr-2 rounded text-pink-500 w-4 h-4 font-bold text-pink-700"> Tam. Camisa</label>
                            <label class="flex items-center"><input type="checkbox" value="telefone" checked class="mr-2 rounded text-pink-500 w-4 h-4"> Telefone</label>
                            <label class="flex items-center"><input type="checkbox" value="idade" checked class="mr-2 rounded text-pink-500 w-4 h-4"> Idade</label>
                            <label class="flex items-center"><input type="checkbox" value="bairro" class="mr-2 rounded text-pink-500 w-4 h-4"> Bairro</label>
                            <label class="flex items-center"><input type="checkbox" value="status" class="mr-2 rounded text-pink-500 w-4 h-4"> Status</label>
                            
                            <label class="flex items-center"><input type="checkbox" value="sexo" class="mr-2 rounded text-pink-500 w-4 h-4"> Sexo</label>
                            <label class="flex items-center"><input type="checkbox" value="tipoSanguineo" class="mr-2 rounded text-pink-500 w-4 h-4"> Tipo Sanguíneo</label>
                            <label class="flex items-center"><input type="checkbox" value="polo" class="mr-2 rounded text-pink-500 w-4 h-4"> Polo</label>
                            <label class="flex items-center"><input type="checkbox" value="cidade" class="mr-2 rounded text-pink-500 w-4 h-4"> Cidade</label>
                            <label class="flex items-center"><input type="checkbox" value="uf" class="mr-2 rounded text-pink-500 w-4 h-4"> UF</label>
                            <label class="flex items-center"><input type="checkbox" value="hipertenso" class="mr-2 rounded text-pink-500 w-4 h-4"> Hipertenso</label>
                            <label class="flex items-center"><input type="checkbox" value="diabetico" class="mr-2 rounded text-pink-500 w-4 h-4"> Diabético</label>
                            <label class="flex items-center"><input type="checkbox" value="cardiaco" class="mr-2 rounded text-pink-500 w-4 h-4"> Cardíaco</label>
                            <label class="flex items-center"><input type="checkbox" value="cpf" class="mr-2 rounded text-pink-500 w-4 h-4"> CPF</label>
                            <label class="flex items-center"><input type="checkbox" value="rg" class="mr-2 rounded text-pink-500 w-4 h-4"> RG</label>
                            <label class="flex items-center"><input type="checkbox" value="estadoCivil" class="mr-2 rounded text-pink-500 w-4 h-4"> Estado Civil</label>
                            <label class="flex items-center"><input type="checkbox" value="profissao" class="mr-2 rounded text-pink-500 w-4 h-4"> Profissão</label>
                            <label class="flex items-center"><input type="checkbox" value="empregado" class="mr-2 rounded text-pink-500 w-4 h-4"> Empregado</label>
                            <label class="flex items-center"><input type="checkbox" value="createdAt" class="mr-2 rounded text-pink-500 w-4 h-4"> Data de criação</label>
                        </div>
                    </div>

                    <div class="flex flex-col md:flex-row gap-4 items-center justify-between">
                        <button id="generate-report-btn" class="btn-zumba w-full md:w-auto flex items-center justify-center gap-2">
                            <i data-lucide="filter"></i> Filtrar e Gerar Relatório
                        </button>
                        <button id="clear-filters-btn" class="btn-zumba-secondary text-sm">Limpar Filtros</button>
                    </div>

                    <!-- Resultados do Relatório -->
                    <div id="report-results-container" class="hidden-section mt-6 border-t-2 border-gray-200 pt-6">
                        
                        <!-- PAINEL DE RESUMO RÁPIDO (DASHBOARD) -->
                        <div id="report-summary-panel" class="bg-gray-100 p-4 rounded-lg mb-4 border border-gray-300">
                            <h4 class="font-bold text-lg text-gray-800 flex items-center gap-2">
                                <i data-lucide="pie-chart"></i> Resumo Estatístico da Seleção
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-2 text-sm">
                                <div>
                                    <p class="font-semibold text-gray-600">Total Encontrado:</p>
                                    <p class="text-2xl font-black text-pink-600" id="summary-total">0</p>
                                </div>
                                <div>
                                    <p class="font-semibold text-gray-600">Distribuição de Camisas:</p>
                                    <ul id="summary-camisas" class="list-disc list-inside text-gray-700 font-medium">
                                        <!-- Injetado via JS -->
                                    </ul>
                                </div>
                                <div>
                                    <p class="font-semibold text-gray-600">Distribuição de Sexo:</p>
                                    <p id="summary-sexo" class="text-gray-700 font-medium"></p>
                                </div>
                            </div>
                        </div>

                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-xl font-semibold">Tabela Detalhada</h3>
                            <div class="text-sm text-gray-500" id="results-count"></div>
                        </div>

                        <div class="mt-2 overflow-x-auto shadow ring-1 ring-black ring-opacity-5 md:rounded-lg">
                            <table id="report-table" class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50" id="report-table-head">
                                    <!-- Cabeçalho da tabela gerado via JS -->
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200" id="report-table-body">
                                    <!-- Linhas da tabela geradas via JS -->
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-4 flex gap-2 flex-wrap justify-end">
                            <button id="export-csv-btn" class="btn-zumba-secondary flex items-center gap-1"><i data-lucide="file-text" class="w-4 h-4"></i> CSV</button>
                            <button id="export-xlsx-btn" class="btn-zumba-secondary flex items-center gap-1"><i data-lucide="sheet" class="w-4 h-4"></i> Excel</button>
                            <button id="export-pdf-btn" class="btn-zumba-secondary flex items-center gap-1"><i data-lucide="file" class="w-4 h-4"></i> PDF</button>
                        </div>
                    </div>
                </div>
            </div>
            
             <!-- Seção: Cadastros Rejeitados -->
            <div class="p-6 bg-white rounded-lg shadow-lg">
                <h2 class="pb-4 text-2xl font-bold border-b border-gray-200 text-red-600">Cadastros Rejeitados</h2>
                <div id="rejected-registrations-list" class="mt-4 space-y-4">
                    <!-- Cadastros rejeitados serão injetados aqui -->
                    <p id="no-rejected-message">Não há cadastros rejeitados.</p>
                </div>
            </div>

        </section>


        <!-- ===== MODAL DE DETALHES/EDIÇÃO ===== -->
        <div id="details-modal" aria-labelledby="modal-title" role="dialog" aria-modal="true">
            <div class="transform w-full max-w-4xl p-6 mx-4 bg-white rounded-2xl shadow-xl transition-all sm:mx-0">
                <div class="flex items-start justify-between">
                    <h2 class="text-2xl font-bold text-gray-900" id="modal-title">Detalhes da Inscrição</h2>
                    <button id="close-modal-btn" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>
                
                <div class="mt-4 max-h-[70vh] overflow-y-auto pr-2">
                    <form id="edit-form" class="space-y-6">
                        <input type="hidden" id="edit-doc-id">
                        
                        <div class="flex flex-col items-center gap-4 md:flex-row">
                            <div class="flex-1">
                                <h3 class="text-lg font-semibold text-center" id="edit-nome-display">Carregando...</h3>
                                <div class="mt-4">
                                     <label for="edit-status" class="form-label">Status da Inscrição</label>
                                     <select id="edit-status" class="form-select">
                                        <option value="pending">Pendente</option>
                                        <option value="approved">Aprovado</option>
                                        <option value="rejected">Rejeitado</option>
                                     </select>
                                </div>
                            </div>
                        </div>

                        <!-- Seção 1: Dados Iniciais -->
                        <fieldset class="p-4 border rounded-lg">
                            <legend class="px-2 text-lg font-bold text-gray-800">Identificação</legend>
                            <div class="grid grid-cols-1 gap-4 md:grid-cols-3">
                                <div><label for="edit-polo" class="form-label">Polo</label><input type="text" id="edit-polo" class="form-input"></div>
                                <div><label for="edit-inscricao" class="form-label">N° Inscrição</label><input type="text" id="edit-inscricao" class="form-input"></div>
                                <div><label for="edit-data" class="form-label">Data</label><input type="date" id="edit-data" class="form-input"></div>
                            </div>
                        </fieldset>

                        <!-- Seção 2: Dados Pessoais -->
                        <fieldset class="p-4 border rounded-lg">
                            <legend class="px-2 text-lg font-bold text-gray-800">Dados Pessoais</legend>
                            <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
                                <div><label for="edit-nome" class="form-label">Nome</label><input type="text" id="edit-nome" class="form-input"></div>
                                <div>
                                    <label class="form-label">Sexo</label>
                                    <div class="flex items-center mt-2 space-x-4">
                                        <label><input type="radio" name="edit-sexo" value="Masculino" class="text-pink-600"> Mas.</label>
                                        <label><input type="radio" name="edit-sexo" value="Feminino" class="text-pink-600"> Fem.</label>
                                    </div>
                                </div>
                                <div><label for="edit-dataNascimento" class="form-label">Data Nasc.</label><input type="date" id="edit-dataNascimento" class="form-input"></div>
                                <div><label for="edit-idade" class="form-label">Idade</label><input type="number" id="edit-idade" class="form-input"></div>
                            </div>
                            <div class="grid grid-cols-1 gap-4 mt-4 md:grid-cols-3">
                                <div><label for="edit-endereco" class="form-label">Endereço</label><input type="text" id="edit-endereco" class="form-input"></div>
                                <div><label for="edit-numero" class="form-label">N°</label><input type="text" id="edit-numero" class="form-input"></div>
                                <div><label for="edit-bairro" class="form-label">Bairro</label><input type="text" id="edit-bairro" class="form-input"></div>
                            </div>
                            <div class="grid grid-cols-1 gap-4 mt-4 md:grid-cols-4">
                                <div><label for="edit-cep" class="form-label">CEP</label><input type="text" id="edit-cep" class="form-input" placeholder="00000-000"></div>
                                <div><label for="edit-cidade" class="form-label">Cidade</label><input type="text" id="edit-cidade" class="form-input"></div>
                                <div><label for="edit-uf" class="form-label">UF</label><input type="text" id="edit-uf" class="form-input" maxlength="2" placeholder="EX"></div>
                                <div><label for="edit-telefone" class="form-label">Telefone</label><input type="tel" id="edit-telefone" class="form-input" placeholder="(00) 00000-0000"></div>
                            </div>
                            <div class="grid grid-cols-1 gap-4 mt-4 md:grid-cols-3">
                                <div><label for="edit-profissao" class="form-label">Profissão</label><input type="text" id="edit-profissao" class="form-input"></div>
                                <div><label class="form-label">Empregado?</label><select id="edit-empregado" class="form-select"><option value="Sim">Sim</option><option value="Não">Não</option></select></div>
                                <div><label for="edit-estadoCivil" class="form-label">Estado Civil</label><input type="text" id="edit-estadoCivil" class="form-input"></div>
                            </div>
                            <div class="grid grid-cols-1 gap-4 mt-4 md:grid-cols-4">
                                <div><label for="edit-rg" class="form-label">RG</label><input type="text" id="edit-rg" class="form-input"></div>
                                <div><label for="edit-cpf" class="form-label">CPF</label><input type="text" id="edit-cpf" class="form-input" placeholder="000.000.000-00"></div>
                                <div><label for="edit-titulo" class="form-label">Título</label><input type="text" id="edit-titulo" class="form-input"></div>
                                <div><label for="edit-secao" class="form-label">Seção</label><input type="text" id="edit-secao" class="form-input"></div>
                            </div>
                            <div class="grid grid-cols-1 gap-4 mt-4 md:grid-cols-2">
                                <div><label class="form-label">Casa Própria?</label><select id="edit-casaPropria" class="form-select"><option value="Sim">Sim</option><option value="Não">Não</option></select></div>
                                <div><label for="edit-zona" class="form-label">Zona</label><input type="text" id="edit-zona" class="form-input"></div>
                            </div>
                        </fieldset>

                        <!-- Seção 3: Medidas -->
                        <fieldset class="p-4 border rounded-lg">
                            <legend class="px-2 text-lg font-bold text-gray-800">Medidas</legend>
                            <label class="form-label">Medida da Camisa</label>
                            <div class="flex flex-wrap gap-4 mt-2">
                                <label><input type="radio" name="edit-camisa" value="PP" class="text-pink-600"> PP</label>
                                <label><input type="radio" name="edit-camisa" value="P" class="text-pink-600"> P</label>
                                <label><input type="radio" name="edit-camisa" value="M" class="text-pink-600"> M</label>
                                <label><input type="radio" name="edit-camisa" value="G" class="text-pink-600"> G</label>
                                <label><input type="radio" name="edit-camisa" value="GG" class="text-pink-600"> GG</label>
                                <div>
                                    <label><input type="radio" name="edit-camisa" value="Outro" class="text-pink-600"> Outro:</label>
                                    <input type="text" id="edit-camisaOutro" class="form-input inline-block w-auto ml-2">
                                </div>
                            </div>
                        </fieldset>

                        <!-- Seção 4: Histórico Patológico -->
                        <fieldset class="p-4 border rounded-lg">
                            <legend class="px-2 text-lg font-bold text-gray-800">Histórico Patológico</legend>
                            <div class="grid grid-cols-1 gap-y-4 gap-x-6 md:grid-cols-3">
                                <!-- Perguntas Sim/Não -->
                                <div><label class="form-label">Bebida Alcoólica?</label><select id="edit-bebidaAlcoolica" class="form-select"><option value="Não">Não</option><option value="Sim">Sim</option></select></div>
                                <div><label class="form-label">Fumante?</label><select id="edit-fumante" class="form-select"><option value="Não">Não</option><option value="Sim">Sim</option></select></div>
                                <div><label class="form-label">Doador de Sangue?</label><select id="edit-doadorSangue" class="form-select"><option value="Não">Não</option><option value="Sim">Sim</option></select></div>
                                <div><label class="form-label">Cardíaco?</label><select id="edit-cardiaco" class="form-select"><option value="Não">Não</option><option value="Sim">Sim</option></select></div>
                                <div><label class="form-label">Hipertenso?</label><select id="edit-hipertenso" class="form-select"><option value="Não">Não</option><option value="Sim">Sim</option></select></div>
                                <div><label class="form-label">Diabético?</label><select id="edit-diabetico" class="form-select"><option value="Não">Não</option><option value="Sim">Sim</option></select></div>
                                <div><label class="form-label">Epilético(a)?</label><select id="edit-epiletico" class="form-select"><option value="Não">Não</option><option value="Sim">Sim</option></select></div>
                                
                                <div><label for="edit-tipoSanguineo" class="form-label">Tipo Sanguíneo</label><input type="text" id="edit-tipoSanguineo" class="form-input"></div>
                                
                                <div class="md:col-span-2"><label for="edit-alergias" class="form-label">Alergias?</label><div class="flex gap-2"><select id="edit-alergias" class="form-select w-1/3"><option value="Não">Não</option><option value="Sim">Sim</option></select><input type="text" id="edit-alergiasQual" class="form-input w-2/3" placeholder="Qual?"></div></div>
                                <div class="md:col-span-2"><label for="edit-cirurgiaRecente" class="form-label">Cirurgia recente?</label><div class="flex gap-2"><select id="edit-cirurgiaRecente" class="form-select w-1/3"><option value="Não">Não</option><option value="Sim">Sim</option></select><input type="text" id="edit-cirurgiaRecenteQual" class="form-input w-2/3" placeholder="Qual?"></div></div>
                                <div class="md:col-span-2"><label for="edit-tratamentoMedico" class="form-label">Tratamento médico?</label><div class="flex gap-2"><select id="edit-tratamentoMedico" class="form-select w-1/3"><option value="Não">Não</option><option value="Sim">Sim</option></select><input type="text" id="edit-tratamentoMedicoQual" class="form-input w-2/3" placeholder="Qual?"></div></div>
                                <div class="md:col-span-2"><label for="edit-tomaMedicamento" class="form-label">Toma medicamento?</label><div class="flex gap-2"><select id="edit-tomaMedicamento" class="form-select w-1/3"><option value="Não">Não</option><option value="Sim">Sim</option></select><input type="text" id="edit-tomaMedicamentoQual" class="form-input w-2/3" placeholder="Qual?"></div></div>
                                <div class="md:col-span-2"><label for="edit-problemaOrtopedico" class="form-label">Problema Ortopédico?</label><div class="flex gap-2"><select id="edit-problemaOrtopedico" class="form-select w-1/3"><option value="Não">Não</option><option value="Sim">Sim</option></select><input type="text" id="edit-problemaOrtopedicoQual" class="form-input w-2/3" placeholder="Qual?"></div></div>
                            </div>
                        </fieldset>
                    </form>
                </div>
                
                <!-- Botões do Modal -->
                <div class="flex justify-end gap-4 pt-4 mt-6 border-t">
                    <button id="modal-delete-btn" class="px-4 py-2 font-semibold text-white bg-red-600 rounded-lg hover:bg-red-700">Deletar</button>
                    <button id="modal-save-btn" class="px-4 py-2 font-semibold text-white bg-green-600 rounded-lg hover:bg-green-700">Salvar Alterações</button>
                </div>
                <p id="modal-message" class="mt-2 text-sm text-center"></p>
            </div>
        </div>

    </div> <!-- Fim do Container Principal -->


    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged,
            setPersistence,
            browserLocalPersistence
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            doc, 
            getDoc, 
            updateDoc, 
            deleteDoc, 
            query, 
            onSnapshot,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ==================================================================
        // CONFIGURAÇÃO
        // ==================================================================
        
        const firebaseConfig = {
          apiKey: "AIzaSyCrH_LFHenyWx-ITRCTWeNVqf8O-0e3pJY",
          authDomain: "zumba-2a827.firebaseapp.com",
          projectId: "zumba-2a827",
          storageBucket: "zumba-2a827.firebasestorage.app",
          messagingSenderId: "325248310095",
          appId: "1:325248310095:web:2673845967b7bc60f6833a"
        };
        
        const ADMIN_UID = "mNenvFEpf1SnDCY2kXLUaDlgtP03"; 
        const INSCRICOES_COLLECTION = "inscricoes_zumba";
        
        // ==================================================================

        var app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            setLogLevel('debug');
            console.log("Firebase inicializado.");
        } catch (error) {
            console.error("Erro ao inicializar Firebase:", error);
            document.body.innerHTML = `<div class="p-8 text-center text-red-600 bg-red-100">Erro de Configuração do Firebase. Veja o console.</div>`;
        }


        // Referências DOM
        const loginView = document.getElementById('login-view');
        const registerView = document.getElementById('register-view');
        const adminPanel = document.getElementById('admin-panel');
        
        const adminLoginForm = document.getElementById('admin-login-form');
        const authError = document.getElementById('auth-error');
        const adminLogoutBtn = document.getElementById('admin-logout-btn');
        
        const goToRegisterBtn = document.getElementById('go-to-register-btn');
        const backToLoginBtn = document.getElementById('back-to-login-btn');
        
        const registerForm = document.getElementById('register-form');
        const registerMessage = document.getElementById('register-message');
        const submitRegisterBtn = document.getElementById('submit-register-btn');
        const dataNascimentoInput = document.getElementById('dataNascimento');
        const idadeInput = document.getElementById('idade');
        const inscricaoInput = document.getElementById('inscricao');
        
        const pendingList = document.getElementById('pending-registrations-list');
        const noPendingMsg = document.getElementById('no-pending-message');
        const rejectedList = document.getElementById('rejected-registrations-list');
        const noRejectedMsg = document.getElementById('no-rejected-message');
        const allParticipantsList = document.getElementById('all-participants-list');
        const noParticipantsMsg = document.getElementById('no-participants-message');

        const detailsModal = document.getElementById('details-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const modalSaveBtn = document.getElementById('modal-save-btn');
        const modalDeleteBtn = document.getElementById('modal-delete-btn');
        const modalMessage = document.getElementById('modal-message');
        
        // Relatórios
        const reportFields = document.getElementById('report-fields');
        const generateReportBtn = document.getElementById('generate-report-btn');
        const clearFiltersBtn = document.getElementById('clear-filters-btn');
        const reportResultsContainer = document.getElementById('report-results-container');
        const reportTableHead = document.getElementById('report-table-head');
        const reportTableBody = document.getElementById('report-table-body');
        const exportCsvBtn = document.getElementById('export-csv-btn');
        const exportXlsxBtn = document.getElementById('export-xlsx-btn');
        const exportPdfBtn = document.getElementById('export-pdf-btn');
        
        // Inputs de Filtro
        const statusFilter = document.getElementById('report-status-filter');
        const dateStartInput = document.getElementById('report-date-start');
        const dateEndInput = document.getElementById('report-date-end');
        const cityFilterInput = document.getElementById('report-city-filter');
        const bairroFilterInput = document.getElementById('report-bairro-filter');
        const camisaFilterInput = document.getElementById('report-camisa-filter');
        const sexoFilterInput = document.getElementById('report-sexo-filter');
        const ageMinInput = document.getElementById('report-age-min');
        const ageMaxInput = document.getElementById('report-age-max');
        
        const adminStats = document.getElementById('admin-stats');
        var lastReportData = { headers: [], rows: [] }; 

        // =================================================
        // Lógica de Navegação
        // =================================================

        const showView = (viewId) => {
            [loginView, registerView, adminPanel].forEach(view => {
                view.classList.add('hidden-section');
            });
            document.getElementById(viewId).classList.remove('hidden-section');
            
            if (viewId === 'register-view') {
                 generateInscricaoNumber();
                 setTodayDate();
                 setupCepAutoFill('cep', { endereco: 'endereco', bairro: 'bairro', cidade: 'cidade', uf: 'uf' });
                 var cpfEl = document.getElementById('cpf'); if (cpfEl) cpfEl.addEventListener('input', function(){ this.value = formatCpf(this.value); });
                 var telEl = document.getElementById('telefone'); if (telEl) telEl.addEventListener('input', function(){ this.value = formatPhone(this.value); });
                 var ufEl = document.getElementById('uf'); if (ufEl) ufEl.addEventListener('input', function(){ this.value = this.value.toUpperCase().replace(/[^A-Z]/g, '').slice(0,2); });
                 
                 // Inicializar ícones quando a view muda
                 if(window.lucide) lucide.createIcons();
            }
            if (viewId === 'admin-panel') {
                if(window.lucide) lucide.createIcons();
            }
        };

        function generateInscricaoNumber() {
            const date = new Date();
            const year = String(date.getFullYear()).slice(-2);
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const random = Math.floor(100 + Math.random() * 900); 
            inscricaoInput.value = `Z${year}${month}${day}-${random}`;
        }

        function setTodayDate() {
            const d = new Date();
            const yyyy = d.getFullYear();
            const mm = String(d.getMonth() + 1).padStart(2, '0');
            const dd = String(d.getDate()).padStart(2, '0');
            document.getElementById('data').value = `${yyyy}-${mm}-${dd}`;
        }

        function formatCep(v) { return v.replace(/\D/g, '').slice(0, 8).replace(/(\d{5})(\d)/, '$1-$2'); }
        function formatCpf(v) { return v.replace(/\D/g, '').slice(0, 11).replace(/(\d{3})(\d)/, '$1.$2').replace(/(\d{3})(\d)/, '$1.$2').replace(/(\d{3})(\d{1,2})$/, '$1-$2'); }
        function formatPhone(v) {
            var digits = v.replace(/\D/g, '').slice(0, 11);
            if (digits.length <= 10) { return digits.replace(/(\d{0,2})(\d{0,4})(\d{0,4})/, '($1) $2-$3'); } 
            else { return digits.replace(/(\d{0,2})(\d{0,5})(\d{0,4})/, '($1) $2-$3'); }
        }

        function setupCepAutoFill(cepInputId, map) {
            var cepInput = document.getElementById(cepInputId);
            if (!cepInput) return;
            function lookup() {
                var cep = cepInput.value.replace(/\D/g, '');
                if (cep.length !== 8) return;
                fetch(`https://viacep.com.br/ws/${cep}/json/`)
                    .then(function(r){ return r.json(); })
                    .then(function(data){
                        if (data && !data.erro) {
                            if (map.endereco) { var el = document.getElementById(map.endereco); if (el) el.value = data.logradouro || ''; }
                            if (map.bairro) { var el2 = document.getElementById(map.bairro); if (el2) el2.value = data.bairro || ''; }
                            if (map.cidade) { var el3 = document.getElementById(map.cidade); if (el3) el3.value = data.localidade || ''; }
                            if (map.uf) { var el4 = document.getElementById(map.uf); if (el4) el4.value = data.uf || ''; }
                        }
                    }).catch(function(){});
            }
            cepInput.addEventListener('blur', lookup);
            cepInput.addEventListener('input', function(){ this.value = formatCep(this.value); });
        }

        function calculateAgeFor(birthInputId, ageInputId) {
            const birthDateStr = document.getElementById(birthInputId).value;
            const ageEl = document.getElementById(ageInputId);
            if (!ageEl) return;
            if (birthDateStr) {
                const today = new Date();
                const birthDate = new Date(birthDateStr);
                var age = today.getFullYear() - birthDate.getFullYear();
                const m = today.getMonth() - birthDate.getMonth();
                if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) { age--; }
                ageEl.value = age;
            } else { ageEl.value = ''; }
        }

        function calculateAge() {
            const birthDateStr = dataNascimentoInput.value;
            if (birthDateStr) {
                const today = new Date();
                const birthDate = new Date(birthDateStr);
                var age = today.getFullYear() - birthDate.getFullYear();
                const m = today.getMonth() - birthDate.getMonth();
                if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) { age--; }
                idadeInput.value = age;
            } else { idadeInput.value = ''; }
        }
        
        dataNascimentoInput.addEventListener('change', calculateAge);
        const editBirthEl = document.getElementById('edit-dataNascimento');
        if (editBirthEl) editBirthEl.addEventListener('change', function(){ calculateAgeFor('edit-dataNascimento','edit-idade'); });

        goToRegisterBtn.addEventListener('click', () => showView('register-view'));
        backToLoginBtn.addEventListener('click', () => showView('login-view'));

        // =================================================
        // Autenticação
        // =================================================

        onAuthStateChanged(auth, (user) => {
            if (user) {
                if (user.uid === ADMIN_UID) {
                    showView('admin-panel');
                    loadAdminPanelData();
                } else {
                    signOut(auth);
                    showView('login-view');
                }
            } else {
                showView('login-view');
            }
        });
        setupCepAutoFill('edit-cep', { endereco: 'edit-endereco', bairro: 'edit-bairro', cidade: 'edit-cidade', uf: 'edit-uf' });
        var cpfEditEl = document.getElementById('edit-cpf'); if (cpfEditEl) cpfEditEl.addEventListener('input', function(){ this.value = formatCpf(this.value); });
        var telEditEl = document.getElementById('edit-telefone'); if (telEditEl) telEditEl.addEventListener('input', function(){ this.value = formatPhone(this.value); });
        var ufEditEl = document.getElementById('edit-uf'); if (ufEditEl) ufEditEl.addEventListener('input', function(){ this.value = this.value.toUpperCase().replace(/[^A-Z]/g, '').slice(0,2); });

        adminLoginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('admin-email').value;
            const password = document.getElementById('admin-password').value;
            authError.textContent = '';
            try {
                await setPersistence(auth, browserLocalPersistence);
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                authError.textContent = 'Email ou senha inválidos.';
            }
        });

        adminLogoutBtn.addEventListener('click', async () => {
            try { await signOut(auth); } catch (error) { console.error(error); }
        });

        // =================================================
        // Cadastro
        // =================================================

        const healthContainer = document.getElementById('health-questions-container');
        const healthTemplate = document.getElementById('health-question-template');
        const healthQs = [
            { id: 'bebidaAlcoolica', label: 'Faz uso de bebida alcoólica?' },
            { id: 'fumante', label: 'É fumante?' },
            { id: 'doadorSangue', label: 'Doador de sangue?' },
            { id: 'cardiaco', label: 'Cardíaco?' },
            { id: 'hipertenso', label: 'Hipertenso?' },
            { id: 'diabetico', label: 'Diabético?' },
            { id: 'epiletico', label: 'É epilético(a)?' }
        ];
        
        healthQs.forEach(q => {
            const clone = healthTemplate.content.cloneNode(true);
            clone.querySelector('label').textContent = q.label;
            clone.querySelector('select').id = q.id;
            healthContainer.appendChild(clone);
        });

        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            setRegisterLoading(true);
            registerMessage.textContent = '';
            
            try {
                var formData = getAllFormData('register-form'); 
                formData.photoURL = null; 
                formData.rgURL = null; 
                formData.status = 'pending';
                formData.createdAt = new Date().toISOString();
                // Conversão de números para filtro
                if(formData.idade) formData.idade = parseInt(formData.idade);

                await addDoc(collection(db, INSCRICOES_COLLECTION), formData);
                
                setRegisterLoading(false);
                registerMessage.textContent = 'Inscrição enviada com sucesso! O administrador irá analisar seu cadastro.';
                registerMessage.className = 'text-sm text-center text-green-600';
                registerForm.reset();
                showView('login-view'); 

            } catch (error) {
                console.error("Erro ao enviar inscrição:", error);
                setRegisterLoading(false);
                if (error.code && error.code.includes('permission-denied')) {
                     registerMessage.textContent = `Erro de Permissão (Firestore).`;
                } else {
                    registerMessage.textContent = `Erro ao enviar inscrição: ${error.message}`;
                }
                registerMessage.className = 'text-sm text-center text-red-500';
            }
        });
        
        function setRegisterLoading(isLoading) {
            const submitText = document.getElementById('submit-text');
            const submitLoading = document.getElementById('submit-loading');
            if (isLoading) {
                submitRegisterBtn.disabled = true;
                submitText.classList.add('hidden-section');
                submitLoading.classList.remove('hidden-section');
            } else {
                submitRegisterBtn.disabled = false;
                submitText.classList.remove('hidden-section');
                submitLoading.classList.add('hidden-section');
            }
        }
        
        function getAllFormData(formId) {
            const form = document.getElementById(formId);
            var data = {}; 
            form.querySelectorAll('input, select').forEach(input => {
                if (input.type === 'radio' || input.type === 'checkbox' || input.type === 'file') return;
                if (input.id) {
                    const key = input.id.startsWith('edit-') ? input.id.substring(5) : input.id;
                    if (key) data[key] = input.value;
                }
            });
            form.querySelectorAll('input[type="radio"]:checked').forEach(radio => {
                const key = radio.name.startsWith('edit-') ? radio.name.substring(5) : radio.name;
                if (key === 'camisa' && radio.value === 'Outro') {
                     const outroId = formId === 'edit-form' ? 'edit-camisaOutro' : 'camisaOutro';
                     data[key] = document.getElementById(outroId).value || 'Outro';
                } else { data[key] = radio.value; }
            });
            ['alergias', 'cirurgiaRecente', 'tratamentoMedico', 'tomaMedicamento', 'problemaOrtopedico'].forEach(key => {
                const prefix = formId === 'edit-form' ? 'edit-' : '';
                const selectValue = data[key];
                if (selectValue === 'Sim') {
                    const qualValue = document.getElementById(`${prefix}${key}Qual`).value;
                    data[key] = `Sim (${qualValue || 'N/A'})`;
                }
            });
            ['alergiasQual', 'cirurgiaRecenteQual', 'tratamentoMedicoQual', 'tomaMedicamentoQual', 'problemaOrtopedicoQual', 'camisaOutro'].forEach(key => {
                 delete data[key]; delete data[`edit-${key}`];
            });
            return data;
        }

        // =================================================
        // Painel Admin
        // =================================================
        
        var allRegistrations = []; 
        var allRegistrationsUnsubscribe = null; 
        const adminSearchInput = document.getElementById('admin-search');
        const adminSortSelect = document.getElementById('admin-sort');

        function loadAdminPanelData() {
            if (allRegistrationsUnsubscribe) allRegistrationsUnsubscribe();
            const registrationsCol = collection(db, INSCRICOES_COLLECTION);
            
            allRegistrationsUnsubscribe = onSnapshot(registrationsCol, (snapshot) => {
                allRegistrations = []; 
                snapshot.forEach(doc => {
                    const data = doc.data();
                    // Normalização de idade se vier como string
                    if(data.idade && typeof data.idade === 'string') data.idade = parseInt(data.idade);
                    allRegistrations.push({ id: doc.id, ...data });
                });
                document.getElementById('report-data-status').textContent = `${allRegistrations.length} registros carregados.`;
                renderAdminLists();
            }, (error) => {
                document.getElementById('report-data-status').textContent = 'Erro ao carregar dados.';
                pendingList.innerHTML = `<p class="text-red-500 font-bold">Erro de permissão.</p>`;
            });
        }

        function toDate(val) {
            try {
                if (!val) return null;
                if (typeof val === 'string' || typeof val === 'number') {
                    const d = new Date(val);
                    return isNaN(d.getTime()) ? null : d;
                }
                if (typeof val === 'object' && val.seconds) {
                    return new Date(val.seconds * 1000 + Math.floor(val.nanoseconds / 1e6));
                }
                return null;
            } catch(e) { return null; }
        }

        function renderAdminLists() {
            const q = (adminSearchInput?.value || '').toLowerCase().trim();
            const sort = adminSortSelect?.value || 'date_desc';

            var pending = []; 
            var rejected = []; 
            var all_participants = []; 

            const matchesQuery = (d) => {
                if (!q) return true;
                const pool = [d.nome, d.email, d.cpf, d.cidade].map(v => (v || '').toLowerCase());
                return pool.some(v => v.includes(q));
            };

            const sorted = allRegistrations.slice().sort((a,b) => {
                if (sort === 'name_asc') return (a.nome||'').localeCompare(b.nome||'');
                if (sort === 'name_desc') return (b.nome||'').localeCompare(a.nome||'');
                const ad = toDate(a.createdAt)?.getTime() || 0;
                const bd = toDate(b.createdAt)?.getTime() || 0;
                return sort === 'date_asc' ? ad - bd : bd - ad;
            });

            sorted.forEach(({id, ...data}) => {
                if (!matchesQuery(data)) return;

                var statusClass = 'text-yellow-600 bg-yellow-100'; 
                var statusText = 'Pendente'; 
                if (data.status === 'approved') { statusClass = 'text-green-600 bg-green-100'; statusText = 'Aprovado'; } 
                else if (data.status === 'rejected') { statusClass = 'text-red-600 bg-red-100'; statusText = 'Rejeitado'; }

                const cardHtmlSimple = `
                    <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg shadow-sm border hover:shadow-md transition-shadow">
                        <div>
                            <p class="font-bold text-lg">${data.nome || 'Nome não informado'}</p>
                            <p class="text-sm text-gray-600">${data.cidade || ''} - ${data.bairro || ''}</p>
                            <p class="text-xs text-gray-500">Enviado em: ${(()=>{const d=toDate(data.createdAt);return d? d.toLocaleDateString('pt-BR'): 'N/A';})()}</p>
                        </div>
                        <div class="flex flex-col md:flex-row gap-2">
                            <button data-id="${id}" class="view-btn btn-zumba-secondary text-sm !px-3 !py-1">Ver</button>
                            ${data.status === 'pending' ? `<button data-id="${id}" class="approve-btn btn-zumba-alt text-sm !px-3 !py-1">Aprovar</button>` : ''}
                            ${data.status !== 'rejected' ? `<button data-id="${id}" class="reject-btn btn-zumba text-sm !px-3 !py-1">Rejeitar</button>` : ''}
                        </div>
                    </div>
                `;
                
                const cardHtmlGestao = `
                    <div class="flex items-center justify-between p-3 bg-white rounded border border-gray-100 hover:bg-gray-50">
                        <div class="flex items-center gap-3">
                            <div class="w-2 h-10 rounded ${data.status==='approved'?'bg-green-400':(data.status==='rejected'?'bg-red-400':'bg-yellow-400')}"></div>
                            <div>
                                <p class="font-semibold text-gray-800">${data.nome || 'Sem Nome'}</p>
                                <p class="text-xs text-gray-500">${data.cpf || 'CPF N/A'} • ${data.camisa || '?'} • ${data.sexo || '?'}</p>
                            </div>
                        </div>
                        <button data-id="${id}" class="view-btn text-pink-600 hover:text-pink-800 font-medium text-sm">Editar</button>
                    </div>
                `;

                if (data.status === 'pending') pending.push(cardHtmlSimple);
                else if (data.status === 'rejected') rejected.push(cardHtmlSimple);
                all_participants.push(cardHtmlGestao); 
            });

            if (pending.length) { pendingList.innerHTML = pending.join(''); noPendingMsg.classList.add('hidden-section'); } 
            else { pendingList.innerHTML = ''; noPendingMsg.classList.remove('hidden-section'); }

            if (rejected.length) { rejectedList.innerHTML = rejected.join(''); noRejectedMsg.classList.add('hidden-section'); } 
            else { rejectedList.innerHTML = ''; noRejectedMsg.classList.remove('hidden-section'); }
            
            if (all_participants.length) { allParticipantsList.innerHTML = all_participants.join(''); noParticipantsMsg.classList.add('hidden-section'); } 
            else { allParticipantsList.innerHTML = ''; noParticipantsMsg.classList.remove('hidden-section'); }

            if (adminStats) {
                const total = allRegistrations.length;
                const approved = allRegistrations.filter(x=>x.status==='approved').length;
                const pendingCount = allRegistrations.filter(x=>x.status!=='approved' && x.status!=='rejected').length;
                const rejectedCount = allRegistrations.filter(x=>x.status==='rejected').length;
                adminStats.innerHTML = `
                    <div class="p-4 bg-white rounded-lg shadow flex items-center justify-between border-l-4 border-blue-500">
                        <div><p class="text-sm text-gray-500">Total</p><p class="text-2xl font-bold">${total}</p></div>
                    </div>
                    <div class="p-4 bg-white rounded-lg shadow flex items-center justify-between border-l-4 border-green-500">
                        <div><p class="text-sm text-gray-500">Aprovados</p><p class="text-2xl font-bold text-green-600">${approved}</p></div>
                    </div>
                    <div class="p-4 bg-white rounded-lg shadow flex items-center justify-between border-l-4 border-yellow-500">
                        <div><p class="text-sm text-gray-500">Pendentes</p><p class="text-2xl font-bold text-yellow-600">${pendingCount}</p></div>
                    </div>
                    <div class="p-4 bg-white rounded-lg shadow flex items-center justify-between border-l-4 border-red-500">
                        <div><p class="text-sm text-gray-500">Rejeitados</p><p class="text-2xl font-bold text-red-600">${rejectedCount}</p></div>
                    </div>
                `;
            }
        }

        adminSearchInput?.addEventListener('input', renderAdminLists);
        adminSortSelect?.addEventListener('change', renderAdminLists);
        
        document.addEventListener('click', async (e) => {
            const target = e.target;
            const docId = target.dataset.id;
            if (!docId) return;

            const showMessage = (msg, isError = false) => {
                if (detailsModal.style.display === 'flex') {
                    modalMessage.textContent = msg;
                    modalMessage.className = `mt-2 text-sm text-center ${isError ? 'text-red-500' : 'text-green-600'}`;
                    setTimeout(() => modalMessage.textContent = '', 3000);
                } else { console.log(msg); }
            };

            if (target.classList.contains('approve-btn')) {
                if (window.confirm('Aprovar inscrição?')) {
                    try { await updateDoc(doc(db, INSCRICOES_COLLECTION, docId), { status: "approved" }); } catch (error) { showMessage("Erro ao aprovar.", true); }
                }
            }

            if (target.classList.contains('reject-btn')) {
                 if (window.confirm('Rejeitar inscrição?')) {
                    try { await updateDoc(doc(db, INSCRICOES_COLLECTION, docId), { status: "rejected" }); } catch (error) { showMessage("Erro ao rejeitar.", true); }
                }
            }
            
            if (target.classList.contains('view-btn')) { openDetailsModal(docId); }
        });

        // =================================================
        // Edição
        // =================================================
        
        var currentEditingDocId = null; 

        async function openDetailsModal(docId) {
            currentEditingDocId = docId;
            modalMessage.textContent = '';
            
            try {
                const docSnap = await getDoc(doc(db, INSCRICOES_COLLECTION, docId));
                if (!docSnap.exists()) return;
                const data = docSnap.data();
                
                document.getElementById('edit-doc-id').value = docId;
                document.getElementById('edit-nome-display').textContent = data.nome || "Sem nome";
                document.getElementById('edit-status').value = data.status || 'pending';

                Object.keys(data).forEach(key => {
                    const el = document.getElementById(`edit-${key}`);
                    if (el && el.type !== 'radio') el.value = data[key];
                });
                
                document.querySelectorAll(`input[name="edit-sexo"]`).forEach(radio => { radio.checked = (radio.value === data.sexo); });
                const camisaRadio = document.querySelector(`input[name="edit-camisa"][value="${data.camisa}"]`);
                if (camisaRadio) {
                    camisaRadio.checked = true; document.getElementById('edit-camisaOutro').value = '';
                } else if (data.camisa) {
                    const outroRadio = document.querySelector(`input[name="edit-camisa"][value="Outro"]`);
                    if(outroRadio) outroRadio.checked = true; document.getElementById('edit-camisaOutro').value = data.camisa;
                }
                
                 ['alergias', 'cirurgiaRecente', 'tratamentoMedico', 'tomaMedicamento', 'problemaOrtopedico'].forEach(key => {
                      const elSelect = document.getElementById(`edit-${key}`);
                     const elQual = document.getElementById(`edit-${key}Qual`);
                     const value = data[key] || "Não";
                     if (value.startsWith('Sim')) {
                         elSelect.value = 'Sim';
                         const qualMatch = value.match(/\(([^)]+)\)/);
                         if (qualMatch && qualMatch[1] !== 'N/A') elQual.value = qualMatch[1]; else elQual.value = '';
                     } else { elSelect.value = 'Não'; elQual.value = ''; }
                 });

                calculateAgeFor('edit-dataNascimento','edit-idade');
                detailsModal.style.display = 'flex';
                setTimeout(() => detailsModal.style.opacity = 1, 10); 

            } catch (error) { window.alert("Erro ao carregar dados."); }
        }

        closeModalBtn.addEventListener('click', () => {
            detailsModal.style.opacity = 0;
            setTimeout(() => detailsModal.style.display = 'none', 300);
            currentEditingDocId = null;
        });
        
        modalSaveBtn.addEventListener('click', async () => {
            if (!currentEditingDocId) return;
            modalMessage.textContent = 'Salvando...';
            try {
                var formData = getAllFormData('edit-form'); 
                formData.status = document.getElementById('edit-status').value;
                delete formData['doc-id']; 
                if(formData.idade) formData.idade = parseInt(formData.idade);
                
                await updateDoc(doc(db, INSCRICOES_COLLECTION, currentEditingDocId), formData);
                
                modalMessage.textContent = 'Salvo com sucesso!';
                modalMessage.className = 'mt-2 text-sm text-center text-green-600';
                setTimeout(() => closeModalBtn.click(), 1000);
            } catch (error) { modalMessage.textContent = 'Erro ao salvar.'; modalMessage.className = 'mt-2 text-sm text-center text-red-500'; }
        });
        
        modalDeleteBtn.addEventListener('click', async () => {
            if (!currentEditingDocId) return;
            if (!window.confirm('Deletar cadastro permanentemente?')) return;
            modalMessage.textContent = 'Deletando...';
            try {
                await deleteDoc(doc(db, INSCRICOES_COLLECTION, currentEditingDocId));
                setTimeout(() => closeModalBtn.click(), 500);
            } catch (error) { modalMessage.textContent = 'Erro ao deletar.'; }
        });


        // =================================================
        // Gerador de Relatórios INTELIGENTE
        // =================================================
        
        // Botão de Limpar Filtros
        clearFiltersBtn.addEventListener('click', () => {
            statusFilter.value = 'approved';
            dateStartInput.value = '';
            dateEndInput.value = '';
            cityFilterInput.value = '';
            bairroFilterInput.value = '';
            camisaFilterInput.value = 'all';
            sexoFilterInput.value = 'all';
            ageMinInput.value = '';
            ageMaxInput.value = '';
            
            // Opcional: Desmarcar checkboxes ou resetar para padrão
            reportFields.querySelectorAll('input').forEach(cb => cb.checked = true);
            
            // Ocultar resultados
            reportResultsContainer.classList.add('hidden-section');
        });

        generateReportBtn.addEventListener('click', () => {
            var selectedFields = []; 
            reportFields.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => selectedFields.push(cb.value));

            if (selectedFields.length === 0) { window.alert("Selecione pelo menos um campo para exibir."); return; }

            // 1. Coleta Filtros
            const status = statusFilter.value;
            const startDateStr = dateStartInput.value;
            const endDateStr = dateEndInput.value;
            const cityFilter = (cityFilterInput.value || '').trim().toLowerCase();
            const bairroFilter = (bairroFilterInput.value || '').trim().toLowerCase();
            const camisaFilter = camisaFilterInput.value;
            const sexoFilter = sexoFilterInput.value;
            const ageMin = ageMinInput.value ? parseInt(ageMinInput.value) : null;
            const ageMax = ageMaxInput.value ? parseInt(ageMaxInput.value) : null;

            // 2. Aplica Filtros
            var filteredUsers = allRegistrations.slice(); 
            
            // Filtro Status
            if (status !== 'all') filteredUsers = filteredUsers.filter(u => (u.status || 'pending') === status);
            
            // Filtro Datas
            if (startDateStr) {
                const start = new Date(startDateStr);
                filteredUsers = filteredUsers.filter(u => { const d = toDate(u.createdAt); return d ? d >= start : false; });
            }
            if (endDateStr) {
                const end = new Date(endDateStr); end.setHours(23,59,59,999);
                filteredUsers = filteredUsers.filter(u => { const d = toDate(u.createdAt); return d ? d <= end : false; });
            }
            
            // Filtros de Texto (Cidade, Bairro)
            if (cityFilter) filteredUsers = filteredUsers.filter(u => (u.cidade || '').toLowerCase().includes(cityFilter));
            if (bairroFilter) filteredUsers = filteredUsers.filter(u => (u.bairro || '').toLowerCase().includes(bairroFilter));
            
            // Filtros Exatos (Camisa, Sexo)
            if (camisaFilter !== 'all') {
                filteredUsers = filteredUsers.filter(u => (u.camisa === camisaFilter) || (camisaFilter === 'Outro' && u.camisa && !['PP','P','M','G','GG'].includes(u.camisa)));
            }
            if (sexoFilter !== 'all') {
                filteredUsers = filteredUsers.filter(u => u.sexo === sexoFilter);
            }
            
            // Filtro Numérico (Idade)
            if (ageMin !== null) filteredUsers = filteredUsers.filter(u => (u.idade !== undefined && u.idade >= ageMin));
            if (ageMax !== null) filteredUsers = filteredUsers.filter(u => (u.idade !== undefined && u.idade <= ageMax));


            // 3. Geração de Estatísticas (Dashboard Rápido)
            updateReportSummary(filteredUsers);
            
            // 4. Renderização da Tabela
            document.getElementById('results-count').textContent = `Encontrados: ${filteredUsers.length} registros`;
            
            if (filteredUsers.length === 0) {
                reportResultsContainer.classList.remove('hidden-section');
                reportTableHead.innerHTML = '';
                reportTableBody.innerHTML = '<tr><td class="p-4 text-center text-gray-500" colspan="100%">Nenhum registro encontrado para os filtros selecionados.</td></tr>';
                return;
            }

            // Cabeçalho
            var headHtml = '<tr>'; 
            selectedFields.forEach(field => {
                const label = reportFields.querySelector(`input[value="${field}"]`).parentElement.textContent;
                headHtml += `<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${label.trim()}</th>`;
            });
            headHtml += '</tr>';
            reportTableHead.innerHTML = headHtml;

            // Corpo
            var bodyHtml = ''; 
            var rows = []; 
            filteredUsers.forEach(user => {
                bodyHtml += '<tr class="hover:bg-gray-50">';
                var row = []; 
                selectedFields.forEach(field => {
                    let value = user[field] || '-';
                    if (field === 'createdAt') value = toDate(user.createdAt)?.toLocaleString('pt-BR') || '-';
                    if (field === 'status') {
                        value = value === 'approved' ? 'Aprovado' : (value === 'rejected' ? 'Rejeitado' : 'Pendente');
                    }
                    bodyHtml += `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${value}</td>`;
                    row.push(value);
                });
                bodyHtml += '</tr>';
                rows.push(row);
            });
            reportTableBody.innerHTML = bodyHtml;

            reportResultsContainer.classList.remove('hidden-section');

            var headers = []; 
            reportTableHead.querySelectorAll('th').forEach(th => headers.push(th.textContent));
            lastReportData = { headers, rows: rows };
        });
        
        function updateReportSummary(users) {
            // Totais
            document.getElementById('summary-total').textContent = users.length;
            
            // Contagem de Camisas
            const camisasCount = {};
            users.forEach(u => {
                const c = u.camisa || 'Não Inf.';
                camisasCount[c] = (camisasCount[c] || 0) + 1;
            });
            
            // Ordenar camisas logicamente
            const order = ['PP', 'P', 'M', 'G', 'GG', 'Outro', 'Não Inf.'];
            let camisasHtml = '';
            order.forEach(size => {
                if (camisasCount[size]) {
                    camisasHtml += `<li><b>${size}:</b> ${camisasCount[size]}</li>`;
                }
            });
            // Adicionar os que não estão na ordem padrão
            Object.keys(camisasCount).forEach(k => {
                if (!order.includes(k) && !['Outro', 'Não Inf.'].includes(k)) {
                     camisasHtml += `<li><b>${k}:</b> ${camisasCount[k]}</li>`;
                }
            });
            document.getElementById('summary-camisas').innerHTML = camisasHtml || '<li>Nenhuma camisa registrada</li>';
            
            // Contagem de Sexo
            const masc = users.filter(u => u.sexo === 'Masculino').length;
            const fem = users.filter(u => u.sexo === 'Feminino').length;
            document.getElementById('summary-sexo').textContent = `Masc: ${masc} | Fem: ${fem}`;
        }
        
        // Exportações
        exportCsvBtn.addEventListener('click', () => {
            if (!lastReportData.headers.length) return;
            var csv = []; 
            csv.push(lastReportData.headers.map(h => `"${h}"`).join(','));
            lastReportData.rows.forEach(row => { csv.push(row.map(v => `"${String(v).replace(/"/g, '""')}"`).join(',')); });
            const link = document.createElement("a");
            link.setAttribute("href", encodeURI("data:text/csv;charset=utf-8," + csv.join("\n")));
            link.setAttribute("download", "relatorio_zumba.csv");
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
        });

        exportXlsxBtn.addEventListener('click', () => {
            if (!lastReportData.headers.length) return;
            const ws = XLSX.utils.aoa_to_sheet([lastReportData.headers, ...lastReportData.rows]);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Relatorio');
            XLSX.writeFile(wb, 'relatorio_zumba.xlsx');
        });

        exportPdfBtn.addEventListener('click', () => {
            if (!lastReportData.headers.length) return;
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'landscape' });
            doc.text('Relatório Projeto Zumba', 14, 15);
            doc.setFontSize(10); doc.text(`Gerado em ${new Date().toLocaleString('pt-BR')}`, 14, 22);
            doc.autoTable({
                head: [ lastReportData.headers ],
                body: lastReportData.rows,
                startY: 28,
                styles: { fontSize: 8 },
                headStyles: { fillColor: [236, 72, 153] },
            });
            doc.save('relatorio_zumba.pdf');
        });
        
        if (window.lucide) lucide.createIcons();

    </script>
</body>
</html>
